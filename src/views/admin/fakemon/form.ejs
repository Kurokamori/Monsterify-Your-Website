<% /* Set the title and other variables for the layout */ %>
<% title = title || 'Fakemon Form' %>

<style>
    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .admin-title {
        font-size: 2rem;
        font-weight: bold;
    }

    .admin-actions {
        display: flex;
        gap: 1rem;
    }

    .btn-back {
        background-color: #7f8c8d;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-back:hover {
        background-color: #95a5a6;
    }

    .form-container {
        background: rgba(0, 0, 0, 0.2);
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        color: #ffffff;
    }

    .form-control:focus {
        outline: none;
        border-color: #3498db;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }

    .form-hint {
        font-size: 0.875rem;
        color: #7f8c8d;
        margin-top: 0.25rem;
    }

    .btn-submit {
        background-color: #2ecc71;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    .btn-submit:hover {
        background-color: #27ae60;
    }

    .preview-image {
        max-width: 200px;
        max-height: 200px;
        margin-top: 1rem;
        border-radius: 4px;
        object-fit: contain;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }

    .evolution-container {
        margin-top: 1rem;
    }

    .evolution-entry {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
        align-items: center;
    }

    .evolution-entry input {
        flex: 1;
    }

    .btn-add-evolution {
        background-color: #3498db;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
    }

    .btn-remove-evolution {
        background-color: #e74c3c;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
    }

    .generator-container {
        background: rgba(0, 0, 0, 0.1);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .btn-generate {
        background-color: #9b59b6;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        margin-top: 1rem;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-generate:hover {
        background-color: #8e44ad;
    }
</style>

<div class="container">
    <div class="admin-header">
        <h1 class="admin-title"><%= isNew ? 'Add New Fakemon' : `Edit Fakemon #${fakemon.number}` %></h1>
        <div class="admin-actions">
            <a href="/admin/fakemon" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <div class="form-container">
        <form action="/admin/fakemon/save" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="isNew" value="<%= isNew %>">

            <div class="form-row">
                <div class="form-group">
                    <label for="number" class="form-label">Number</label>
                    <input type="text" id="number" name="number" class="form-control" value="<%= fakemon.number %>" <%= isNew ? '' : 'readonly' %> required>
                    <div class="form-hint">Format: 001, 002, etc.</div>
                </div>

                <div class="form-group">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" id="name" name="name" class="form-control" value="<%= fakemon.name %>" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="species_class" class="form-label">Classification</label>
                    <input type="text" id="species_class" name="species_class" class="form-control" value="<%= fakemon.species_class %>">
                    <div class="form-hint">Example: The Fire Pokemon</div>
                </div>

                <div class="form-group">
                    <label for="attribute" class="form-label">Attribute</label>
                    <select id="attribute" name="attribute" class="form-control">
                        <option value="Data" <%= fakemon.attribute === 'Data' ? 'selected' : '' %>>Data</option>
                        <option value="Vaccine" <%= fakemon.attribute === 'Vaccine' ? 'selected' : '' %>>Vaccine</option>
                        <option value="Virus" <%= fakemon.attribute === 'Virus' ? 'selected' : '' %>>Virus</option>
                        <option value="Free" <%= fakemon.attribute === 'Free' ? 'selected' : '' %>>Free</option>
                        <option value="Variable" <%= fakemon.attribute === 'Variable' ? 'selected' : '' %>>Variable</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="types" class="form-label">Types</label>
                    <select id="types" name="types" class="form-control" multiple>
                        <option value="Normal" <%= fakemon.types.includes('Normal') ? 'selected' : '' %>>Normal</option>
                        <option value="Fire" <%= fakemon.types.includes('Fire') ? 'selected' : '' %>>Fire</option>
                        <option value="Water" <%= fakemon.types.includes('Water') ? 'selected' : '' %>>Water</option>
                        <option value="Grass" <%= fakemon.types.includes('Grass') ? 'selected' : '' %>>Grass</option>
                        <option value="Electric" <%= fakemon.types.includes('Electric') ? 'selected' : '' %>>Electric</option>
                        <option value="Ice" <%= fakemon.types.includes('Ice') ? 'selected' : '' %>>Ice</option>
                        <option value="Fighting" <%= fakemon.types.includes('Fighting') ? 'selected' : '' %>>Fighting</option>
                        <option value="Poison" <%= fakemon.types.includes('Poison') ? 'selected' : '' %>>Poison</option>
                        <option value="Ground" <%= fakemon.types.includes('Ground') ? 'selected' : '' %>>Ground</option>
                        <option value="Flying" <%= fakemon.types.includes('Flying') ? 'selected' : '' %>>Flying</option>
                        <option value="Psychic" <%= fakemon.types.includes('Psychic') ? 'selected' : '' %>>Psychic</option>
                        <option value="Bug" <%= fakemon.types.includes('Bug') ? 'selected' : '' %>>Bug</option>
                        <option value="Rock" <%= fakemon.types.includes('Rock') ? 'selected' : '' %>>Rock</option>
                        <option value="Ghost" <%= fakemon.types.includes('Ghost') ? 'selected' : '' %>>Ghost</option>
                        <option value="Dragon" <%= fakemon.types.includes('Dragon') ? 'selected' : '' %>>Dragon</option>
                        <option value="Dark" <%= fakemon.types.includes('Dark') ? 'selected' : '' %>>Dark</option>
                        <option value="Steel" <%= fakemon.types.includes('Steel') ? 'selected' : '' %>>Steel</option>
                        <option value="Fairy" <%= fakemon.types.includes('Fairy') ? 'selected' : '' %>>Fairy</option>
                    </select>
                    <div class="form-hint">Hold Ctrl/Cmd to select multiple types</div>
                </div>

                <div class="form-group">
                    <label for="abilities" class="form-label">Abilities</label>
                    <input type="text" id="abilities" name="abilities" class="form-control" value="<%= fakemon.abilities.join(', ') %>">
                    <div class="form-hint">Comma-separated list of abilities</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Random Generator</label>
                <div class="generator-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="size-category" class="form-label">Size Category</label>
                            <select id="size-category" class="form-control">
                                <option value="mini">Mini</option>
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                                <option value="extra-large">Extra Large</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="power-category" class="form-label">Power Category</label>
                            <select id="power-category" class="form-control">
                                <option value="fodder">Fodder</option>
                                <option value="weak">Weak</option>
                                <option value="below-average">Below Average</option>
                                <option value="average" selected>Average</option>
                                <option value="above-average">Above Average</option>
                                <option value="pseudo-legendary">Pseudo-Legendary</option>
                                <option value="mythical">Mythical</option>
                                <option value="legendary">Legendary</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" id="generate-random" class="btn-generate"><i class="fas fa-dice"></i> Generate Random Values</button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="height" class="form-label">Height</label>
                    <input type="text" id="height" name="height" class="form-control" value="<%= fakemon.height %>">
                    <div class="form-hint">Example: 1.0 m</div>
                </div>

                <div class="form-group">
                    <label for="weight" class="form-label">Weight</label>
                    <input type="text" id="weight" name="weight" class="form-control" value="<%= fakemon.weight %>">
                    <div class="form-hint">Example: 20.0 kg</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Stats</label>
                <div class="stats-container">
                    <div class="form-group">
                        <label for="hp" class="form-label">HP</label>
                        <input type="number" id="hp" name="hp" class="form-control" value="<%= fakemon.stats.hp || 45 %>" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label for="atk" class="form-label">Attack</label>
                        <input type="number" id="atk" name="atk" class="form-control" value="<%= fakemon.stats.atk || 49 %>" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label for="def" class="form-label">Defense</label>
                        <input type="number" id="def" name="def" class="form-control" value="<%= fakemon.stats.def || 49 %>" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label for="spatk" class="form-label">Sp. Attack</label>
                        <input type="number" id="spatk" name="spatk" class="form-control" value="<%= fakemon.stats.spatk || 65 %>" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label for="spdef" class="form-label">Sp. Defense</label>
                        <input type="number" id="spdef" name="spdef" class="form-control" value="<%= fakemon.stats.spdef || 65 %>" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label for="spe" class="form-label">Speed</label>
                        <input type="number" id="spe" name="spe" class="form-control" value="<%= fakemon.stats.spe || 45 %>" min="1" max="255">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="pokedex_entry" class="form-label">Pokedex Entry</label>
                <textarea id="pokedex_entry" name="pokedex_entry" class="form-control" rows="4"><%= fakemon.pokedex_entry %></textarea>
            </div>

            <div class="form-group">
                <label for="evolution_line" class="form-label">Evolution Line</label>
                <div id="evolution-container" class="evolution-container">
                    <% if (fakemon.evolution_line && fakemon.evolution_line.length > 0) { %>
                        <% fakemon.evolution_line.forEach(function(evo, index) { %>
                            <div class="evolution-entry">
                                <input type="text" class="form-control" placeholder="Number (e.g. 001)" value="<%= evo.number %>">
                                <input type="text" class="form-control" placeholder="Requirement (e.g. Base)" value="<%= evo.requirement %>">
                                <button type="button" class="btn-remove-evolution" onclick="removeEvolution(this)"><i class="fas fa-trash"></i></button>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="evolution-entry">
                            <input type="text" class="form-control" placeholder="Number (e.g. 001)" value="<%= fakemon.number %>">
                            <input type="text" class="form-control" placeholder="Requirement (e.g. Base)" value="Base">
                            <button type="button" class="btn-remove-evolution" onclick="removeEvolution(this)"><i class="fas fa-trash"></i></button>
                        </div>
                    <% } %>
                </div>
                <button type="button" class="btn-add-evolution" onclick="addEvolution()"><i class="fas fa-plus"></i> Add Evolution</button>
                <input type="hidden" id="evolution_line" name="evolution_line" value="">
            </div>

            <div class="form-group">
                <label for="artist_caption" class="form-label">Artist Caption</label>
                <input type="text" id="artist_caption" name="artist_caption" class="form-control" value="<%= fakemon.artist_caption %>">
                <div class="form-hint">Example: Art by Artist Name</div>
            </div>

            <div class="form-group">
                <label for="image" class="form-label">Image</label>
                <input type="file" id="image" name="image" class="form-control" accept="image/*">
                <div class="form-hint">PNG format recommended. Will be saved as <%= fakemon.number %>.png</div>
                <% if (!isNew) { %>
                    <img src="<%= fakemon.image_path %>" alt="<%= fakemon.name %>" class="preview-image" onerror="this.src='/images/default_mon.png'">
                <% } %>
            </div>

            <div class="form-group">
                <button type="submit" class="btn-submit"><i class="fas fa-save"></i> <%= isNew ? 'Create Fakemon' : 'Update Fakemon' %></button>
            </div>
        </form>
    </div>
</div>

<script>
    function addEvolution() {
        const container = document.getElementById('evolution-container');
        const entry = document.createElement('div');
        entry.className = 'evolution-entry';
        entry.innerHTML = `
            <input type="text" class="form-control" placeholder="Number (e.g. 001)">
            <input type="text" class="form-control" placeholder="Requirement (e.g. Level 16)">
            <button type="button" class="btn-remove-evolution" onclick="removeEvolution(this)"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(entry);
    }

    function removeEvolution(button) {
        const entry = button.parentNode;
        if (document.querySelectorAll('.evolution-entry').length > 1) {
            entry.parentNode.removeChild(entry);
        }
    }

    // Random value generation functions
    function getRandomInRange(min, max) {
        return Math.random() * (max - min) + min;
    }

    function getRandomIntInRange(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Size category ranges for height (in meters) and weight (in kg)
    const sizeRanges = {
        'mini': { height: [0.1, 0.5], weight: [0.1, 10] },
        'small': { height: [0.5, 1.0], weight: [10, 30] },
        'medium': { height: [1.0, 1.8], weight: [30, 80] },
        'large': { height: [1.8, 3.0], weight: [80, 200] },
        'extra-large': { height: [3.0, 10.0], weight: [200, 1000] }
    };

    // Power category ranges for base stats
    const powerRanges = {
        'fodder': { min: 10, max: 30, total: 180 },
        'weak': { min: 20, max: 50, total: 250 },
        'below-average': { min: 30, max: 70, total: 320 },
        'average': { min: 40, max: 80, total: 400 },
        'above-average': { min: 50, max: 90, total: 480 },
        'pseudo-legendary': { min: 60, max: 100, total: 550 },
        'mythical': { min: 70, max: 110, total: 600 },
        'legendary': { min: 80, max: 120, total: 680 }
    };

    // Generate random height and weight based on size category
    function generatePhysicalAttributes(sizeCategory) {
        const range = sizeRanges[sizeCategory];
        const height = getRandomInRange(range.height[0], range.height[1]).toFixed(1) + ' m';
        const weight = getRandomInRange(range.weight[0], range.weight[1]).toFixed(1) + ' kg';

        return { height, weight };
    }

    // Generate random stats based on power category
    function generateStats(powerCategory) {
        const range = powerRanges[powerCategory];

        // Generate initial random stats within the range
        let stats = {
            hp: getRandomIntInRange(range.min, range.max),
            atk: getRandomIntInRange(range.min, range.max),
            def: getRandomIntInRange(range.min, range.max),
            spatk: getRandomIntInRange(range.min, range.max),
            spdef: getRandomIntInRange(range.min, range.max),
            spe: getRandomIntInRange(range.min, range.max)
        };

        // Calculate total and adjust if needed
        let total = Object.values(stats).reduce((sum, stat) => sum + stat, 0);
        const targetTotal = range.total;

        // Adjust stats to match the target total
        if (total !== targetTotal) {
            const factor = targetTotal / total;
            for (let stat in stats) {
                stats[stat] = Math.round(stats[stat] * factor);
                // Ensure stats stay within the min-max range
                stats[stat] = Math.max(range.min, Math.min(range.max, stats[stat]));
            }

            // Fine-tune to exactly match the target total
            total = Object.values(stats).reduce((sum, stat) => sum + stat, 0);
            let diff = targetTotal - total;

            // Distribute the difference among stats
            while (diff !== 0) {
                const statKeys = Object.keys(stats);
                const randomStat = statKeys[Math.floor(Math.random() * statKeys.length)];

                if (diff > 0 && stats[randomStat] < range.max) {
                    stats[randomStat]++;
                    diff--;
                } else if (diff < 0 && stats[randomStat] > range.min) {
                    stats[randomStat]--;
                    diff++;
                }
            }
        }

        return stats;
    }

    // Apply generated values to the form
    function applyGeneratedValues(height, weight, stats) {
        document.getElementById('height').value = height;
        document.getElementById('weight').value = weight;

        document.getElementById('hp').value = stats.hp;
        document.getElementById('atk').value = stats.atk;
        document.getElementById('def').value = stats.def;
        document.getElementById('spatk').value = stats.spatk;
        document.getElementById('spdef').value = stats.spdef;
        document.getElementById('spe').value = stats.spe;
    }

    // Event listener for the generate button
    document.getElementById('generate-random').addEventListener('click', function() {
        const sizeCategory = document.getElementById('size-category').value;
        const powerCategory = document.getElementById('power-category').value;

        const { height, weight } = generatePhysicalAttributes(sizeCategory);
        const stats = generateStats(powerCategory);

        applyGeneratedValues(height, weight, stats);
    });

    // Prepare evolution data before form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        const evolutionEntries = document.querySelectorAll('.evolution-entry');
        const evolutionData = [];

        evolutionEntries.forEach(function(entry) {
            const inputs = entry.querySelectorAll('input');
            const number = inputs[0].value.trim();
            const requirement = inputs[1].value.trim();

            if (number && requirement) {
                evolutionData.push({
                    number: number,
                    name: 'Unknown', // Will be resolved on the server
                    requirement: requirement
                });
            }
        });

        document.getElementById('evolution_line').value = JSON.stringify(evolutionData);
    });
</script>
