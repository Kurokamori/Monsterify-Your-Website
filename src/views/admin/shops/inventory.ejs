<% /* Set the title and other variables for the layout */ %>
<% title = 'Shop Inventory Management' %>

<style>
.alert {
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.alert-success {
    background-color: rgba(52, 211, 153, 0.2);
    border: 1px solid rgba(52, 211, 153, 0.5);
    color: #10b981;
}

.alert-error {
    background-color: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.5);
    color: #ef4444;
}

.tab-container {
    margin-top: 2rem;
}

.tab-buttons {
    display: flex;
    border-bottom: 1px solid var(--divider-color);
    margin-bottom: 1.5rem;
    overflow-x: auto;
}

.tab-button {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
}

.tab-button:hover {
    color: var(--accent-color);
}

.tab-button.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.shop-card {
    background-color: var(--card-background);
    border-radius: 0.5rem;
    overflow: hidden;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.shop-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
}

.shop-card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--divider-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.shop-card-body {
    padding: 1.5rem;
}

.shop-card-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--divider-color);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

.shop-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.shop-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    background-color: var(--nav-background);
    margin-right: 0.5rem;
}

.shop-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
}

.shop-stat {
    background-color: var(--nav-background);
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.item-table {
    width: 100%;
    border-collapse: collapse;
}

.item-table th,
.item-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--divider-color);
}

.item-table th {
    background-color: var(--nav-background);
    font-weight: 500;
}

.item-table tr:hover {
    background-color: var(--nav-hover);
}

.item-image {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 0.25rem;
}

.rarity-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
}

.rarity-1 {
    background-color: rgba(107, 114, 128, 0.2);
    color: #9ca3af;
}

.rarity-2 {
    background-color: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
}

.rarity-3 {
    background-color: rgba(16, 185, 129, 0.2);
    color: #34d399;
}

.rarity-4 {
    background-color: rgba(139, 92, 246, 0.2);
    color: #a78bfa;
}

.rarity-5 {
    background-color: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
}

.search-container {
    margin-bottom: 2rem;
}

.search-input {
    width: 100%;
    padding: 0.75rem;
    background-color: var(--input-background);
    border: 1px solid var(--divider-color);
    border-radius: 0.375rem;
    color: var(--text-color);
}

.date-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
}

.date-input {
    padding: 0.75rem;
    background-color: var(--input-background);
    border: 1px solid var(--divider-color);
    border-radius: 0.375rem;
    color: var(--text-color);
}
</style>

<div class="mt-20 mb-8">
    <h1 class="text-4xl font-display font-bold text-center mb-8">Shop Inventory Management</h1>
    <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert alert-<%= messageType || 'success' %> text-center mb-8">
        <%= message %>
    </div>
    <% } %>
</div>

<main class="container mx-auto px-4 pb-16">
    <div class="card mb-8">
        <div class="card-header">
            <h2 class="text-xl font-bold">Shop Inventories</h2>
        </div>
        <div class="card-body">
            <div class="date-selector">
                <label for="inventoryDate" class="font-medium">Select Date:</label>
                <input type="date" id="inventoryDate" class="date-input" value="<%= currentDate %>">
                <button id="loadInventory" class="btn-primary">Load Inventory</button>
            </div>

            <div class="tab-container">
                <div class="tab-buttons">
                    <% shops.forEach((shop, index) => { %>
                    <button type="button" class="tab-button <%= index === 0 ? 'active' : '' %>" data-tab="shop-<%= shop.shop_id %>">
                        <%= shop.name %>
                    </button>
                    <% }); %>
                </div>

                <% shops.forEach((shop, index) => { %>
                <div id="shop-<%= shop.shop_id %>" class="tab-content <%= index === 0 ? 'active' : '' %>">
                    <div class="shop-card">
                        <img src="<%= shop.image_url || 'https://i.imgur.com/DP1nFn2.png' %>" alt="<%= shop.name %>" class="shop-image">
                        <div class="shop-card-header">
                            <h3 class="text-lg font-bold"><%= shop.name %></h3>
                            <span class="shop-badge"><%= shop.category %></span>
                        </div>
                        <div class="shop-card-body">
                            <p class="text-sm mb-4"><%= shop.description %></p>
                            
                            <div class="shop-stats mb-4">
                                <div class="shop-stat">
                                    <i class="fas fa-box mr-1"></i> Items: <%= shop.min_items %>-<%= shop.max_items %>
                                </div>
                                <div class="shop-stat">
                                    <i class="fas fa-dollar-sign mr-1"></i> Price: <%= shop.price_multiplier_min %>x-<%= shop.price_multiplier_max %>x
                                </div>
                                <div class="shop-stat">
                                    <i class="fas fa-clock mr-1"></i> Restock: <%= shop.restock_hour %>:00
                                </div>
                            </div>

                            <div class="search-container">
                                <input type="text" class="search-input item-search" data-shop="<%= shop.shop_id %>" placeholder="Search items...">
                            </div>

                            <div class="inventory-container" id="inventory-<%= shop.shop_id %>">
                                <% if (shopItems[shop.shop_id] && shopItems[shop.shop_id].length > 0) { %>
                                <table class="item-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Name</th>
                                            <th>Rarity</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% shopItems[shop.shop_id].forEach(item => { %>
                                        <tr class="item-row" data-item-name="<%= item.item_name.toLowerCase() %>">
                                            <td>
                                                <img src="<%= item.item_image %>" alt="<%= item.item_name %>" class="item-image">
                                            </td>
                                            <td><%= item.item_name %></td>
                                            <td>
                                                <span class="rarity-badge rarity-<%= item.item_rarity %>">
                                                    <%= item.item_rarity %>
                                                </span>
                                            </td>
                                            <td><%= item.price %> coins</td>
                                            <td><%= item.max_quantity %></td>
                                            <td>
                                                <form action="/admin/shops/inventory/remove-item" method="POST" class="inline">
                                                    <input type="hidden" name="shop_id" value="<%= shop.shop_id %>">
                                                    <input type="hidden" name="item_id" value="<%= item.item_id %>">
                                                    <input type="hidden" name="date" value="<%= currentDate %>">
                                                    <button type="submit" class="btn-secondary text-red-500">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                                <% } else { %>
                                <div class="text-center py-8">
                                    <div class="text-4xl text-gray-600 mb-4"><i class="fas fa-store-slash"></i></div>
                                    <h3 class="text-xl font-bold mb-2">No items in inventory</h3>
                                    <p class="text-gray-400 mb-4">This shop has no items for the selected date.</p>
                                </div>
                                <% } %>
                            </div>
                        </div>
                        <div class="shop-card-footer">
                            <a href="/town/shop/<%= shop.shop_id %>" class="btn-secondary" target="_blank">
                                <i class="fas fa-eye mr-1"></i> View Shop
                            </a>
                            <form action="/admin/shops/inventory/restock" method="POST" class="inline">
                                <input type="hidden" name="shop_id" value="<%= shop.shop_id %>">
                                <input type="hidden" name="date" value="<%= currentDate %>">
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-sync-alt mr-1"></i> Restock
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-bold">Quick Actions</h2>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <form action="/admin/shops/inventory/restock-all" method="POST" class="inline">
                    <input type="hidden" name="date" value="<%= currentDate %>">
                    <button type="submit" class="btn-primary block text-center py-3 w-full">
                        <i class="fas fa-sync-alt mr-2"></i> Restock All Shops
                    </button>
                </form>
                <a href="/admin/shops" class="btn-secondary block text-center py-3">
                    <i class="fas fa-store mr-2"></i> Shop Dashboard
                </a>
                <a href="/admin/dashboard" class="btn-secondary block text-center py-3">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to current button and content
            button.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Item search functionality
    const searchInputs = document.querySelectorAll('.item-search');
    
    searchInputs.forEach(input => {
        input.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const shopId = this.getAttribute('data-shop');
            const itemRows = document.querySelectorAll(`#inventory-${shopId} .item-row`);
            
            itemRows.forEach(row => {
                const itemName = row.getAttribute('data-item-name');
                
                if (itemName.includes(searchTerm)) {
                    row.style.display = 'table-row';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });

    // Date selector functionality
    const dateInput = document.getElementById('inventoryDate');
    const loadButton = document.getElementById('loadInventory');
    
    loadButton.addEventListener('click', function() {
        const selectedDate = dateInput.value;
        if (selectedDate) {
            window.location.href = `/admin/shops/inventory?date=${selectedDate}`;
        }
    });
});
</script>
