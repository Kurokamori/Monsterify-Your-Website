<%- include('../../partials/admin-header') %>

<div class="container-wide mx-auto px-4 py-8" style="width: 90%; max-width: 1800px;">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold">Location Management</h1>
      <p class="text-gray-300">Manage regions, areas, and locations for the location guide system.</p>
    </div>
    <div>
      <a href="/admin/locations/region/new" class="btn btn-primary">
        <i class="fas fa-plus mr-2"></i> Add New Region
      </a>
    </div>
  </div>

  <div class="bg-card-background rounded-lg p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Regions</h2>

    <% if (locationData.regions.length === 0) { %>
      <p class="text-gray-400">No regions have been created yet. Click "Add New Region" to get started.</p>
    <% } else { %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <% locationData.regions.forEach(region => { %>
          <div class="location-card admin-card">
            <div class="relative" style="height: 160px;">
              <img src="<%= region.image %>" alt="<%= region.name %>" class="w-full h-full object-cover rounded-t-lg">
              <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent rounded-t-lg"></div>
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <h3 class="text-xl font-bold text-white text-shadow-lg"><%= region.name %></h3>
              </div>
              <div class="absolute top-2 right-2 flex space-x-2">
                <a href="/admin/locations/region/<%= region.slug %>/edit" class="btn-icon btn-edit" title="Edit Region">
                  <i class="fas fa-edit"></i>
                </a>
                <button class="btn-icon btn-delete" title="Delete Region"
                  onclick="confirmDelete('region', '<%= region.slug %>', null, null)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="p-4">
              <p class="text-sm text-gray-300 mb-3"><%= region.description %></p>
              <div class="flex justify-between items-center">
                <span class="text-xs text-gray-400">Slug: <%= region.slug %></span>
                <a href="/admin/locations/region/<%= region.slug %>" class="btn btn-sm btn-secondary">
                  Manage Areas <i class="fas fa-arrow-right ml-1"></i>
                </a>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Confirm Deletion</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <p id="deleteMessage">Are you sure you want to delete this item?</p>
      <p class="text-red-500 mt-2">This action cannot be undone!</p>
    </div>
    <div class="modal-footer">
      <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
      <button id="confirmDelete" class="btn btn-danger">Delete</button>
    </div>
  </div>
</div>

<style>
  .admin-card {
    position: relative;
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .admin-card:hover {
    transform: translateY(-4px);
  }

  .btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    color: white;
    transition: all 0.2s ease;
  }

  .btn-edit {
    background-color: rgba(59, 130, 246, 0.8);
  }

  .btn-edit:hover {
    background-color: rgba(59, 130, 246, 1);
  }

  .btn-delete {
    background-color: rgba(239, 68, 68, 0.8);
  }

  .btn-delete:hover {
    background-color: rgba(239, 68, 68, 1);
  }

  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
  }

  .modal-content {
    background-color: var(--card-background, #2a2a2a);
    margin: 15% auto;
    padding: 0;
    border-radius: 8px;
    width: 400px;
    max-width: 90%;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .modal-body {
    padding: 1rem;
  }

  .modal-footer {
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }

  .close {
    color: #aaa;
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: white;
  }

  .btn-danger {
    background-color: #ef4444;
    color: white;
  }

  .btn-danger:hover {
    background-color: #dc2626;
  }
</style>

<script>
  // Variables to store deletion info
  let deleteType = '';
  let deleteSlug = '';
  let deleteRegion = '';
  let deleteArea = '';

  // Get modal elements
  const modal = document.getElementById('deleteModal');
  const closeBtn = document.querySelector('.close');
  const cancelBtn = document.getElementById('cancelDelete');
  const confirmBtn = document.getElementById('confirmDelete');
  const deleteMessage = document.getElementById('deleteMessage');

  // Function to open the delete confirmation modal
  function confirmDelete(type, slug, region, area) {
    deleteType = type;
    deleteSlug = slug;
    deleteRegion = region;
    deleteArea = area;

    // Set appropriate message
    if (type === 'region') {
      deleteMessage.textContent = `Are you sure you want to delete the region "${slug}"? This will also delete all areas and locations within this region.`;
    } else if (type === 'area') {
      deleteMessage.textContent = `Are you sure you want to delete the area "${slug}"? This will also delete all locations within this area.`;
    } else {
      deleteMessage.textContent = `Are you sure you want to delete the location "${slug}"?`;
    }

    // Show the modal
    modal.style.display = 'block';
  }

  // Close modal when clicking the X
  closeBtn.onclick = function() {
    modal.style.display = 'none';
  }

  // Close modal when clicking Cancel
  cancelBtn.onclick = function() {
    modal.style.display = 'none';
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  }

  // Handle delete confirmation
  confirmBtn.onclick = function() {
    let url = '';

    if (deleteType === 'region') {
      url = `/admin/locations/region/${deleteSlug}/delete`;
    } else if (deleteType === 'area') {
      url = `/admin/locations/area/${deleteRegion}/${deleteSlug}/delete`;
    } else {
      url = `/admin/locations/location/${deleteArea}/${deleteSlug}/delete`;
    }

    // Send delete request
    fetch(url, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Reload the page to reflect changes
        window.location.reload();
      } else {
        alert('Error: ' + (data.message || 'Failed to delete item'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while deleting the item');
    })
    .finally(() => {
      modal.style.display = 'none';
    });
  }
</script>

<%- include('../../partials/admin-footer') %>
