<%- include('./battle-styles') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex items-center mb-8">
    <a href="/admin/battles" class="text-blue-400 hover:text-blue-300 mr-4">
      <i class="fas fa-arrow-left"></i> Back to Battle Management
    </a>
    <h1 class="text-3xl font-bold text-yellow-400">Battle Statistics</h1>
  </div>

  <% if (typeof message !== 'undefined' && message) { %>
    <div class="bg-<%= messageType === 'error' ? 'red' : 'green' %>-800 text-white p-4 rounded-lg mb-6">
      <%= message %>
      <% if (messageType === 'error' && message.includes('migration')) { %>
        <div class="mt-4">
          <a href="/admin/battles/run-migration" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded">
            Run Battle System Migration
          </a>
        </div>
      <% } %>
    </div>
  <% } %>

  <!-- Statistics Overview -->
  <div class="bg-gray-800 rounded-lg p-6 shadow-lg mb-8">
    <h2 class="text-2xl font-bold text-yellow-400 mb-4">Overview</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-gray-700 p-4 rounded-lg text-center">
        <p class="text-gray-400 text-sm">Total Battles</p>
        <p class="text-white text-2xl font-bold"><%= stats.total_battles || 0 %></p>
      </div>
      <div class="bg-gray-700 p-4 rounded-lg text-center">
        <p class="text-gray-400 text-sm">Wins</p>
        <p class="text-green-400 text-2xl font-bold"><%= stats.wins || 0 %></p>
      </div>
      <div class="bg-gray-700 p-4 rounded-lg text-center">
        <p class="text-gray-400 text-sm">Losses</p>
        <p class="text-red-400 text-2xl font-bold"><%= stats.losses || 0 %></p>
      </div>
      <div class="bg-gray-700 p-4 rounded-lg text-center">
        <p class="text-gray-400 text-sm">Abandoned</p>
        <p class="text-yellow-400 text-2xl font-bold"><%= stats.abandoned || 0 %></p>
      </div>
      <div class="bg-gray-700 p-4 rounded-lg text-center">
        <p class="text-gray-400 text-sm">Win Rate</p>
        <p class="text-blue-400 text-2xl font-bold">
          <%= stats.total_battles > 0 ? Math.round((stats.wins / stats.total_battles) * 100) : 0 %>%
        </p>
      </div>
      <div class="bg-gray-700 p-4 rounded-lg text-center">
        <p class="text-gray-400 text-sm">Average WPM</p>
        <p class="text-white text-2xl font-bold"><%= Math.round(stats.avg_wpm || 0) %></p>
      </div>
      <div class="bg-gray-700 p-4 rounded-lg text-center">
        <p class="text-gray-400 text-sm">Average Accuracy</p>
        <p class="text-white text-2xl font-bold"><%= Math.round(stats.avg_accuracy || 0) %>%</p>
      </div>
    </div>
  </div>

  <!-- Recent Battles -->
  <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
    <h2 class="text-2xl font-bold text-yellow-400 mb-4">Recent Battles</h2>

    <% if (recentBattles && recentBattles.length > 0) { %>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-gray-700 rounded-lg">
          <thead>
            <tr>
              <th class="px-4 py-2 text-left text-gray-300">ID</th>
              <th class="px-4 py-2 text-left text-gray-300">Date</th>
              <th class="px-4 py-2 text-left text-gray-300">Trainer</th>
              <th class="px-4 py-2 text-left text-gray-300">Opponent</th>
              <th class="px-4 py-2 text-left text-gray-300">Result</th>
              <th class="px-4 py-2 text-left text-gray-300">WPM</th>
              <th class="px-4 py-2 text-left text-gray-300">Accuracy</th>
              <th class="px-4 py-2 text-left text-gray-300">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% recentBattles.forEach(battle => { %>
              <tr class="border-t border-gray-600">
                <td class="px-4 py-2 text-gray-300"><%= battle.battle_id %></td>
                <td class="px-4 py-2 text-gray-300">
                  <%= new Date(battle.started_at).toLocaleDateString() %>
                  <div class="text-xs text-gray-500">
                    <%= new Date(battle.started_at).toLocaleTimeString() %>
                  </div>
                </td>
                <td class="px-4 py-2 text-white"><%= battle.trainer_name %></td>
                <td class="px-4 py-2 text-white"><%= battle.opponent_name %></td>
                <td class="px-4 py-2">
                  <% if (battle.status === 'won') { %>
                    <span class="text-green-400">Victory</span>
                  <% } else if (battle.status === 'lost') { %>
                    <span class="text-red-400">Defeat</span>
                  <% } else if (battle.status === 'abandoned') { %>
                    <span class="text-gray-400">Abandoned</span>
                  <% } else { %>
                    <span class="text-yellow-400">In Progress</span>
                  <% } %>
                </td>
                <td class="px-4 py-2 text-gray-300"><%= battle.wpm || '-' %></td>
                <td class="px-4 py-2 text-gray-300"><%= battle.accuracy ? battle.accuracy + '%' : '-' %></td>
                <td class="px-4 py-2">
                  <div class="flex space-x-2">
                    <% if (battle.status === 'in_progress') { %>
                      <a href="/battles/arena/<%= battle.battle_id %>" class="text-blue-400 hover:text-blue-300" title="Continue Battle">
                        <i class="fas fa-play"></i>
                      </a>
                    <% } else { %>
                      <a href="/battles/results/<%= battle.battle_id %>" class="text-blue-400 hover:text-blue-300" title="View Results">
                        <i class="fas fa-eye"></i>
                      </a>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="text-center py-8">
        <p class="text-gray-400">No battles found.</p>
      </div>
    <% } %>
  </div>
</div>