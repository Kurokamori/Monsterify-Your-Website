<div class="container mx-auto px-4 py-8">
  <div class="flex items-center mb-8">
    <a href="/battles" class="text-blue-400 hover:text-blue-300 mr-4">
      <i class="fas fa-arrow-left"></i> Back to Battle Arena
    </a>
    <h1 class="text-3xl font-bold text-yellow-400"><%= trainer.name %>'s Battles</h1>
  </div>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="bg-red-800 text-white p-4 rounded-lg mb-6">
      <%= error %>
    </div>
  <% } %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Trainer Monsters -->
    <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
      <h2 class="text-2xl font-bold text-yellow-400 mb-4">Your Monsters</h2>
      <p class="text-gray-300 mb-4">You can select up to 6 monsters for battle when you start a battle.</p>

      <% if (battleBoxMonsters && battleBoxMonsters.length > 0) { %>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <% battleBoxMonsters.forEach(monster => { %>
            <div class="monster-card bg-gray-700 hover:bg-gray-600 rounded-lg p-3 transition-all duration-200 transform hover:scale-105 hover:shadow-lg">
              <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 rounded-lg overflow-hidden mb-2 border-2 border-blue-500">
                  <img src="<%= monster.img_link || '/images/default_mon.png' %>" alt="<%= monster.name %>" class="w-full h-full object-contain">
                </div>
                <h3 class="text-white font-semibold text-center"><%= monster.name %></h3>
                <p class="text-gray-400 text-sm">Lv. <%= monster.level || 1 %></p>
                <div class="flex flex-wrap justify-center mt-1">
                  <% if (monster.type1) { %>
                    <span class="text-xs px-2 py-1 rounded bg-gray-600 text-white m-1"><%= monster.type1 %></span>
                  <% } %>
                  <% if (monster.type2) { %>
                    <span class="text-xs px-2 py-1 rounded bg-gray-600 text-white m-1"><%= monster.type2 %></span>
                  <% } %>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="text-center py-8">
          <p class="text-gray-400 mb-4">No monsters in battle box.</p>
          <a href="/trainers/<%= trainer.id %>/boxes" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Manage Battle Box
          </a>
        </div>
      <% } %>
    </div>

    <!-- Opponent Selection -->
    <div class="bg-gray-800 rounded-lg p-6 shadow-lg lg:col-span-2">
      <h2 class="text-2xl font-bold text-yellow-400 mb-4">Select an Opponent</h2>

      <% if (opponents && opponents.length > 0) { %>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          <% opponents.forEach(opponent => { %>
            <div class="opponent-card bg-gray-700 hover:bg-gray-600 rounded-lg p-4 transition-all duration-200 transform hover:scale-105 hover:shadow-lg">
              <div class="flex flex-col items-center text-center">
                <div class="w-20 h-20 rounded-full overflow-hidden mb-3 border-2 border-red-500">
                  <img src="<%= opponent.image_url || '/images/default_opponent.png' %>" alt="<%= opponent.name %>" class="w-full h-full object-cover">
                </div>
                <h3 class="text-lg font-semibold text-white"><%= opponent.name %></h3>
                <p class="text-gray-400 text-sm mb-2">Level <%= opponent.level || 1 %></p>

                <div class="mb-3">
                  <span class="px-3 py-1 rounded text-xs font-bold
                    <% if (opponent.difficulty === 'easy') { %>bg-green-600 text-white<% } %>
                    <% if (opponent.difficulty === 'normal') { %>bg-blue-600 text-white<% } %>
                    <% if (opponent.difficulty === 'hard') { %>bg-orange-600 text-white<% } %>
                    <% if (opponent.difficulty === 'elite') { %>bg-red-600 text-white<% } %>
                  ">
                    <%= opponent.difficulty.toUpperCase() %>
                  </span>
                </div>

                <p class="text-gray-300 text-sm text-center mb-4"><%= opponent.description || 'A challenging opponent awaits!' %></p>

                <button
                  onclick="startBattle('<%= trainer.id %>', '<%= opponent.opponent_id %>')"
                  class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded"
                >
                  Battle!
                </button>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="text-center py-8">
          <p class="text-gray-400">No opponents available.</p>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Battle History -->
  <div class="mt-8 bg-gray-800 rounded-lg p-6 shadow-lg">
    <h2 class="text-2xl font-bold text-yellow-400 mb-4">Battle History</h2>

    <% if (battleStats) { %>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <p class="text-gray-400 text-sm">Total Battles</p>
          <p class="text-white text-2xl font-bold"><%= battleStats.total_battles || 0 %></p>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <p class="text-gray-400 text-sm">Wins</p>
          <p class="text-green-400 text-2xl font-bold"><%= battleStats.wins || 0 %></p>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <p class="text-gray-400 text-sm">Losses</p>
          <p class="text-red-400 text-2xl font-bold"><%= battleStats.losses || 0 %></p>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <p class="text-gray-400 text-sm">Avg. WPM</p>
          <p class="text-blue-400 text-2xl font-bold"><%= Math.round(battleStats.avg_wpm || 0) %></p>
        </div>
      </div>
    <% } %>

    <% if (battleHistory && battleHistory.length > 0) { %>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-gray-700 rounded-lg">
          <thead>
            <tr>
              <th class="px-4 py-2 text-left text-gray-300">Date</th>
              <th class="px-4 py-2 text-left text-gray-300">Opponent</th>
              <th class="px-4 py-2 text-left text-gray-300">Result</th>
              <th class="px-4 py-2 text-left text-gray-300">WPM</th>
              <th class="px-4 py-2 text-left text-gray-300">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% battleHistory.forEach(battle => { %>
              <tr class="border-t border-gray-600">
                <td class="px-4 py-2 text-gray-300">
                  <%= new Date(battle.started_at).toLocaleDateString() %>
                </td>
                <td class="px-4 py-2 text-white">
                  <%= battle.opponent_name || 'Unknown Opponent' %>
                </td>
                <td class="px-4 py-2">
                  <% if (battle.status === 'won') { %>
                    <span class="text-green-400">Victory</span>
                  <% } else if (battle.status === 'lost') { %>
                    <span class="text-red-400">Defeat</span>
                  <% } else if (battle.status === 'abandoned') { %>
                    <span class="text-gray-400">Abandoned</span>
                  <% } else { %>
                    <span class="text-yellow-400">In Progress</span>
                  <% } %>
                </td>
                <td class="px-4 py-2 text-gray-300">
                  <%= battle.wpm || '-' %>
                </td>
                <td class="px-4 py-2">
                  <% if (battle.status === 'in_progress') { %>
                    <a href="/battles/arena/<%= battle.battle_id %>" class="text-blue-400 hover:text-blue-300">
                      Continue
                    </a>
                  <% } else { %>
                    <a href="/battles/results/<%= battle.battle_id %>" class="text-blue-400 hover:text-blue-300">
                      View Results
                    </a>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-right">
        <a href="/battles/history/<%= trainer.id %>" class="text-blue-400 hover:text-blue-300">
          View Full History <i class="fas fa-arrow-right ml-1"></i>
        </a>
      </div>
    <% } else { %>
      <div class="text-center py-8">
        <p class="text-gray-400">No battle history yet.</p>
      </div>
    <% } %>
  </div>
</div>

<script>
  function startBattle(trainerId, opponentId) {
    // Disable all battle buttons
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      button.disabled = true;
      button.classList.add('opacity-50');
      button.innerHTML = 'Starting battle...';
    });

    // Make API request to start battle
    fetch('/api/battles/start', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        trainerId,
        opponentId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Redirect to battle arena
        window.location.href = `/battles/arena/${data.battle.battle_id}`;
      } else {
        // Show error
        alert(data.message || 'Failed to start battle');

        // Re-enable buttons
        buttons.forEach(button => {
          button.disabled = false;
          button.classList.remove('opacity-50');
          button.innerHTML = 'Battle!';
        });
      }
    })
    .catch(error => {
      console.error('Error starting battle:', error);
      alert('Error starting battle. Please try again.');

      // Re-enable buttons
      buttons.forEach(button => {
        button.disabled = false;
        button.classList.remove('opacity-50');
        button.innerHTML = 'Battle!';
      });
    });
  }
</script>
