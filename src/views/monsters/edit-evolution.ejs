<% /* Set the title and other variables for the layout */ %>
<% title = title || `Edit Evolution Line for ${monster.name}` %>

<style>
.form-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    background: rgba(30, 37, 50, 0.5);
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.form-title {
    text-align: center;
    margin-bottom: 2rem;
}

.form-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
}

.form-section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--accent-color, #d4b3ff);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 0.5rem;
}

.evolution-entries {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.evolution-entry {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    position: relative;
}

.entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.entry-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--accent-color, #d4b3ff);
}

.entry-actions {
    display: flex;
    gap: 0.5rem;
}

.entry-form {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: var(--text-color, #fff);
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-color, #d4b3ff);
    box-shadow: 0 0 0 2px rgba(212, 179, 255, 0.3);
}

.form-note {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 0.5rem;
}

.preview-image {
    max-width: 100px;
    max-height: 100px;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    font-size: 1rem;
}

.btn-primary {
    background: var(--accent-color, #d4b3ff);
    color: #000;
}

.btn-primary:hover {
    background: #c39dff;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-color, #fff);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
}

.btn-danger {
    background: #e74c3c;
    color: #fff;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
}

.form-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    gap: 1rem;
}

.add-entry-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: var(--text-color, #fff);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.add-entry-btn:hover {
    background: rgba(0, 0, 0, 0.3);
    border-color: var(--accent-color, #d4b3ff);
}

.current-monster {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 2px solid var(--accent-color, #d4b3ff);
}

.current-monster-image {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    overflow: hidden;
}

.current-monster-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.current-monster-info {
    flex: 1;
}

.current-monster-name {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.current-monster-level {
    font-size: 1.1rem;
    color: var(--accent-color, #d4b3ff);
}

.move-entry-btn {
    background: rgba(0, 0, 0, 0.3);
    border: none;
    color: var(--text-color, #fff);
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.move-entry-btn:hover {
    background: rgba(0, 0, 0, 0.4);
}

.remove-entry-btn {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
}

.remove-entry-btn:hover {
    background: rgba(231, 76, 60, 0.3);
}

@media (max-width: 768px) {
    .entry-form {
        grid-template-columns: 1fr;
    }

    .form-actions {
        flex-direction: column;
    }

    .btn {
        width: 100%;
    }

    .current-monster {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<div class="container mt-8 mb-12">
    <div class="form-container">
        <h1 class="form-title text-4xl font-display font-bold">Edit Evolution Line: <%= monster.name %></h1>

        <div class="current-monster">
            <div class="current-monster-image">
                <img src="<%= monster.img_link || '/images/default_mon.png' %>" alt="<%= monster.name %>" onerror="this.src='/images/default_mon.png'">
            </div>
            <div class="current-monster-info">
                <div class="current-monster-name"><%= monster.name %></div>
                <div class="current-monster-level">Level <%= monster.level %></div>
            </div>
        </div>

        <form action="/trainers/<%= trainer.id %>/monsters/<%= monster.mon_id %>/update-evolution" method="POST">
            <!-- Pre-evolutions Section -->
            <div class="form-section">
                <h2 class="form-section-title">Pre-evolutions</h2>
                <p class="form-note mb-4">Add monsters that evolve into <%= monster.name %>. These will appear before <%= monster.name %> in the evolution chain.</p>

                <div id="preEvolutionsContainer" class="evolution-entries">
                    <% if (preEvolutions && preEvolutions.length > 0) { %>
                        <% preEvolutions.forEach((evo, index) => { %>
                            <div class="evolution-entry" data-index="<%= index %>">
                                <div class="entry-header">
                                    <div class="entry-title">Pre-evolution #<%= index + 1 %></div>
                                    <div class="entry-actions">
                                        <button type="button" class="move-entry-btn move-to-future" data-index="<%= index %>">
                                            <span>Move to Evolutions</span>
                                        </button>
                                        <button type="button" class="move-entry-btn remove-entry-btn" data-index="<%= index %>">
                                            <span>Remove</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="entry-form">
                                    <div class="form-group">
                                        <label for="preEvolutions[<%= index %>][name]">Name/Title</label>
                                        <input type="text" id="preEvolutions[<%= index %>][name]" name="preEvolutions[<%= index %>][name]" class="form-control" value="<%= evo.name || '' %>" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="preEvolutions[<%= index %>][condition]">Evolution Condition</label>
                                        <input type="text" id="preEvolutions[<%= index %>][condition]" name="preEvolutions[<%= index %>][condition]" class="form-control" value="<%= evo.condition || '' %>" placeholder="e.g., Level 16, Trade, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label for="preEvolutions[<%= index %>][image]">Image URL</label>
                                        <input type="text" id="preEvolutions[<%= index %>][image]" name="preEvolutions[<%= index %>][image]" class="form-control" value="<%= evo.image || '' %>" placeholder="https://example.com/image.jpg">
                                        <% if (evo.image) { %>
                                        <img src="<%= evo.image %>" alt="<%= evo.name %>" class="preview-image" onerror="this.style.display='none'">
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>

                <button type="button" id="addPreEvolution" class="add-entry-btn mt-4">
                    <span>+ Add Pre-evolution</span>
                </button>
            </div>

            <!-- Future Evolutions Section -->
            <div class="form-section">
                <h2 class="form-section-title">Evolutions</h2>
                <p class="form-note mb-4">Add monsters that <%= monster.name %> evolves into. These will appear after <%= monster.name %> in the evolution chain.</p>

                <div id="futureEvolutionsContainer" class="evolution-entries">
                    <% if (futureEvolutions && futureEvolutions.length > 0) { %>
                        <% futureEvolutions.forEach((evo, index) => { %>
                            <div class="evolution-entry" data-index="<%= index %>">
                                <div class="entry-header">
                                    <div class="entry-title">Evolution #<%= index + 1 %></div>
                                    <div class="entry-actions">
                                        <button type="button" class="move-entry-btn move-to-pre" data-index="<%= index %>">
                                            <span>Move to Pre-evolutions</span>
                                        </button>
                                        <button type="button" class="move-entry-btn remove-entry-btn" data-index="<%= index %>">
                                            <span>Remove</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="entry-form">
                                    <div class="form-group">
                                        <label for="futureEvolutions[<%= index %>][name]">Name/Title</label>
                                        <input type="text" id="futureEvolutions[<%= index %>][name]" name="futureEvolutions[<%= index %>][name]" class="form-control" value="<%= evo.name || '' %>" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="futureEvolutions[<%= index %>][condition]">Evolution Condition</label>
                                        <input type="text" id="futureEvolutions[<%= index %>][condition]" name="futureEvolutions[<%= index %>][condition]" class="form-control" value="<%= evo.condition || '' %>" placeholder="e.g., Level 36, Stone, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label for="futureEvolutions[<%= index %>][image]">Image URL</label>
                                        <input type="text" id="futureEvolutions[<%= index %>][image]" name="futureEvolutions[<%= index %>][image]" class="form-control" value="<%= evo.image || '' %>" placeholder="https://example.com/image.jpg">
                                        <% if (evo.image) { %>
                                        <img src="<%= evo.image %>" alt="<%= evo.name %>" class="preview-image" onerror="this.style.display='none'">
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>

                <button type="button" id="addFutureEvolution" class="add-entry-btn mt-4">
                    <span>+ Add Evolution</span>
                </button>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="/trainers/<%= trainer.id %>/monsters/<%= monster.mon_id %>#evolution" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save Evolution Line</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Pre-evolution
        document.getElementById('addPreEvolution').addEventListener('click', function() {
            const container = document.getElementById('preEvolutionsContainer');
            const index = container.children.length;
            
            const entryHtml = `
                <div class="evolution-entry" data-index="${index}">
                    <div class="entry-header">
                        <div class="entry-title">Pre-evolution #${index + 1}</div>
                        <div class="entry-actions">
                            <button type="button" class="move-entry-btn move-to-future" data-index="${index}">
                                <span>Move to Evolutions</span>
                            </button>
                            <button type="button" class="move-entry-btn remove-entry-btn" data-index="${index}">
                                <span>Remove</span>
                            </button>
                        </div>
                    </div>
                    <div class="entry-form">
                        <div class="form-group">
                            <label for="preEvolutions[${index}][name]">Name/Title</label>
                            <input type="text" id="preEvolutions[${index}][name]" name="preEvolutions[${index}][name]" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="preEvolutions[${index}][condition]">Evolution Condition</label>
                            <input type="text" id="preEvolutions[${index}][condition]" name="preEvolutions[${index}][condition]" class="form-control" placeholder="e.g., Level 16, Trade, etc.">
                        </div>
                        <div class="form-group">
                            <label for="preEvolutions[${index}][image]">Image URL</label>
                            <input type="text" id="preEvolutions[${index}][image]" name="preEvolutions[${index}][image]" class="form-control" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', entryHtml);
            attachEventListeners();
        });

        // Add Future Evolution
        document.getElementById('addFutureEvolution').addEventListener('click', function() {
            const container = document.getElementById('futureEvolutionsContainer');
            const index = container.children.length;
            
            const entryHtml = `
                <div class="evolution-entry" data-index="${index}">
                    <div class="entry-header">
                        <div class="entry-title">Evolution #${index + 1}</div>
                        <div class="entry-actions">
                            <button type="button" class="move-entry-btn move-to-pre" data-index="${index}">
                                <span>Move to Pre-evolutions</span>
                            </button>
                            <button type="button" class="move-entry-btn remove-entry-btn" data-index="${index}">
                                <span>Remove</span>
                            </button>
                        </div>
                    </div>
                    <div class="entry-form">
                        <div class="form-group">
                            <label for="futureEvolutions[${index}][name]">Name/Title</label>
                            <input type="text" id="futureEvolutions[${index}][name]" name="futureEvolutions[${index}][name]" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="futureEvolutions[${index}][condition]">Evolution Condition</label>
                            <input type="text" id="futureEvolutions[${index}][condition]" name="futureEvolutions[${index}][condition]" class="form-control" placeholder="e.g., Level 36, Stone, etc.">
                        </div>
                        <div class="form-group">
                            <label for="futureEvolutions[${index}][image]">Image URL</label>
                            <input type="text" id="futureEvolutions[${index}][image]" name="futureEvolutions[${index}][image]" class="form-control" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', entryHtml);
            attachEventListeners();
        });

        // Function to attach event listeners to dynamically added elements
        function attachEventListeners() {
            // Remove entry buttons
            document.querySelectorAll('.remove-entry-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const entry = this.closest('.evolution-entry');
                    entry.remove();
                    updateIndices();
                });
            });

            // Move to future evolutions buttons
            document.querySelectorAll('.move-to-future').forEach(button => {
                button.addEventListener('click', function() {
                    const entry = this.closest('.evolution-entry');
                    const preContainer = document.getElementById('preEvolutionsContainer');
                    const futureContainer = document.getElementById('futureEvolutionsContainer');
                    
                    // Get form values
                    const nameInput = entry.querySelector('input[name^="preEvolutions"][name$="[name]"]');
                    const conditionInput = entry.querySelector('input[name^="preEvolutions"][name$="[condition]"]');
                    const imageInput = entry.querySelector('input[name^="preEvolutions"][name$="[image]"]');
                    
                    const name = nameInput ? nameInput.value : '';
                    const condition = conditionInput ? conditionInput.value : '';
                    const image = imageInput ? imageInput.value : '';
                    
                    // Remove from pre-evolutions
                    entry.remove();
                    
                    // Add to future evolutions
                    const index = futureContainer.children.length;
                    const newEntryHtml = `
                        <div class="evolution-entry" data-index="${index}">
                            <div class="entry-header">
                                <div class="entry-title">Evolution #${index + 1}</div>
                                <div class="entry-actions">
                                    <button type="button" class="move-entry-btn move-to-pre" data-index="${index}">
                                        <span>Move to Pre-evolutions</span>
                                    </button>
                                    <button type="button" class="move-entry-btn remove-entry-btn" data-index="${index}">
                                        <span>Remove</span>
                                    </button>
                                </div>
                            </div>
                            <div class="entry-form">
                                <div class="form-group">
                                    <label for="futureEvolutions[${index}][name]">Name/Title</label>
                                    <input type="text" id="futureEvolutions[${index}][name]" name="futureEvolutions[${index}][name]" class="form-control" value="${name}" required>
                                </div>
                                <div class="form-group">
                                    <label for="futureEvolutions[${index}][condition]">Evolution Condition</label>
                                    <input type="text" id="futureEvolutions[${index}][condition]" name="futureEvolutions[${index}][condition]" class="form-control" value="${condition}" placeholder="e.g., Level 36, Stone, etc.">
                                </div>
                                <div class="form-group">
                                    <label for="futureEvolutions[${index}][image]">Image URL</label>
                                    <input type="text" id="futureEvolutions[${index}][image]" name="futureEvolutions[${index}][image]" class="form-control" value="${image}" placeholder="https://example.com/image.jpg">
                                    ${image ? `<img src="${image}" alt="${name}" class="preview-image" onerror="this.style.display='none'">` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    futureContainer.insertAdjacentHTML('beforeend', newEntryHtml);
                    updateIndices();
                    attachEventListeners();
                });
            });

            // Move to pre-evolutions buttons
            document.querySelectorAll('.move-to-pre').forEach(button => {
                button.addEventListener('click', function() {
                    const entry = this.closest('.evolution-entry');
                    const preContainer = document.getElementById('preEvolutionsContainer');
                    const futureContainer = document.getElementById('futureEvolutionsContainer');
                    
                    // Get form values
                    const nameInput = entry.querySelector('input[name^="futureEvolutions"][name$="[name]"]');
                    const conditionInput = entry.querySelector('input[name^="futureEvolutions"][name$="[condition]"]');
                    const imageInput = entry.querySelector('input[name^="futureEvolutions"][name$="[image]"]');
                    
                    const name = nameInput ? nameInput.value : '';
                    const condition = conditionInput ? conditionInput.value : '';
                    const image = imageInput ? imageInput.value : '';
                    
                    // Remove from future evolutions
                    entry.remove();
                    
                    // Add to pre-evolutions
                    const index = preContainer.children.length;
                    const newEntryHtml = `
                        <div class="evolution-entry" data-index="${index}">
                            <div class="entry-header">
                                <div class="entry-title">Pre-evolution #${index + 1}</div>
                                <div class="entry-actions">
                                    <button type="button" class="move-entry-btn move-to-future" data-index="${index}">
                                        <span>Move to Evolutions</span>
                                    </button>
                                    <button type="button" class="move-entry-btn remove-entry-btn" data-index="${index}">
                                        <span>Remove</span>
                                    </button>
                                </div>
                            </div>
                            <div class="entry-form">
                                <div class="form-group">
                                    <label for="preEvolutions[${index}][name]">Name/Title</label>
                                    <input type="text" id="preEvolutions[${index}][name]" name="preEvolutions[${index}][name]" class="form-control" value="${name}" required>
                                </div>
                                <div class="form-group">
                                    <label for="preEvolutions[${index}][condition]">Evolution Condition</label>
                                    <input type="text" id="preEvolutions[${index}][condition]" name="preEvolutions[${index}][condition]" class="form-control" value="${condition}" placeholder="e.g., Level 16, Trade, etc.">
                                </div>
                                <div class="form-group">
                                    <label for="preEvolutions[${index}][image]">Image URL</label>
                                    <input type="text" id="preEvolutions[${index}][image]" name="preEvolutions[${index}][image]" class="form-control" value="${image}" placeholder="https://example.com/image.jpg">
                                    ${image ? `<img src="${image}" alt="${name}" class="preview-image" onerror="this.style.display='none'">` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    preContainer.insertAdjacentHTML('beforeend', newEntryHtml);
                    updateIndices();
                    attachEventListeners();
                });
            });

            // Image preview
            document.querySelectorAll('input[name$="[image]"]').forEach(input => {
                input.addEventListener('blur', function() {
                    const container = this.parentElement;
                    let previewImg = container.querySelector('.preview-image');
                    
                    if (this.value) {
                        if (!previewImg) {
                            previewImg = document.createElement('img');
                            previewImg.className = 'preview-image';
                            previewImg.onerror = function() { this.style.display = 'none'; };
                            container.appendChild(previewImg);
                        }
                        
                        previewImg.src = this.value;
                        previewImg.alt = container.closest('.evolution-entry').querySelector('input[name$="[name]"]').value || 'Evolution';
                        previewImg.style.display = 'block';
                    } else if (previewImg) {
                        previewImg.style.display = 'none';
                    }
                });
            });
        }

        // Function to update indices after removing or moving entries
        function updateIndices() {
            // Update pre-evolutions
            const preContainer = document.getElementById('preEvolutionsContainer');
            Array.from(preContainer.children).forEach((entry, index) => {
                entry.setAttribute('data-index', index);
                entry.querySelector('.entry-title').textContent = `Pre-evolution #${index + 1}`;
                
                // Update input names and IDs
                entry.querySelectorAll('input').forEach(input => {
                    const name = input.getAttribute('name');
                    const id = input.getAttribute('id');
                    
                    if (name) {
                        const newName = name.replace(/preEvolutions\[\d+\]/, `preEvolutions[${index}]`);
                        input.setAttribute('name', newName);
                    }
                    
                    if (id) {
                        const newId = id.replace(/preEvolutions\[\d+\]/, `preEvolutions[${index}]`);
                        input.setAttribute('id', newId);
                    }
                });
                
                // Update label for attributes
                entry.querySelectorAll('label').forEach(label => {
                    const forAttr = label.getAttribute('for');
                    
                    if (forAttr) {
                        const newForAttr = forAttr.replace(/preEvolutions\[\d+\]/, `preEvolutions[${index}]`);
                        label.setAttribute('for', newForAttr);
                    }
                });
            });
            
            // Update future evolutions
            const futureContainer = document.getElementById('futureEvolutionsContainer');
            Array.from(futureContainer.children).forEach((entry, index) => {
                entry.setAttribute('data-index', index);
                entry.querySelector('.entry-title').textContent = `Evolution #${index + 1}`;
                
                // Update input names and IDs
                entry.querySelectorAll('input').forEach(input => {
                    const name = input.getAttribute('name');
                    const id = input.getAttribute('id');
                    
                    if (name) {
                        const newName = name.replace(/futureEvolutions\[\d+\]/, `futureEvolutions[${index}]`);
                        input.setAttribute('name', newName);
                    }
                    
                    if (id) {
                        const newId = id.replace(/futureEvolutions\[\d+\]/, `futureEvolutions[${index}]`);
                        input.setAttribute('id', newId);
                    }
                });
                
                // Update label for attributes
                entry.querySelectorAll('label').forEach(label => {
                    const forAttr = label.getAttribute('for');
                    
                    if (forAttr) {
                        const newForAttr = forAttr.replace(/futureEvolutions\[\d+\]/, `futureEvolutions[${index}]`);
                        label.setAttribute('for', newForAttr);
                    }
                });
            });
        }

        // Initialize event listeners
        attachEventListeners();
    });
</script>
