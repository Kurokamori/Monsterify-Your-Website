<% /* Set the title and other variables for the layout */ %>
<% title = title || `${monster.name} - Monster Details` %>

<style>
/* Main layout containers */
.full-width-section {
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    padding: 3rem 0;
    background-image: linear-gradient(to bottom, rgba(30, 37, 50, 0.8), rgba(17, 19, 25, 0.9));
}

.full-width-content {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 2rem;
}

.content-padding {
    padding: 0 2rem;
}

/* Monster Page Layout */
.monster-page-layout {
    display: flex;
    gap: 1.5rem;
    position: relative;
    padding: 0 1.5rem;
}

.monster-sidebar {
    flex: 0 0 220px;
    align-self: flex-start;
    position: sticky;
    top: 2rem;
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
}

.monster-main-content {
    flex: 1;
    min-width: 0;
    padding: 0 1rem;
}

.sidebar-nav {
    background: rgba(30, 37, 50, 0.7);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.sidebar-link {
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.2s ease;
    font-weight: 500;
    font-size: 0.95rem;
}

.sidebar-link:hover {
    background: var(--nav-hover);
}

.sidebar-link.active {
    background: var(--nav-active, rgba(214, 163, 57, 0.2));
    color: var(--accent-color, #d4b3ff);
    font-weight: 700;
    border-left: 3px solid var(--accent-color, #d4b3ff);
}

.sidebar-divider {
    height: 1px;
    background: var(--divider-color);
    margin: 0.75rem 0;
}

.box-navigation-container {
    padding: 0.5rem 0;
}

.box-nav-title {
    font-size: 0.85rem;
    color: var(--accent-color);
    margin-bottom: 0.5rem;
    padding-left: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.mon-pagination {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
}

.pagination-link {
    font-size: 0.85rem;
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.2s ease;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.05);
}

.pagination-link:hover {
    background: var(--nav-hover);
    color: var(--accent-color);
}

.pagination-link.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: none;
}

.owner-action {
    border-left: 3px solid var(--accent-color);
}

.owner-action.highlight {
    background: rgba(214, 163, 57, 0.2);
}

.owner-action.highlight:hover {
    background: rgba(214, 163, 57, 0.3);
}

.main-info-container {
    display: flex;
    gap: 3rem;
    margin-bottom: 3rem;
}

.monster-info-column {
    flex: 1;
    min-width: 0; /* Prevents flex item from overflowing */
}

.reference-image-container {
    flex: 0 0 500px;
    height: auto;
    max-height: 700px;
    position: relative;
}

.reference-image {
    width: 100%;
    height: 100%;
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
}

.reference-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.5s ease;
}

.reference-image:hover img {
    transform: scale(1.03);
}

.image-credit {
    position: absolute;
    bottom: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: rgba(255, 255, 255, 0.8);
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    border-top-left-radius: 8px;
}

/* Info Grid Styling */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
    background: rgba(30, 37, 50, 0.5);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.info-item {
    display: flex;
    flex-direction: column;
}

.info-item label {
    font-size: 0.9rem;
    color: var(--accent-color);
    margin-bottom: 0.3rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.info-item span {
    font-size: 1.1rem;
}

/* Species and Types Styling */
.species-types-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin: 2rem 0;
    background: rgba(30, 37, 50, 0.5);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.species-list, .type-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.species {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
}

.type {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Stats Section */
.stats-section {
    margin: 3rem 0;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.6), rgba(30, 37, 50, 0.6));
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
    padding: 1rem;
    border-radius: 12px;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Moves Section */
.moves-section {
    margin: 3rem 0;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.6), rgba(30, 37, 50, 0.6));
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.moves-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.move-card {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.move-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.move-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}

.move-type {
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.move-description {
    font-size: 0.95rem;
    line-height: 1.5;
}

/* Evolution Section */
.evolution-section {
    margin: 3rem 0;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.6), rgba(30, 37, 50, 0.6));
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.evolution-chain {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
}

.evolution-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
    padding: 1.5rem;
    border-radius: 12px;
    min-width: 200px;
}

.evolution-image {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    margin-bottom: 1rem;
}

.evolution-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.evolution-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.evolution-level {
    font-size: 0.9rem;
    color: var(--accent-color);
}

.evolution-arrow {
    font-size: 2rem;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Biography Section */
.biography-section {
    margin: 3rem 0;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.6), rgba(30, 37, 50, 0.6));
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.bio-content {
    line-height: 1.8;
    white-space: pre-line;
}

/* Additional Information Section */
.additional-info-section {
    margin: 3rem 0;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.6), rgba(30, 37, 50, 0.6));
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.talk-section {
    margin-top: 1.5rem;
}

.talk-bubble {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    position: relative;
    font-style: italic;
    line-height: 1.6;
}

.talk-bubble::before {
    content: '\201C';
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    font-size: 2rem;
    color: var(--accent-color);
    opacity: 0.3;
}

.talk-bubble::after {
    content: '\201D';
    position: absolute;
    bottom: 0;
    right: 0.5rem;
    font-size: 2rem;
    color: var(--accent-color);
    opacity: 0.3;
}

/* Special Features Section */
.special-features-section {
    margin: 3rem 0;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.6), rgba(30, 37, 50, 0.6));
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.special-features-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.special-feature {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
    padding: 1.5rem;
    border-radius: 12px;
    min-width: 120px;
    text-align: center;
}

.feature-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.feature-name {
    font-weight: 600;
}

.feature-icon.shiny {
    color: gold;
}

.feature-icon.alpha {
    color: #ff5555;
}

.feature-icon.shadow {
    color: #9370db;
}

.feature-icon.paradox {
    color: #00bfff;
}

.feature-icon.pokerus {
    color: #ff69b4;
}

.mega-evolution-info {
    margin-top: 2rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
}

.mega-image-container {
    margin-top: 1.5rem;
    text-align: center;
}

.mega-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.mega-types {
    margin-top: 1.5rem;
}

.evolution-condition {
    font-size: 0.9rem;
    color: var(--accent-color);
    margin-top: 0.5rem;
    text-align: center;
}

.evolution-stage.current {
    border: 2px solid var(--accent-color);
    background: rgba(214, 163, 57, 0.1);
}

.no-evolution-message {
    text-align: center;
    padding: 2rem;
    font-style: italic;
    color: rgba(255, 255, 255, 0.7);
}

.stat-details {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
}

.tldr-section {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid var(--accent-color);
}

.trainer-link {
    color: var(--accent-color, #d4b3ff);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s ease;
    position: relative;
}

.trainer-link:hover {
    text-decoration: underline;
    color: #f8d030; /* Gold color on hover */
}

.trainer-link::after {
    content: '‚Üí';
    margin-left: 0.3rem;
    opacity: 0;
    transform: translateX(-5px);
    display: inline-block;
    transition: all 0.2s ease;
}

.trainer-link:hover::after {
    opacity: 1;
    transform: translateX(0);
}

/* Type Colors */
.normal { background-color: #A8A878; color: #fff; }
.fire { background-color: #F08030; color: #fff; }
.water { background-color: #6890F0; color: #fff; }
.electric { background-color: #F8D030; color: #000; }
.grass { background-color: #78C850; color: #fff; }
.ice { background-color: #98D8D8; color: #000; }
.fighting { background-color: #C03028; color: #fff; }
.poison { background-color: #A040A0; color: #fff; }
.ground { background-color: #E0C068; color: #000; }
.flying { background-color: #A890F0; color: #fff; }
.psychic { background-color: #F85888; color: #fff; }
.bug { background-color: #A8B820; color: #fff; }
.rock { background-color: #B8A038; color: #fff; }
.ghost { background-color: #705898; color: #fff; }
.dragon { background-color: #7038F8; color: #fff; }
.dark { background-color: #705848; color: #fff; }
.steel { background-color: #B8B8D0; color: #000; }
.fairy { background-color: #EE99AC; color: #000; }

/* Attribute colors */
.attribute-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}
.attribute-data { background-color: #3498db; color: #fff; }
.attribute-vaccine { background-color: #2ecc71; color: #fff; }
.attribute-virus { background-color: #e74c3c; color: #fff; }
.attribute-free { background-color: #9b59b6; color: #fff; }
.attribute-variable { background-color: #f1c40f; color: #000; }

/* Responsive Design */
@media (max-width: 1200px) {
    .species-types-row {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1024px) {
    .monster-page-layout {
        flex-direction: column;
    }

    .monster-sidebar {
        flex: 0 0 auto;
        position: static;
        height: auto;
        max-height: none;
        margin-bottom: 1.5rem;
        overflow-y: visible;
    }

    .sidebar-nav {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.4rem;
        padding: 0.75rem;
    }

    .sidebar-link {
        padding: 0.4rem 0.75rem;
        font-size: 0.9rem;
    }

    .sidebar-divider {
        display: none;
    }

    .mon-pagination {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
    }

    .main-info-container {
        flex-direction: column;
    }

    .reference-image-container {
        flex: 0 0 auto;
        max-height: 550px;
        position: relative;
        margin: 0 auto;
        width: 100%;
        max-width: 500px;
    }

    .evolution-chain {
        flex-direction: column;
    }

    .evolution-arrow {
        transform: rotate(90deg);
        margin: 1rem 0;
    }
}

@media (max-width: 768px) {
    .full-width-section {
        padding: 2rem 0;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .moves-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .content-padding {
        padding: 0 1rem;
    }

    .info-grid {
        grid-template-columns: 1fr;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .sidebar-link {
        font-size: 0.85rem;
        padding: 0.35rem 0.6rem;
    }

    .reference-image-container {
        max-height: 450px;
    }
}
</style>
<div class="full-width-section">
    <div class="container">
        <span></span>
    </div>
</div>

<div class="full-width-content">
    <div class="monster-page-layout">
        <!-- Side Navigation -->
        <div class="monster-sidebar">
            <div class="sidebar-nav">
                <a href="#" class="sidebar-link active">Profile</a>
                <a href="#stats" class="sidebar-link">Stats</a>
                <a href="#moves" class="sidebar-link">Moves</a>
                <a href="#evolution" class="sidebar-link">Evolution</a>
                <% if (monster.bio || monster.tldr) { %>
                <a href="#biography" class="sidebar-link">Biography</a>
                <% } %>
                <% if (monster.gender || monster.pronouns || monster.nature || monster.characteristic ||
                      monster.fav_berry || monster.held_item || monster.seal || monster.mark ||
                      monster.date_met || monster.where_met || monster.height || monster.acquired ||
                      monster.poke_ball || monster.talk || monster.friendship) { %>
                <a href="#additional-info" class="sidebar-link">Additional Info</a>
                <% } %>
                <% if (monster.shiny || monster.alpha || monster.shadow || monster.paradox ||
                      monster.pokerus || monster.mega_stone) { %>
                <a href="#special-features" class="sidebar-link">Special Features</a>
                <% } %>

                <!-- Box Navigation -->
                <% if (monster.box_number) { %>
                <div class="sidebar-divider"></div>
                <div class="box-navigation-container">
                    <h3 class="box-nav-title">Box Navigation</h3>
                    <a href="/trainers/<%= trainer.id %>/pc?box=<%= monster.box_number %>" class="sidebar-link">Return to Box <%= monster.box_number %></a>
                    <a href="/trainers/<%= trainer.id %>/pc" class="sidebar-link">Return to Box Overview</a>

                    <!-- Pagination for monsters in the same box -->
                    <div class="mon-pagination">
                        <% if (locals.prev_mon_in_box) { %>
                        <a href="/trainers/<%= trainer.id %>/monsters/<%= prev_mon_in_box.mon_id %>" class="pagination-link prev" title="<%= prev_mon_in_box.name %>">
                            ‚Üê Previous
                        </a>
                        <% } else { %>
                        <span class="pagination-link disabled">‚Üê Previous</span>
                        <% } %>

                        <% if (locals.next_mon_in_box) { %>
                        <a href="/trainers/<%= trainer.id %>/monsters/<%= next_mon_in_box.mon_id %>" class="pagination-link next" title="<%= next_mon_in_box.name %>">
                            Next ‚Üí
                        </a>
                        <% } else { %>
                        <span class="pagination-link disabled">Next ‚Üí</span>
                        <% } %>
                    </div>
                </div>
                <% } %>

                <div class="sidebar-divider"></div>
                <a href="/trainers/<%= trainer.id %>" class="sidebar-link">Back to Trainer</a>

                <% if (locals.user && locals.user.discord_id && trainer.player_user_id && locals.user.discord_id.toString() === trainer.player_user_id) { %>
                <div class="sidebar-divider"></div>
                <a href="/trainers/<%= trainer.id %>/monsters/<%= monster.mon_id %>/edit" class="sidebar-link owner-action">Edit Monster</a>
                <a href="/trainers/<%= trainer.id %>/monsters/<%= monster.mon_id %>/edit-evolution" class="sidebar-link owner-action">Edit Evolution Line</a>
                <% } %>
            </div>
        </div>

        <!-- Main Content -->
        <div class="monster-main-content">
            <div id="profile" class="main-info-container">
                <!-- Left: Monster Image -->
                <div class="reference-image-container">
                    <div class="reference-image">
                        <img src="<%= monster.img_link || '/images/default_mon.png' %>"
                             alt="<%= monster.name %>"
                             onerror="this.src='/images/default_mon.png'">
                    </div>
                </div>

                <!-- Right: Monster Info -->
                <div class="monster-info-column">
                    <h1 class="text-5xl font-display font-bold mb-4"><%= monster.name %></h1>
                    <% if (monster.level) { %>
                        <h2 class="text-3xl font-display text-[#d4b3ff] mb-8">Level <%= monster.level %></h2>
                    <% } %>

                    <!-- Primary Information -->
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Trainer</label>
                            <span><a href="/trainers/<%= trainer.id %>" class="trainer-link"><%= trainer.name %></a></span>
                        </div>

                        <% if (monster.level) { %>
                        <div class="info-item">
                            <label>Level</label>
                            <span><%= monster.level %></span>
                        </div>
                        <% } %>

                        <% if (monster.box_number) { %>
                        <div class="info-item">
                            <label>Box</label>
                            <span><%= monster.box_number === 1 ? 'Battle Box' : `Box ${monster.box_number}` %></span>
                        </div>
                        <% } %>

                        <% if (monster.attribute) { %>
                        <div class="info-item">
                            <label>Attribute</label>
                            <span class="attribute-badge attribute-<%= monster.attribute.toLowerCase() %>"><%= monster.attribute %></span>
                        </div>
                        <% } %>
                    </div>

                    <!-- Species and Types Row -->
                    <div class="species-types-row">
                        <div class="info-item">
                            <label>Species</label>
                            <div class="species-list">
                                <% if (monster.species1) { %><span class="species"><%= monster.species1 %></span><% } %>
                                <% if (monster.species2) { %><span class="species"><%= monster.species2 %></span><% } %>
                                <% if (monster.species3) { %><span class="species"><%= monster.species3 %></span><% } %>
                            </div>
                        </div>

                        <div class="info-item">
                            <label>Types</label>
                            <div class="type-list">
                                <% if (monster.type1) { %>
                                <span class="type <%= monster.type1.toLowerCase() %>"><%= monster.type1 %></span>
                                <% } %>
                                <% if (monster.type2) { %>
                                <span class="type <%= monster.type2.toLowerCase() %>"><%= monster.type2 %></span>
                                <% } %>
                                <% if (monster.type3) { %>
                                <span class="type <%= monster.type3.toLowerCase() %>"><%= monster.type3 %></span>
                                <% } %>
                                <% if (monster.type4) { %>
                                <span class="type <%= monster.type4.toLowerCase() %>"><%= monster.type4 %></span>
                                <% } %>
                                <% if (monster.type5) { %>
                                <span class="type <%= monster.type5.toLowerCase() %>"><%= monster.type5 %></span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Section -->
            <div id="stats" class="stats-section">
                <h2 class="text-3xl font-display font-bold mb-4">Stats</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value"><%= monster.hp_total || '?' %></div>
                        <div class="stat-label">HP</div>
                        <% if (monster.hp_ev || monster.hp_iv) { %>
                        <div class="stat-details">
                            <% if (monster.hp_ev) { %><span>EV: <%= monster.hp_ev %></span><% } %>
                            <% if (monster.hp_iv) { %><span>IV: <%= monster.hp_iv %></span><% } %>
                        </div>
                        <% } %>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value"><%= monster.atk_total || '?' %></div>
                        <div class="stat-label">Attack</div>
                        <% if (monster.atk_ev || monster.atk_iv) { %>
                        <div class="stat-details">
                            <% if (monster.atk_ev) { %><span>EV: <%= monster.atk_ev %></span><% } %>
                            <% if (monster.atk_iv) { %><span>IV: <%= monster.atk_iv %></span><% } %>
                        </div>
                        <% } %>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value"><%= monster.def_total || '?' %></div>
                        <div class="stat-label">Defense</div>
                        <% if (monster.def_ev || monster.def_iv) { %>
                        <div class="stat-details">
                            <% if (monster.def_ev) { %><span>EV: <%= monster.def_ev %></span><% } %>
                            <% if (monster.def_iv) { %><span>IV: <%= monster.def_iv %></span><% } %>
                        </div>
                        <% } %>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value"><%= monster.spa_total || '?' %></div>
                        <div class="stat-label">Sp. Attack</div>
                        <% if (monster.spa_ev || monster.spa_iv) { %>
                        <div class="stat-details">
                            <% if (monster.spa_ev) { %><span>EV: <%= monster.spa_ev %></span><% } %>
                            <% if (monster.spa_iv) { %><span>IV: <%= monster.spa_iv %></span><% } %>
                        </div>
                        <% } %>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value"><%= monster.spd_total || '?' %></div>
                        <div class="stat-label">Sp. Defense</div>
                        <% if (monster.spd_ev || monster.spd_iv) { %>
                        <div class="stat-details">
                            <% if (monster.spd_ev) { %><span>EV: <%= monster.spd_ev %></span><% } %>
                            <% if (monster.spd_iv) { %><span>IV: <%= monster.spd_iv %></span><% } %>
                        </div>
                        <% } %>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value"><%= monster.spe_total || '?' %></div>
                        <div class="stat-label">Speed</div>
                        <% if (monster.spe_ev || monster.spe_iv) { %>
                        <div class="stat-details">
                            <% if (monster.spe_ev) { %><span>EV: <%= monster.spe_ev %></span><% } %>
                            <% if (monster.spe_iv) { %><span>IV: <%= monster.spe_iv %></span><% } %>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Moves Section -->
            <div id="moves" class="moves-section">
                <h2 class="text-3xl font-display font-bold mb-4">Moves</h2>
                <div class="moves-grid">
                    <% if (monster.moveset) {
                        // Parse the moveset string into an array
                        let moves = [];
                        try {
                            // Try parsing as JSON first
                            moves = JSON.parse(monster.moveset);
                        } catch (e) {
                            // If not JSON, split by commas or newlines
                            moves = monster.moveset.split(/[,\n]/).map(move => move.trim()).filter(move => move);
                        }

                        // Display each move
                        for (let move of moves) {
                            // Default values if move data isn't available
                            let moveType = 'normal';
                            let moveDescription = 'No description available.';
                    %>
                    <div class="move-card">
                        <div class="move-header">
                            <h3 class="move-name"><%= move %></h3>
                            <span class="move-type <%= moveType %>"><%= moveType.charAt(0).toUpperCase() + moveType.slice(1) %></span>
                        </div>
                        <div class="move-description">
                            <%= moveDescription %>
                        </div>
                    </div>
                    <% } } else { %>
                    <div class="move-card">
                        <div class="move-header">
                            <h3 class="move-name">No Moves</h3>
                        </div>
                        <div class="move-description">
                            This monster doesn't have any moves recorded yet.
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Evolution Section -->
            <div id="evolution" class="evolution-section">
                <h2 class="text-3xl font-display font-bold mb-4">Evolution Chain</h2>
                <div class="evolution-chain">
                    <%
                    // Parse pre-evolutions if they exist
                    let preEvolutions = [];
                    if (monster.preevolution) {
                        try {
                            preEvolutions = JSON.parse(monster.preevolution);
                            if (!Array.isArray(preEvolutions)) {
                                preEvolutions = [preEvolutions];
                            }
                        } catch (e) {
                            // If parsing fails, leave as empty array
                        }
                    }

                    // Parse future evolutions if they exist
                    let futureEvolutions = [];
                    if (monster.evolution) {
                        try {
                            futureEvolutions = JSON.parse(monster.evolution);
                            if (!Array.isArray(futureEvolutions)) {
                                futureEvolutions = [futureEvolutions];
                            }
                        } catch (e) {
                            // If parsing fails, leave as empty array
                        }
                    }

                    // Sort pre-evolutions by index if available
                    preEvolutions.sort((a, b) => (a.index || 0) - (b.index || 0));

                    // Sort future evolutions by index if available
                    futureEvolutions.sort((a, b) => (a.index || 0) - (b.index || 0));

                    // Display pre-evolutions
                    for (let i = 0; i < preEvolutions.length; i++) {
                        const evo = preEvolutions[i];
                    %>
                    <div class="evolution-stage">
                        <div class="evolution-image">
                            <img src="<%= evo.image || '/images/default_mon.png' %>" alt="<%= evo.name || 'Pre-evolution' %>">
                        </div>
                        <div class="evolution-name"><%= evo.name || 'Pre-evolution' %></div>
                        <% if (evo.condition) { %>
                        <div class="evolution-condition"><%= evo.condition %></div>
                        <% } %>
                    </div>
                    <% if (i < preEvolutions.length - 1 || preEvolutions.length > 0) { %>
                    <div class="evolution-arrow">‚Üí</div>
                    <% } %>
                    <% } %>

                    <!-- Current Monster -->
                    <div class="evolution-stage current">
                        <div class="evolution-image">
                            <img src="<%= monster.img_link || '/images/default_mon.png' %>" alt="<%= monster.name %>" onerror="this.src='/images/default_mon.png'">
                        </div>
                        <div class="evolution-name"><%= monster.name %></div>
                        <div class="evolution-level">Level <%= monster.level %></div>
                    </div>

                    <%
                    // Display future evolutions
                    for (let i = 0; i < futureEvolutions.length; i++) {
                        const evo = futureEvolutions[i];
                        if (i === 0 && futureEvolutions.length > 0) {
                    %>
                    <div class="evolution-arrow">‚Üí</div>
                    <% } %>
                    <div class="evolution-stage">
                        <div class="evolution-image">
                            <img src="<%= evo.image || '/images/default_mon.png' %>" alt="<%= evo.name || 'Future Evolution' %>">
                        </div>
                        <div class="evolution-name"><%= evo.name || 'Future Evolution' %></div>
                        <% if (evo.condition) { %>
                        <div class="evolution-condition"><%= evo.condition %></div>
                        <% } %>
                    </div>
                    <% if (i < futureEvolutions.length - 1) { %>
                    <div class="evolution-arrow">‚Üí</div>
                    <% } %>
                    <% } %>

                    <% if (preEvolutions.length === 0 && futureEvolutions.length === 0) { %>
                    <div class="no-evolution-message">This monster has no recorded evolution chain.</div>
                    <% } %>
                </div>
            </div>

            <!-- Biography Section -->
            <% if (monster.bio || monster.tldr) { %>
            <div id="biography" class="biography-section">
                <h2 class="text-3xl font-display font-bold mb-4">Biography</h2>

                <% if (monster.tldr) { %>
                <div class="tldr-section mb-4">
                    <h3 class="text-xl font-display font-bold mb-2">TL;DR</h3>
                    <p><%= monster.tldr %></p>
                </div>
                <% } %>

                <% if (monster.bio) { %>
                <div class="bio-content">
                    <%= monster.bio %>
                </div>
                <% } else { %>
                <div class="bio-content">
                    No detailed biography available for this monster yet.
                </div>
                <% } %>
            </div>
            <% } %>

            <!-- Additional Information Section -->
            <% if (monster.gender || monster.pronouns || monster.nature || monster.characteristic ||
                  monster.fav_berry || monster.held_item || monster.seal || monster.mark ||
                  monster.date_met || monster.where_met || monster.height || monster.acquired ||
                  monster.poke_ball || monster.talk || monster.friendship) { %>
            <div id="additional-info" class="additional-info-section">
                <h2 class="text-3xl font-display font-bold mb-4">Additional Information</h2>
                <div class="info-grid">
                    <% if (monster.gender) { %>
                    <div class="info-item">
                        <label>Gender</label>
                        <span><%= monster.gender %></span>
                    </div>
                    <% } %>

                    <% if (monster.pronouns) { %>
                    <div class="info-item">
                        <label>Pronouns</label>
                        <span><%= monster.pronouns %></span>
                    </div>
                    <% } %>

                    <% if (monster.nature) { %>
                    <div class="info-item">
                        <label>Nature</label>
                        <span><%= monster.nature %></span>
                    </div>
                    <% } %>

                    <% if (monster.characteristic) { %>
                    <div class="info-item">
                        <label>Characteristic</label>
                        <span><%= monster.characteristic %></span>
                    </div>
                    <% } %>

                    <% if (monster.friendship) { %>
                    <div class="info-item">
                        <label>Friendship</label>
                        <span><%= monster.friendship %></span>
                    </div>
                    <% } %>

                    <% if (monster.fav_berry) { %>
                    <div class="info-item">
                        <label>Favorite Berry</label>
                        <span><%= monster.fav_berry %></span>
                    </div>
                    <% } %>

                    <% if (monster.held_item) { %>
                    <div class="info-item">
                        <label>Held Item</label>
                        <span><%= monster.held_item %></span>
                    </div>
                    <% } %>

                    <% if (monster.seal) { %>
                    <div class="info-item">
                        <label>Seal</label>
                        <span><%= monster.seal %></span>
                    </div>
                    <% } %>

                    <% if (monster.mark) { %>
                    <div class="info-item">
                        <label>Mark</label>
                        <span><%= monster.mark %></span>
                    </div>
                    <% } %>

                    <% if (monster.height) { %>
                    <div class="info-item">
                        <label>Height</label>
                        <span><%= monster.height %></span>
                    </div>
                    <% } %>

                    <% if (monster.acquired) { %>
                    <div class="info-item">
                        <label>Acquired</label>
                        <span><%= monster.acquired %></span>
                    </div>
                    <% } %>

                    <% if (monster.poke_ball) { %>
                    <div class="info-item">
                        <label>Pok√© Ball</label>
                        <span><%= monster.poke_ball %></span>
                    </div>
                    <% } %>

                    <% if (monster.date_met) { %>
                    <div class="info-item">
                        <label>Date Met</label>
                        <span><%= monster.date_met %></span>
                    </div>
                    <% } %>

                    <% if (monster.where_met) { %>
                    <div class="info-item">
                        <label>Where Met</label>
                        <span><%= monster.where_met %></span>
                    </div>
                    <% } %>
                </div>

                <% if (monster.talk) { %>
                <div class="talk-section mt-4">
                    <label class="block mb-2 font-bold">Catchphrase</label>
                    <div class="talk-bubble">
                        "<%= monster.talk %>"
                    </div>
                </div>
                <% } %>
            </div>
            <% } %>

            <!-- Special Features Section -->
            <% if (monster.shiny || monster.alpha || monster.shadow || monster.paradox ||
                  monster.pokerus || monster.mega_stone) { %>
            <div id="special-features" class="special-features-section">
                <h2 class="text-3xl font-display font-bold mb-4">Special Features</h2>
                <div class="special-features-grid">
                    <% if (monster.shiny) { %>
                    <div class="special-feature">
                        <div class="feature-icon shiny">‚ú®</div>
                        <div class="feature-name">Shiny</div>
                    </div>
                    <% } %>

                    <% if (monster.alpha) { %>
                    <div class="special-feature">
                        <div class="feature-icon alpha">Œ±</div>
                        <div class="feature-name">Alpha</div>
                    </div>
                    <% } %>

                    <% if (monster.shadow) { %>
                    <div class="special-feature">
                        <div class="feature-icon shadow">üåë</div>
                        <div class="feature-name">Shadow</div>
                    </div>
                    <% } %>

                    <% if (monster.paradox) { %>
                    <div class="special-feature">
                        <div class="feature-icon paradox">‚è≥</div>
                        <div class="feature-name">Paradox <%= monster.paradox_type ? `(${monster.paradox_type})` : '' %></div>
                    </div>
                    <% } %>

                    <% if (monster.pokerus) { %>
                    <div class="special-feature">
                        <div class="feature-icon pokerus">ü¶†</div>
                        <div class="feature-name">Pok√©rus</div>
                    </div>
                    <% } %>
                </div>

                <% if (monster.mega_stone) { %>
                <div class="mega-evolution-info mt-4">
                    <h3 class="text-xl font-display font-bold mb-2">Mega Evolution</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Mega Stone</label>
                            <span><%= monster.mega_stone %></span>
                        </div>

                        <% if (monster.mega_ability) { %>
                        <div class="info-item">
                            <label>Mega Ability</label>
                            <span><%= monster.mega_ability %></span>
                        </div>
                        <% } %>

                        <% if (monster.mega_stat_bonus) { %>
                        <div class="info-item">
                            <label>Stat Bonus</label>
                            <span><%= monster.mega_stat_bonus %></span>
                        </div>
                        <% } %>
                    </div>

                    <% if (monster.mega_image) { %>
                    <div class="mega-image-container mt-4">
                        <img src="<%= monster.mega_image %>" alt="<%= monster.name %> Mega Evolution" class="mega-image">
                    </div>
                    <% } %>

                    <% if (monster.mega_type1 || monster.mega_type2 || monster.mega_type3 ||
                          monster.mega_type4 || monster.mega_type5 || monster.mega_type6) { %>
                    <div class="mega-types mt-4">
                        <label class="block mb-2 font-bold">Mega Types</label>
                        <div class="type-list">
                            <% if (monster.mega_type1) { %>
                            <span class="type <%= monster.mega_type1.toLowerCase() %>"><%= monster.mega_type1 %></span>
                            <% } %>
                            <% if (monster.mega_type2) { %>
                            <span class="type <%= monster.mega_type2.toLowerCase() %>"><%= monster.mega_type2 %></span>
                            <% } %>
                            <% if (monster.mega_type3) { %>
                            <span class="type <%= monster.mega_type3.toLowerCase() %>"><%= monster.mega_type3 %></span>
                            <% } %>
                            <% if (monster.mega_type4) { %>
                            <span class="type <%= monster.mega_type4.toLowerCase() %>"><%= monster.mega_type4 %></span>
                            <% } %>
                            <% if (monster.mega_type5) { %>
                            <span class="type <%= monster.mega_type5.toLowerCase() %>"><%= monster.mega_type5 %></span>
                            <% } %>
                            <% if (monster.mega_type6) { %>
                            <span class="type <%= monster.mega_type6.toLowerCase() %>"><%= monster.mega_type6 %></span>
                            <% } %>
                        </div>
                    </div>
                    <% } %>
                </div>
                <% } %>
            </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    // Function to update active sidebar link based on scroll position
    function updateActiveSidebarLink() {
        const sections = document.querySelectorAll('div[id]');
        const scrollPosition = window.scrollY + 100; // Add offset for better UX

        // Find the current section
        let currentSection = '';
        sections.forEach(section => {
            if (section.offsetTop <= scrollPosition) {
                currentSection = section.getAttribute('id');
            }
        });

        // Remove active class from all links
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.remove('active');
        });

        // Add active class to current section link
        if (currentSection) {
            const activeLink = document.querySelector(`.sidebar-link[href="#${currentSection}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            } else if (currentSection === 'profile') {
                // Default to profile if no matching link
                document.querySelector('.sidebar-link[href="#"]').classList.add('active');
            }
        } else {
            // Default to profile if no section is active
            document.querySelector('.sidebar-link[href="#"]').classList.add('active');
        }
    }

    // Add smooth scrolling to all sidebar links
    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', function(e) {
            // Skip for links that go to other pages
            if (this.getAttribute('href').startsWith('#')) {
                e.preventDefault();

                const targetId = this.getAttribute('href').substring(1);
                let targetElement;

                if (targetId === '') {
                    // For the Profile link with just '#'
                    targetElement = document.getElementById('profile');
                } else {
                    targetElement = document.getElementById(targetId);
                }

                if (targetElement) {
                    window.scrollTo({
                        top: targetElement.offsetTop - 20,
                        behavior: 'smooth'
                    });

                    // Update URL hash without scrolling
                    history.pushState(null, null, this.getAttribute('href'));

                    // Update active link
                    document.querySelectorAll('.sidebar-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    this.classList.add('active');
                }
            }
        });
    });

    // Update active link on scroll
    window.addEventListener('scroll', updateActiveSidebarLink);

    // Update active link on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateActiveSidebarLink();

        // If there's a hash in the URL, scroll to that section
        if (window.location.hash) {
            const targetElement = document.getElementById(window.location.hash.substring(1));
            if (targetElement) {
                setTimeout(() => {
                    window.scrollTo({
                        top: targetElement.offsetTop - 20,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
    });
</script>