<% /* Set the title and other variables for the layout */ %>
<% title = shop.name %>

<div class="container mx-auto px-4">
  <div>
    <img src="<%= shop.image_url || 'https://i.imgur.com/DP1nFn2.png' %>" alt="<%= shop.name %>" class="location-banner w-full object-cover rounded-lg shadow-lg">
    <div class="flex flex-col items-center">
      <div class="flex items-center mb-4 w-full">
        <a href="/town" class="btn-secondary mr-4 hover:scale-105 transition-transform">
          <i class="fas fa-arrow-left mr-2"></i> Back to Markets
        </a>
        <h2 class="text-2xl font-display font-bold text-center text-amber-400 text-shadow-lg"><%= shop.name %></h2>
      </div>
      <p class="text-center text-sm text-gray-200 mb-4"><%= shop.description %></p>

      <div class="flex flex-wrap items-center justify-center gap-4 mb-6">
        <span class="badge badge-<%= getCategoryBadgeColor(shop.category) %> px-3 py-1 rounded-full text-xs font-medium bg-opacity-80">
          <i class="fas fa-tag mr-1"></i> <%= formatCategory(shop.category) %>
        </span>
        <span class="badge bg-gray-700/70 px-3 py-1 rounded-full text-xs font-medium">
          <i class="fas fa-sync-alt mr-1"></i> Restocks Daily
        </span>
        <div class="badge bg-amber-700/80 px-3 py-1 rounded-full text-xs font-medium flex items-center">
          <i class="fas fa-coins text-yellow-400 mr-1"></i>
          <span class="font-bold text-amber-300"><%= trainer.currency_amount %> Coins</span>
        </div>
      </div>

      <% if (typeof message !== 'undefined' && message) { %>
      <div class="alert alert-<%= messageType || 'success' %> text-center mt-2 max-w-2xl mx-auto text-sm">
        <%= message %>
      </div>
      <% } %>
    </div>
  </div>

<main class="container mx-auto px-4 pb-16">

  <% if (items.length === 0) { %>
    <div class="text-center py-12 bg-gray-800/80 rounded-xl border border-gray-700 shadow-lg">
      <div class="text-6xl text-gray-600 mb-4"><i class="fas fa-store-slash"></i></div>
      <h2 class="text-2xl font-bold mb-4 text-amber-400">No items available today</h2>
      <p class="text-gray-400 mb-6">This shop is currently out of stock. Please check back tomorrow!</p>
      <div class="flex flex-col sm:flex-row justify-center gap-4">
        <a href="/town" class="inline-block bg-amber-600 hover:bg-amber-500 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300">
          <i class="fas fa-arrow-left mr-2"></i> Return to Town
        </a>
        <a href="/town/shop/<%= shop.shop_id %>/restock" class="inline-block bg-purple-600 hover:bg-purple-500 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300">
          <i class="fas fa-sync-alt mr-2"></i> Force Restock
        </a>
      </div>
    </div>
  <% } else { %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <% items.forEach(item => { %>
        <div class="location-card overflow-hidden transform hover:translate-y-[-5px] transition-all duration-300">
          <div class="relative">
            <div class="w-full h-48 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center overflow-hidden">
              <% if (item.item_image) { %>
                <img src="<%= item.item_image %>" alt="<%= item.item_name %>" class="max-h-40 max-w-[80%] object-contain transform hover:scale-110 transition-transform duration-500">
              <% } else { %>
                <div class="text-5xl text-gray-500"><i class="fas fa-box-open"></i></div>
              <% } %>
              <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>
            </div>
            <div class="absolute top-3 right-3 bg-amber-600/90 text-white px-3 py-1 rounded-full flex items-center shadow-md">
              <i class="fas fa-coins text-yellow-300 mr-1"></i>
              <span class="font-medium"><%= item.price %></span>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-4">
              <h3 class="text-xl font-bold text-white text-shadow-lg"><%= item.item_name %></h3>
            </div>
          </div>
          <div class="location-card-content p-5">
            <p class="text-sm mb-4 text-gray-300 line-clamp-2"><%= item.item_description || 'No description available' %></p>

            <div class="flex justify-between items-center mb-4">
              <span class="badge badge-<%= getRarityBadgeColor(item.item_rarity) %> px-2 py-1 rounded-full text-xs font-medium">
                <i class="fas fa-star mr-1"></i> Rarity: <%= item.item_rarity %>
              </span>
              <span class="badge bg-gray-700/70 px-2 py-1 rounded-full text-xs font-medium">
                <i class="fas fa-cubes mr-1"></i> <%= item.remaining_quantity %>/<%= item.max_quantity %>
              </span>
            </div>

            <form action="/town/shop/<%= shop.shop_id %>/purchase" method="POST" class="purchase-form">
              <input type="hidden" name="item_id" value="<%= item.item_id %>">

              <div class="flex items-center mb-4 bg-gray-700/50 p-2 rounded-lg">
                <label for="quantity-<%= item.item_id %>" class="mr-2 text-gray-300 text-sm">Quantity:</label>
                <div class="relative flex-1">
                  <input
                    type="number"
                    id="quantity-<%= item.item_id %>"
                    name="quantity"
                    min="1"
                    max="<%= item.remaining_quantity %>"
                    value="1"
                    class="form-input w-full bg-gray-800 border border-gray-600 rounded-md text-white text-center"
                    <%= item.remaining_quantity === 0 ? 'disabled' : '' %>
                  >
                </div>
              </div>

              <button
                type="submit"
                class="<%= item.remaining_quantity === 0 ? 'bg-gray-600' : (item.price > trainer.currency_amount ? 'bg-red-700' : 'btn-primary') %> w-full py-2 px-4 rounded-lg text-white font-medium transition-all duration-300 flex items-center justify-center"
                <%= item.remaining_quantity === 0 || item.price > trainer.currency_amount ? 'disabled' : '' %>
              >
                <% if (item.remaining_quantity === 0) { %>
                  <i class="fas fa-times-circle mr-2"></i> Sold Out
                <% } else if (item.price > trainer.currency_amount) { %>
                  <i class="fas fa-coins mr-2"></i> Not Enough Coins
                <% } else { %>
                  <i class="fas fa-shopping-cart mr-2"></i> Purchase
                <% } %>
              </button>
            </form>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</main>

<style>
.text-shadow {
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

.text-shadow-lg {
  text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
}

.badge {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.location-card {
  background-color: var(--card-background);
  border-radius: 0.75rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: transform 0.3s, box-shadow 0.3s;
}

.location-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
}

.location-card-content {
  padding: 1.25rem;
  background-color: var(--card-background);
}

.btn-primary {
  background-color: var(--accent-color);
  color: var(--background-color);
  font-weight: 500;
  transition: all 0.2s;
}

.btn-primary:hover {
  background-color: var(--accent-hover);
  transform: translateY(-2px);
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add purchase form handling
    const purchaseForms = document.querySelectorAll('.purchase-form');

    purchaseForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        const originalContent = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

        // Restore button state if form submission fails
        setTimeout(() => {
          if (submitButton.disabled) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalContent;
          }
        }, 5000);
      });
    });
  });
</script>