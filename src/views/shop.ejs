<% /* Set the title and other variables for the layout */ %>
<% title = shop.name %>

<%
// Determine the item image path
const getItemImagePath = (item, category) => {
  if (item.item_image) {
    // Convert item name to filename format (lowercase, spaces to underscores)
    const itemFileName = item.item_name.toLowerCase().replace(/\s+/g, '_') + '.png';
    return `/images/items/${itemFileName}`;
  }
  // Use category default
  return `/images/items/default_${category.toLowerCase()}.png`;
};
%>

<div class="shop-container">
  <div class="shop-header">
    <div class="shop-banner-container">
      <img src="<%= shop.image_url || 'https://i.imgur.com/DP1nFn2.png' %>" alt="<%= shop.name %>" class="shop-banner">
      <div class="shop-banner-overlay"></div>
    </div>

    <div class="shop-info-container">
      <div class="shop-navigation">
        <a href="/town" class="back-button">
          <i class="fas fa-arrow-left mr-2"></i> Back to Markets
        </a>
        <h2 class="shop-title"><%= shop.name %></h2>
      </div>

      <p class="shop-description"><%= shop.description %></p>

      <div class="shop-badges">
        <span class="shop-badge category-badge badge-<%= getCategoryBadgeColor(shop.category) %>">
          <i class="fas fa-tag mr-1"></i> <%= formatCategory(shop.category) %>
        </span>
        <span class="shop-badge restock-badge">
          <i class="fas fa-sync-alt mr-1"></i> Restocks Daily
        </span>
        <div class="shop-badge currency-badge">
          <i class="fas fa-coins text-yellow-400 mr-1"></i>
          <span class="currency-amount"><%= trainer.currency_amount %> Coins</span>
        </div>
      </div>

      <div class="trainer-selector">
        <label for="trainer-select" class="trainer-select-label">Select Trainer:</label>
        <div class="trainer-select-container">
          <select id="trainer-select" class="trainer-select" onchange="window.location.href='/town/shop/<%= shop.shop_id %>?trainer_id=' + this.value">
            <% trainers.forEach(t => { %>
              <option value="<%= t.id %>" <%= t.id === trainer.id ? 'selected' : '' %>>
                <%= t.name %> (<%= t.currency_amount %> Coins)
              </option>
            <% }); %>
          </select>
        </div>
      </div>

      <% if (typeof message !== 'undefined' && message) { %>
      <div class="shop-alert alert-<%= messageType || 'success' %>">
        <%= message %>
      </div>
      <% } %>
    </div>
  </div>

<main class="shop-main">
  <% if (items.length === 0) { %>
    <div class="empty-shop">
      <div class="empty-shop-icon"><i class="fas fa-store-slash"></i></div>
      <h2 class="empty-shop-title">No items available today</h2>
      <p class="empty-shop-message">This shop is currently out of stock. Please check back tomorrow!</p>
      <div class="empty-shop-actions">
        <a href="/town" class="shop-button return-button">
          <i class="fas fa-arrow-left mr-2"></i> Return to Town
        </a>
        <a href="/town/shop/<%= shop.shop_id %>/restock" class="shop-button restock-button">
          <i class="fas fa-sync-alt mr-2"></i> Force Restock
        </a>
      </div>
    </div>
  <% } else { %>
    <div class="shop-items-grid">
      <% items.forEach(item => { %>
        <div class="shop-item-card">
          <div class="item-image-container">
            <img src="<%= getItemImagePath(item, shop.category) %>"
                 alt="<%= item.item_name %>"
                 class="item-image"
                 onerror="this.onerror=null; this.src='/images/items/default_${shop.category.toLowerCase()}.png'">
            <div class="item-image-overlay"></div>
            <div class="item-price">
              <i class="fas fa-coins text-yellow-300 mr-1"></i>
              <span><%= item.price %></span>
            </div>
            <h3 class="item-name"><%= item.item_name %></h3>
          </div>

          <div class="item-details">
            <p class="item-description"><%= item.item_description || 'No description available' %></p>

            <div class="item-meta">
              <span class="item-badge rarity-badge badge-<%= getRarityBadgeColor(item.item_rarity) %>">
                <i class="fas fa-star mr-1"></i> Rarity: <%= item.item_rarity %>
              </span>
              <span class="item-badge quantity-badge">
                <i class="fas fa-cubes mr-1"></i> <%= item.remaining_quantity %>/<%= item.max_quantity %>
              </span>
            </div>

            <form action="/town/shop/<%= shop.shop_id %>/purchase" method="POST" class="purchase-form">
              <input type="hidden" name="item_id" value="<%= item.item_id %>">
              <input type="hidden" name="trainer_id" value="<%= trainer.id %>">

              <div class="quantity-selector">
                <label for="quantity-<%= item.item_id %>" class="quantity-label">Quantity:</label>
                <div class="quantity-input-container">
                  <input
                    type="number"
                    id="quantity-<%= item.item_id %>"
                    name="quantity"
                    min="1"
                    max="<%= item.remaining_quantity %>"
                    value="1"
                    class="quantity-input"
                    <%= item.remaining_quantity === 0 ? 'disabled' : '' %>
                  >
                </div>
              </div>

              <button
                type="submit"
                class="purchase-button <%= item.remaining_quantity === 0 ? 'sold-out' : (item.price > trainer.currency_amount ? 'insufficient-funds' : '') %>"
                <%= item.remaining_quantity === 0 || item.price > trainer.currency_amount ? 'disabled' : '' %>
              >
                <% if (item.remaining_quantity === 0) { %>
                  <i class="fas fa-times-circle mr-2"></i> Sold Out
                <% } else if (item.price > trainer.currency_amount) { %>
                  <i class="fas fa-coins mr-2"></i> Not Enough Coins
                <% } else { %>
                  <i class="fas fa-shopping-cart mr-2"></i> Purchase
                <% } %>
              </button>
            </form>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</main>

<style>
/* Shop Container and Header Styles */
.shop-container {
  max-width: var(--container-max-width);
  margin: 0 auto;
  padding: 0 var(--content-padding);
}

/* Trainer Selector Styles */
.trainer-selector {
  margin-top: 1rem;
  background-color: var(--card-background);
  border-radius: 0.5rem;
  padding: 0.75rem 1rem;
  border: 1px solid var(--divider-color);
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.trainer-select-label {
  font-weight: 600;
  color: var(--accent-color);
  margin-right: 0.5rem;
}

.trainer-select-container {
  flex: 1;
  min-width: 200px;
}

.trainer-select {
  width: 100%;
  padding: 0.5rem;
  border-radius: 0.25rem;
  border: 1px solid var(--divider-color);
  background-color: var(--background-color);
  color: var(--text-color);
  font-size: 0.9rem;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23d6a339'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.5rem center;
  background-size: 1.5rem;
  cursor: pointer;
}

.trainer-select:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(214, 163, 57, 0.2);
}

.shop-header {
  margin-bottom: 2rem;
  position: relative;
  border-radius: 0.75rem;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.shop-banner-container {
  position: relative;
  height: 200px;
  overflow: hidden;
}

.shop-banner {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s ease;
}

.shop-header:hover .shop-banner {
  transform: scale(1.05);
}

.shop-banner-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.8) 100%);
}

.shop-info-container {
  position: relative;
  padding: 1.5rem;
  background-color: var(--card-background);
  backdrop-filter: blur(10px);
  border-bottom-left-radius: 0.75rem;
  border-bottom-right-radius: 0.75rem;
}

.shop-navigation {
  display: flex;
  align-items: center;
  margin-bottom: 1rem;
  width: 100%;
}

.back-button {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1rem;
  background-color: var(--nav-background);
  color: var(--text-color);
  border-radius: 0.375rem;
  font-weight: 500;
  margin-right: 1rem;
  transition: all 0.2s;
  border: 1px solid var(--divider-color);
}

.back-button:hover {
  transform: translateY(-2px);
  background-color: var(--nav-hover);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.shop-title {
  font-size: var(--font-size-2xl);
  font-weight: 700;
  color: var(--accent-color);
  text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
}

.shop-description {
  text-align: center;
  font-size: var(--font-size-sm);
  color: var(--text-color);
  margin-bottom: 1rem;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

.shop-badges {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}

.shop-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.category-badge {
  background-color: rgba(var(--category-color), 0.8);
}

.restock-badge {
  background-color: var(--nav-background);
}

.currency-badge {
  background-color: rgba(214, 163, 57, 0.3);
  display: inline-flex;
  align-items: center;
}

.currency-amount {
  font-weight: 700;
  color: var(--accent-color);
}

.shop-alert {
  text-align: center;
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  font-size: var(--font-size-sm);
  max-width: 32rem;
  margin: 0 auto;
  animation: fadeIn 0.5s ease-out;
}

.alert-success {
  background-color: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.4);
  color: var(--success-color);
}

.alert-error {
  background-color: rgba(239, 68, 68, 0.2);
  border: 1px solid rgba(239, 68, 68, 0.4);
  color: var(--error-color);
}

/* Main Shop Content Styles */
.shop-main {
  padding-bottom: 4rem;
}

.empty-shop {
  text-align: center;
  padding: 3rem;
  background-color: var(--card-background);
  border-radius: 0.75rem;
  border: 1px solid var(--divider-color);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.empty-shop-icon {
  font-size: 4rem;
  color: var(--divider-color);
  margin-bottom: 1rem;
}

.empty-shop-title {
  font-size: var(--font-size-xl);
  font-weight: 700;
  color: var(--accent-color);
  margin-bottom: 1rem;
}

.empty-shop-message {
  color: var(--text-color);
  margin-bottom: 1.5rem;
  max-width: 24rem;
  margin-left: auto;
  margin-right: auto;
}

.empty-shop-actions {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

@media (min-width: 640px) {
  .empty-shop-actions {
    flex-direction: row;
    justify-content: center;
  }
}

.shop-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.75rem 1.5rem;
  border-radius: 0.375rem;
  font-weight: 500;
  transition: all 0.3s;
}

.return-button {
  background-color: var(--nav-background);
  color: var(--text-color);
  border: 1px solid var(--divider-color);
}

.return-button:hover {
  background-color: var(--nav-hover);
  transform: translateY(-2px);
}

.restock-button {
  background-color: var(--accent-color);
  color: var(--background-color);
}

.restock-button:hover {
  background-color: var(--accent-hover);
  transform: translateY(-2px);
}

/* Shop Items Grid */
.shop-items-grid {
  display: grid;
  grid-template-columns: repeat(1, 1fr);
  gap: 1.5rem;
}

@media (min-width: 768px) {
  .shop-items-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1024px) {
  .shop-items-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Shop Item Card */
.shop-item-card {
  background-color: var(--card-background);
  border-radius: 0.75rem;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: transform 0.3s, box-shadow 0.3s;
  border: 1px solid var(--divider-color);
  display: flex;
  flex-direction: column;
}

.shop-item-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
}

.item-image-container {
  position: relative;
  height: 200px;
  background: linear-gradient(135deg, var(--nav-background), var(--background-color));
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.item-image {
  max-height: 160px;
  max-width: 80%;
  object-fit: contain;
  transition: transform 0.5s;
  z-index: 1;
}

.shop-item-card:hover .item-image {
  transform: scale(1.1);
}

.item-placeholder {
  font-size: 3rem;
  color: var(--divider-color);
}

.item-image-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
  z-index: 2;
}

.item-price {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background-color: rgba(214, 163, 57, 0.8);
  color: var(--background-color);
  padding: 0.5rem 0.75rem;
  border-radius: 9999px;
  display: flex;
  align-items: center;
  font-weight: 500;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  z-index: 3;
}

.item-name {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 1rem;
  font-size: var(--font-size-lg);
  font-weight: 700;
  color: var(--text-color);
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
  z-index: 3;
}

.item-details {
  padding: 1.25rem;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.item-description {
  font-size: var(--font-size-sm);
  color: var(--text-color);
  margin-bottom: 1rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.item-meta {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.item-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.rarity-badge {
  background-color: var(--rarity-color, var(--nav-background));
}

.quantity-badge {
  background-color: var(--nav-background);
}

.purchase-form {
  margin-top: auto;
}

.quantity-selector {
  display: flex;
  align-items: center;
  margin-bottom: 1rem;
  background-color: var(--input-background);
  padding: 0.5rem;
  border-radius: 0.5rem;
}

.quantity-label {
  margin-right: 0.5rem;
  color: var(--text-color);
  font-size: var(--font-size-sm);
}

.quantity-input-container {
  position: relative;
  flex-grow: 1;
}

.quantity-input {
  width: 100%;
  background-color: var(--background-color);
  border: 1px solid var(--divider-color);
  border-radius: 0.375rem;
  color: var(--text-color);
  text-align: center;
  padding: 0.375rem;
}

.purchase-button {
  width: 100%;
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  color: var(--background-color);
  font-weight: 500;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--accent-color);
}

.purchase-button:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  background-color: var(--accent-hover);
}

.purchase-button.sold-out {
  background-color: var(--divider-color);
}

.purchase-button.insufficient-funds {
  background-color: var(--error-color);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add purchase form handling with enhanced UX
    const purchaseForms = document.querySelectorAll('.purchase-form');

    purchaseForms.forEach(form => {
      // Add quantity controls
      const quantityInput = form.querySelector('input[type="number"]');
      if (quantityInput && !quantityInput.disabled) {
        // Create quantity controls
        const decrementBtn = document.createElement('button');
        decrementBtn.type = 'button';
        decrementBtn.className = 'quantity-btn decrement';
        decrementBtn.innerHTML = '<i class="fas fa-minus"></i>';
        decrementBtn.addEventListener('click', () => {
          const currentVal = parseInt(quantityInput.value);
          if (currentVal > parseInt(quantityInput.min)) {
            quantityInput.value = currentVal - 1;
          }
        });

        const incrementBtn = document.createElement('button');
        incrementBtn.type = 'button';
        incrementBtn.className = 'quantity-btn increment';
        incrementBtn.innerHTML = '<i class="fas fa-plus"></i>';
        incrementBtn.addEventListener('click', () => {
          const currentVal = parseInt(quantityInput.value);
          if (currentVal < parseInt(quantityInput.max)) {
            quantityInput.value = currentVal + 1;
          }
        });

        // Add the buttons to the DOM
        const inputContainer = quantityInput.parentElement;
        inputContainer.classList.add('quantity-with-controls');
        inputContainer.insertBefore(decrementBtn, quantityInput);
        inputContainer.appendChild(incrementBtn);
      }

      // Handle form submission with animation
      form.addEventListener('submit', function(e) {
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        const originalContent = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

        // Add a subtle animation to the card
        const card = this.closest('.shop-item-card');
        card.classList.add('processing');

        // Restore button state if form submission fails
        setTimeout(() => {
          if (submitButton.disabled) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalContent;
            card.classList.remove('processing');
          }
        }, 5000);
      });
    });

    // Add hover effects for item cards
    const itemCards = document.querySelectorAll('.shop-item-card');
    itemCards.forEach(card => {
      card.addEventListener('mouseenter', () => {
        card.classList.add('card-hover');
      });
      card.addEventListener('mouseleave', () => {
        card.classList.remove('card-hover');
      });
    });

    // Add fade-in animation for shop items
    const shopItems = document.querySelectorAll('.shop-item-card');
    shopItems.forEach((item, index) => {
      item.style.opacity = '0';
      item.style.transform = 'translateY(20px)';
      item.style.transition = 'opacity 0.5s ease, transform 0.5s ease';

      setTimeout(() => {
        item.style.opacity = '1';
        item.style.transform = 'translateY(0)';
      }, 100 + (index * 100)); // Stagger the animations
    });
  });
</script>

<style>
  /* Additional styles for the enhanced shop experience */
  .quantity-with-controls {
    display: flex;
    align-items: center;
  }

  .quantity-btn {
    background-color: var(--nav-background);
    border: 1px solid var(--divider-color);
    color: var(--text-color);
    width: 28px;
    height: 28px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .quantity-btn:hover {
    background-color: var(--nav-hover);
  }

  .quantity-btn.decrement {
    margin-right: 5px;
  }

  .quantity-btn.increment {
    margin-left: 5px;
  }

  .processing {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(214, 163, 57, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(214, 163, 57, 0); }
    100% { box-shadow: 0 0 0 0 rgba(214, 163, 57, 0); }
  }

  .card-hover {
    transform: translateY(-8px);
  }
</style>
