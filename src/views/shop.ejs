<% /* Set the title and other variables for the layout */ %>
<% title = shop.name %>

<div class="py-16 bg-gradient-to-b from-gray-900 to-gray-800">
  <div class="container mx-auto px-4">
    <div class="flex items-center mb-8">
      <a href="/town" class="btn-secondary mr-4 hover:scale-105 transition-transform">‚Üê Back to Town</a>
      <h1 class="text-4xl font-display font-bold text-amber-400 text-shadow"><%= shop.name %></h1>
    </div>

    <div class="flex flex-col md:flex-row gap-8 mb-12 bg-gray-800/50 p-6 rounded-xl shadow-xl backdrop-blur-sm border border-gray-700">
      <div class="md:w-1/3">
        <img src="<%= shop.image_url %>" alt="<%= shop.name %>" class="w-full h-64 object-cover rounded-lg shadow-lg transform hover:scale-[1.02] transition-transform duration-300">
      </div>
      <div class="md:w-2/3">
        <p class="text-lg mb-4 text-gray-300"><%= shop.description %></p>
        <div class="flex items-center mb-4">
          <span class="badge badge-<%= getCategoryBadgeColor(shop.category) %> mr-2 px-3 py-1 rounded-full text-sm font-medium"><%= formatCategory(shop.category) %></span>
          <span class="text-sm text-gray-400"><i class="fas fa-sync-alt mr-1"></i> Items restock daily</span>
        </div>
        <div class="flex items-center">
          <div class="bg-gray-700/70 px-4 py-2 rounded-lg shadow-inner flex items-center">
            <span class="text-sm text-gray-300 mr-2">Your Coins:</span>
            <div class="flex items-center">
              <i class="fas fa-coins text-yellow-400 mr-1"></i>
              <span class="font-bold text-amber-300"><%= trainer.currency_amount %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert alert-<%= messageType || 'success' %> mb-8">
      <%= message %>
    </div>
    <% } %>
  </div>
</div>

<main class="container mx-auto px-4 pb-16">
  <!-- Debug info -->
  <% if (typeof items !== 'undefined') { %>
    <div class="bg-gray-900 p-4 mb-6 rounded-lg text-xs">
      <pre><%= JSON.stringify({itemsLength: items.length, items: items}, null, 2) %></pre>
    </div>
  <% } %>
  <% if (items.length === 0) { %>
    <div class="text-center py-12 bg-gray-800/80 rounded-xl border border-gray-700 shadow-lg">
      <div class="text-6xl text-gray-600 mb-4"><i class="fas fa-store-slash"></i></div>
      <h2 class="text-2xl font-bold mb-4 text-amber-400">No items available today</h2>
      <p class="text-gray-400 mb-6">This shop is currently out of stock. Please check back tomorrow!</p>
      <div class="flex flex-col sm:flex-row justify-center gap-4">
        <a href="/town" class="inline-block bg-amber-600 hover:bg-amber-500 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300">
          <i class="fas fa-arrow-left mr-2"></i> Return to Town
        </a>
        <a href="/town/shop/<%= shop.shop_id %>/restock" class="inline-block bg-purple-600 hover:bg-purple-500 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300">
          <i class="fas fa-sync-alt mr-2"></i> Force Restock
        </a>
      </div>
    </div>
  <% } else { %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <% items.forEach(item => { %>
        <div class="card bg-gray-800/80 border border-gray-700 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:translate-y-[-5px] transition-transform">
          <div class="relative">
            <div class="w-full h-48 bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
              <% if (item.item_image) { %>
                <img src="<%= item.item_image %>" alt="<%= item.item_name %>" class="max-h-40 max-w-[80%] object-contain">
              <% } else { %>
                <div class="text-5xl text-gray-500"><i class="fas fa-box-open"></i></div>
              <% } %>
            </div>
            <div class="absolute top-2 right-2 bg-amber-600/90 text-white px-3 py-1 rounded-full flex items-center shadow-md">
              <i class="fas fa-coins text-yellow-300 mr-1"></i>
              <span class="font-medium"><%= item.price %></span>
            </div>
          </div>
          <div class="card-body p-5">
            <h3 class="text-xl font-bold mb-2 text-amber-300"><%= item.item_name %></h3>
            <p class="text-sm mb-4 text-gray-300"><%= item.item_description || 'No description available' %></p>

            <div class="flex justify-between items-center mb-4">
              <span class="badge badge-<%= getRarityBadgeColor(item.item_rarity) %> px-2 py-1 rounded-md text-xs font-medium">
                <i class="fas fa-star mr-1"></i> Rarity: <%= item.item_rarity %>
              </span>
              <span class="text-sm bg-gray-700/70 px-2 py-1 rounded-md">
                <i class="fas fa-cubes mr-1"></i> <%= item.remaining_quantity %>/<%= item.max_quantity %>
              </span>
            </div>

            <form action="/town/shop/<%= shop.shop_id %>/purchase" method="POST" class="purchase-form">
              <input type="hidden" name="item_id" value="<%= item.item_id %>">

              <div class="flex items-center mb-4 bg-gray-700/50 p-2 rounded-lg">
                <label for="quantity-<%= item.item_id %>" class="mr-2 text-gray-300">Quantity:</label>
                <input
                  type="number"
                  id="quantity-<%= item.item_id %>"
                  name="quantity"
                  min="1"
                  max="<%= item.remaining_quantity %>"
                  value="1"
                  class="form-input w-20 bg-gray-800 border-gray-600 text-white"
                  <%= item.remaining_quantity === 0 ? 'disabled' : '' %>
                >
              </div>

              <button
                type="submit"
                class="<%= item.remaining_quantity === 0 ? 'bg-gray-600' : (item.price > trainer.currency_amount ? 'bg-red-700' : 'bg-amber-600 hover:bg-amber-500') %> w-full py-2 px-4 rounded-lg text-white font-medium transition-colors duration-300 flex items-center justify-center"
                <%= item.remaining_quantity === 0 || item.price > trainer.currency_amount ? 'disabled' : '' %>
              >
                <% if (item.remaining_quantity === 0) { %>
                  <i class="fas fa-times-circle mr-2"></i> Sold Out
                <% } else if (item.price > trainer.currency_amount) { %>
                  <i class="fas fa-coins mr-2"></i> Not Enough Coins
                <% } else { %>
                  <i class="fas fa-shopping-cart mr-2"></i> Purchase
                <% } %>
              </button>
            </form>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add purchase form handling
    const purchaseForms = document.querySelectorAll('.purchase-form');

    purchaseForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';
      });
    });
  });
</script>