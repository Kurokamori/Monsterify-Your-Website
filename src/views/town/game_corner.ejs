<% /* Set the title and other variables for the layout */ %>
<% title = 'Pomodoro Game Corner' %>

<!-- Main Container -->
<div class="container mx-auto px-4" style="min-height: 90vh;">
  <div class="flex items-center mb-4 w-full justify-between">
    <a href="/town/visit" class="btn-secondary mr-4 hover:scale-105 transition-transform">
      <i class="fas fa-arrow-left mr-2"></i> Back to Town
    </a>

    <div class="">
      <button id="test-js" class="btn-secondary mr-2" onclick="alert('JavaScript is working!');">Test JS</button>
      <button id="test-timer" class="btn-secondary mr-2" onclick="startTimerGlobal();">Test Timer</button>
      <button id="test-assessment-modal" class="btn-secondary mr-2" onclick="console.log('Test assessment button clicked'); document.getElementById('work-assessment-modal').style.display = 'flex';">Test Assessment Modal</button>
      <button id="test-rewards-modal" class="btn-primary" onclick="console.log('Test rewards button clicked'); document.getElementById('rewards-container').style.display = 'flex';">Test Rewards Modal</button>
      <button id="test-rewards-100" class="btn-primary ml-2" onclick="console.log('Test 100% rewards button clicked'); showRewards(100);">Test 100% Rewards</button>
    </div>
  </div>

  <!-- Message notification section -->
  <% if (typeof message !== 'undefined' && message) { %>
    <div class="notification <%= messageType === 'error' ? 'bg-red-800/70' : 'bg-green-800/70' %> text-white p-4 rounded-lg mb-4 flex items-center justify-between">
      <div>
        <i class="<%= messageType === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle' %> mr-2"></i>
        <%= message %>
      </div>
      <button class="text-white hover:text-gray-200" onclick="this.parentElement.style.display='none'">
        <i class="fas fa-times"></i>
      </button>
    </div>
  <% } %>

  <!-- Main Content Area with Collapsible Sections -->
  <div class="w-full max-w-screen-2xl mx-auto px-4">
    <!-- Grid Container with fixed height -->
    <div class="grid grid-cols-4 gap-6" style="min-height: 80vh;">
      <!-- Video Player Section (75%) -->
      <div class="col-span-3">
        <div class="bg-gray-800 rounded-lg shadow-lg h-full flex flex-col">
          <div class="flex justify-between items-center p-4" id="video-header">
            <h3 class="text-xl font-bold text-white">Pomodoro Videos</h3>
            <div class="flex items-center space-x-3">
              <button id="expand-video" class="btn-secondary p-2">
                <i class="fas fa-expand-alt"></i>
              </button>
              <button id="collapse-video" class="btn-secondary p-2 hidden">
                <i class="fas fa-compress-alt"></i>
              </button>
            </div>
          </div>
          <div id="video-content" class="flex-grow">
            <div class="relative h-full">
              <div id="video-container" class="w-full h-full bg-gray-900 relative">
                <!-- Loading indicator -->
                <div id="video-loading" class="absolute inset-0 flex items-center justify-center z-10 bg-gray-900/80">
                  <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-amber-400 mb-2"></i>
                    <p class="text-gray-300">Loading video...</p>
                  </div>
                </div>
                <iframe id="youtube-player" class="w-full h-full relative z-0" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen onload="document.getElementById('video-loading').style.display='none';" enablejsapi="1"></iframe>
              </div>
              <div class="video-controls p-4 bg-gray-800/80 absolute bottom-0 left-0 right-0">
                <div class="flex flex-col space-y-2">
                  <div class="flex justify-between items-center">
                    <div>
                      <button id="mute-toggle" class="btn-secondary p-2" onclick="toggleMute()">
                        <i class="fas fa-volume-mute" id="volume-icon"></i>
                      </button>
                    </div>
                    <div>
                      <select id="video-selector" class="w-48" onchange="changeVideo(this.value)">
                        <option value="">Select a video</option>
                        <option value="https://www.youtube.com/embed/5qap5aO4i9A">Lofi Hip Hop Radio - Beats to Relax/Study</option>
                        <option value="https://www.youtube.com/embed/DWcJFNfaw9c">Relaxing Music with Nature Sounds</option>
                        <option value="https://www.youtube.com/embed/n61ULEU7CO0">Study with Me - 4 Hour Study Session</option>
                        <option value="https://www.youtube.com/embed/neV3EPgvZ3g">Relaxing Jazz Music</option>
                        <option value="https://www.youtube.com/embed/tNkZsRW7h2c">Ambient Study Music</option>
                      </select>
                    </div>
                  </div>
                  <div class="flex items-center space-x-2 mt-2 bg-gray-700/50 p-2 rounded">
                    <input type="text" id="custom-youtube-url" placeholder="Enter YouTube URL" class="flex-grow bg-gray-800 text-white border border-gray-600 rounded px-2 py-1">
                    <button id="load-custom-video" class="btn-primary py-1 px-3 text-xs" onclick="loadCustomVideo()">Load</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timer Section (25%) -->
      <div class="col-span-1">
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl overflow-hidden h-full flex flex-col">
          <!-- Timer Display with Progress Circle -->
          <div class="p-5">
            <!-- Progress Circle Container -->
            <div class="relative w-full aspect-square max-w-[160px] mx-auto mb-6 flex items-center justify-center progress-circle-container">
              <!-- SVG Progress Circle -->
              <svg class="w-full h-full -rotate-90" viewBox="0 0 100 100">
                <!-- Background Circle -->
                <circle
                  cx="50" cy="50" r="40"
                  fill="none"
                  stroke="rgba(255,255,255,0.1)"
                  stroke-width="8"
                />
                <!-- Progress Circle -->
                <circle
                  id="progress-circle"
                  cx="50" cy="50" r="40"
                  fill="none"
                  stroke="#8B5CF6"
                  stroke-width="8"
                  stroke-linecap="round"
                  stroke-dasharray="251.3"
                  stroke-dashoffset="251.3"
                />
              </svg>

              <!-- Timer Display -->
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center w-full px-2">
                  <div class="text-3xl font-bold text-amber-400 font-mono tracking-wider mb-1 text-center mx-auto" id="timer-display">25:00</div>
                  <div class="text-xs text-amber-300 text-center mx-auto" id="session-info">Session 0/4</div>
                  <div class="text-xs text-amber-300/80 text-center mx-auto mt-1" id="timer-status">Ready to start</div>
                </div>
              </div>
            </div>

            <!-- Timer Status Spacer -->
            <div class="mb-4"></div>

            <!-- Timer Controls -->
            <div class="flex justify-between w-full space-x-2">
              <button id="start-timer" class="btn-primary h-10 text-sm flex-1 flex items-center justify-center" onclick="startTimerGlobal()">
                <i class="fas fa-play mr-1"></i>Start
              </button>
              <button id="pause-timer" class="btn-secondary h-10 text-sm flex-1 flex items-center justify-center" disabled onclick="pauseTimerGlobal()">
                <i class="fas fa-pause mr-1"></i>Pause
              </button>
              <button id="reset-timer" class="btn-danger h-10 text-sm flex-1 flex items-center justify-center" disabled onclick="resetTimerGlobal()">
                <i class="fas fa-undo mr-1"></i>Reset
              </button>
            </div>
          </div>

          <!-- Timer Settings -->
          <div class="border-t border-gray-700">
            <div class="px-4 py-3 space-y-3 bg-gray-800/30">
              <!-- Focus Duration -->
              <div class="form-group">
                <label for="focus-duration">Focus Duration (minutes)</label>
                <div class="flex items-center space-x-2">
                  <button id="decrease-focus" class="btn-secondary w-8 h-8 p-0 flex items-center justify-center" onclick="decreaseFocusDuration()">-</button>
                  <input type="number" id="focus-duration" value="25" min="1" max="60" step="1" class="text-center w-16" onchange="updateFocusDurationGlobal()">
                  <button id="increase-focus" class="btn-secondary w-8 h-8 p-0 flex items-center justify-center" onclick="increaseFocusDuration()">+</button>
                </div>
              </div>

              <!-- Break Duration -->
              <div class="form-group">
                <label for="break-duration">Break Duration (minutes)</label>
                <div class="flex items-center space-x-2">
                  <button id="decrease-break" class="btn-secondary w-8 h-8 p-0 flex items-center justify-center" onclick="decreaseBreakDuration()">-</button>
                  <input type="number" id="break-duration" value="5" min="1" max="30" step="1" class="text-center w-16" onchange="updateBreakDurationGlobal()">
                  <button id="increase-break" class="btn-secondary w-8 h-8 p-0 flex items-center justify-center" onclick="increaseBreakDuration()">+</button>
                </div>
              </div>

              <!-- Number of Sessions -->
              <div class="form-group">
                <label for="num-sessions">Number of Sessions</label>
                <div class="flex items-center space-x-2">
                  <button id="decrease-sessions" class="btn-secondary w-8 h-8 p-0 flex items-center justify-center" onclick="decreaseSessionsCount()">-</button>
                  <input type="number" id="num-sessions" value="4" min="1" max="10" step="1" class="text-center w-16" onchange="updateSessionsCountGlobal()">
                  <button id="increase-sessions" class="btn-secondary w-8 h-8 p-0 flex items-center justify-center" onclick="increaseSessionsCount()">+</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rewards Modal - Initially hidden -->
  <div id="rewards-container" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[1000] hidden" style="display: none;">
    <div class="bg-gray-900/95 rounded-xl shadow-2xl max-w-2xl w-full border border-amber-500/20 backdrop-blur-sm mx-auto transform transition-all duration-300 scale-100 animate-fadeIn max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header with gradient background -->
      <div class="relative bg-gradient-to-r from-amber-900/50 to-purple-900/50 p-3 border-b border-amber-500/20">
        <div class="absolute inset-0 bg-[url('https://i.imgur.com/XlGrD6J.jpeg')] opacity-20 bg-cover bg-center mix-blend-overlay"></div>
        <div class="flex justify-between items-center relative z-10">
          <div class="flex items-center">
            <div class="bg-amber-500 rounded-full p-1.5 mr-2 shadow-lg shadow-amber-500/20">
              <i class="fas fa-trophy text-gray-900 text-sm"></i>
            </div>
            <h3 class="text-lg font-bold text-white text-shadow-lg">Pomodoro Rewards</h3>
          </div>
          <button id="close-rewards-btn" class="bg-gray-800/50 hover:bg-gray-700/50 text-gray-300 hover:text-white rounded-full p-1.5 transition-all duration-200 transform hover:scale-105" onclick="console.log('Close rewards button clicked'); document.getElementById('rewards-container').style.display = 'none'; startBreakTimer();">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Scrollable content area -->
      <div class="overflow-y-auto custom-scrollbar p-2 space-y-2 flex-grow" style="max-height: calc(90vh - 110px);">
        <!-- Session Summary with visual indicators -->
        <div class="flex items-center justify-between bg-gradient-to-r from-gray-800/80 to-gray-900/80 rounded-lg p-2 border border-gray-700/50 shadow-inner">
          <div class="flex items-center">
            <div class="bg-purple-600/20 rounded-full p-2 mr-2">
              <i class="fas fa-clock text-purple-400 text-xs"></i>
            </div>
            <div>
              <h4 class="text-white text-sm font-medium">Session Summary</h4>
              <p class="text-xs text-gray-400">Great work!</p>
            </div>
          </div>
          <div class="flex space-x-3">
            <div class="text-center">
              <div class="text-base font-bold text-white" id="completed-sessions">0</div>
              <div class="text-xs text-gray-400">Sessions</div>
            </div>
            <div class="text-center">
              <div class="text-base font-bold text-white" id="focus-minutes">0</div>
              <div class="text-xs text-gray-400">Minutes</div>
            </div>
            <div class="text-center">
              <div class="text-base font-bold text-amber-400" id="productivity-score">0%</div>
              <div class="text-xs text-gray-400">Productivity</div>
            </div>
          </div>
        </div>



        <!-- Rewards Section -->
        <div class="bg-gradient-to-r from-gray-800/80 to-gray-900/80 rounded-lg p-2 border border-gray-700/50 shadow-inner">
          <div class="flex items-center mb-2">
            <div class="bg-amber-600/20 rounded-full p-1.5 mr-2">
              <i class="fas fa-gift text-amber-400 text-xs"></i>
            </div>
            <h4 class="text-white text-sm font-medium">Trainers Receiving Rewards</h4>
          </div>
          <p class="text-xs text-gray-400 mb-2">Based on your performance, these trainers have earned rewards:</p>
          <div id="rewards-list" class="space-y-2 max-h-[160px] overflow-y-auto custom-scrollbar pr-1">
            <!-- Rewards will be dynamically inserted here -->
            <div id="rewards-loading" class="text-center text-gray-400 py-2 flex flex-col items-center justify-center">
              <i class="fas fa-spinner fa-spin text-sm"></i>
              <p class="mt-1 text-xs">Rolling rewards...</p>
            </div>
            <div id="rewards-placeholder" class="hidden">
              <div class="text-center py-4">
                <i class="fas fa-gift text-amber-400 text-3xl mb-2"></i>
                <p class="text-gray-400">Your rewards will appear here</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Monster Encounter Section -->
        <div id="monster-encounter-container" class="hidden bg-gradient-to-r from-gray-800/80 to-gray-900/80 rounded-lg p-2 border border-gray-700/50 shadow-inner">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <div class="bg-green-600/20 rounded-full p-1.5 mr-2">
                <i class="fas fa-dragon text-green-400 text-xs"></i>
              </div>
              <h4 class="text-white text-sm font-medium">Monster Encounters</h4>
            </div>

            <!-- Trainer selector for monster rewards -->
            <div class="flex items-center">
              <label for="monster-trainer-select" class="text-xs text-gray-400 mr-2">Assign to:</label>
              <select id="monster-trainer-select" class="bg-gray-800 text-white text-xs border border-gray-700 rounded px-2 py-1">
                <% if (trainers && trainers.length > 0) { %>
                  <% trainers.forEach(function(trainer) { %>
                    <option value="<%= trainer.id %>"><%= trainer.name %></option>
                  <% }); %>
                <% } else { %>
                  <option value="">No trainers available</option>
                <% } %>
              </select>
            </div>
          </div>
          <div id="monster-encounters-list" class="grid grid-cols-1 gap-2 max-h-[160px] overflow-y-auto custom-scrollbar pr-1">
            <!-- Monster encounters will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Fixed footer with claim button -->
      <div class="p-2 border-t border-gray-800 bg-gray-900/80">
        <button id="claim-rewards-btn" class="bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 w-full text-center py-2 px-4 rounded-lg text-sm font-medium text-gray-900 shadow-lg shadow-amber-500/20 transition-all duration-200 transform hover:scale-[1.02] flex items-center justify-center" onclick="processAllRewards();">
          <i class="fas fa-award mr-2"></i> Claim All Rewards
        </button>
      </div>
    </div>
  </div>

  <!-- Work Assessment Modal - Initially hidden -->
  <div id="work-assessment-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[1000] hidden" style="display: none;">
    <div class="bg-gray-800/95 rounded-xl shadow-2xl max-w-md w-full p-6 border border-purple-500/30 backdrop-blur-sm mx-auto transform transition-all duration-300 scale-100 animate-fadeIn">
      <div class="text-center mb-2">
        <i class="fas fa-check-circle text-green-400 text-3xl"></i>
      </div>
      <h3 class="text-xl font-bold text-amber-400 mb-4">Session Complete!</h3>
      <p class="text-gray-300 mb-6">How much of the time did you actually work during this session?</p>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <button class="work-assessment-btn bg-gray-800/70 hover:bg-red-900/40 text-white py-3 px-4 rounded-lg transition-all transform hover:scale-105 border border-gray-700/30 hover:border-red-500/50 shadow-md hover:shadow-red-500/10" data-value="none" onclick="console.log('None button clicked'); document.getElementById('work-assessment-modal').style.display = 'none'; showRewards(0);">
          <div class="flex flex-col items-center">
            <i class="fas fa-times-circle text-red-500 text-2xl mb-3"></i>
            <span class="block font-medium">None</span>
            <span class="text-xs text-gray-400 mt-1">0% productive</span>
          </div>
        </button>
        <button class="work-assessment-btn bg-gray-800/70 hover:bg-yellow-900/40 text-white py-3 px-4 rounded-lg transition-all transform hover:scale-105 border border-gray-700/30 hover:border-yellow-500/50 shadow-md hover:shadow-yellow-500/10" data-value="some" onclick="console.log('Some button clicked'); document.getElementById('work-assessment-modal').style.display = 'none'; showRewards(25);">
          <div class="flex flex-col items-center">
            <i class="fas fa-dot-circle text-yellow-500 text-2xl mb-3"></i>
            <span class="block font-medium">Some</span>
            <span class="text-xs text-gray-400 mt-1">~25% productive</span>
          </div>
        </button>
        <button class="work-assessment-btn bg-gray-800/70 hover:bg-blue-900/40 text-white py-3 px-4 rounded-lg transition-all transform hover:scale-105 border border-gray-700/30 hover:border-blue-500/50 shadow-md hover:shadow-blue-500/10" data-value="most" onclick="console.log('Most button clicked'); document.getElementById('work-assessment-modal').style.display = 'none'; showRewards(75);">
          <div class="flex flex-col items-center">
            <i class="fas fa-check-circle text-blue-500 text-2xl mb-3"></i>
            <span class="block font-medium">Most</span>
            <span class="text-xs text-gray-400 mt-1">~75% productive</span>
          </div>
        </button>
        <button class="work-assessment-btn bg-gray-800/70 hover:bg-green-900/40 text-white py-3 px-4 rounded-lg transition-all transform hover:scale-105 border border-gray-700/30 hover:border-green-500/50 shadow-md hover:shadow-green-500/10" data-value="all" onclick="console.log('All button clicked'); document.getElementById('work-assessment-modal').style.display = 'none'; showRewards(100);">
          <div class="flex flex-col items-center">
            <i class="fas fa-star text-green-500 text-2xl mb-3"></i>
            <span class="block font-medium">All</span>
            <span class="text-xs text-gray-400 mt-1">100% productive</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/game_corner.css">

<style>
  /* Additional styles for video player */
  .grid {
    min-height: 600px !important;
  }

  /* Animation for modals */
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  .animate-fadeIn {
    animation: fadeIn 0.3s cubic-bezier(0.19, 1, 0.22, 1) forwards;
  }

  /* Enhanced modal styles */
  #rewards-container .bg-gradient-to-r,
  #monster-encounter-container,
  #work-assessment-modal .work-assessment-btn {
    background-color: rgba(17, 24, 39, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  #rewards-container .p-3 {
    padding: 0.75rem;
  }

  #rewards-list, #monster-encounters-list {
    margin-top: 0.5rem;
  }
</style>

<script>
  // Make timer functions globally accessible
  function startTimer() {
    console.log('Start timer button clicked');
    if (typeof window.startTimer === 'function') {
      window.startTimer();
    } else if (typeof startTimerGlobal === 'function') {
      startTimerGlobal();
    } else {
      console.error('startTimer function not found');
    }
  }

  function pauseTimer() {
    console.log('Pause timer button clicked');
    if (typeof window.pauseTimer === 'function') {
      window.pauseTimer();
    } else if (typeof pauseTimerGlobal === 'function') {
      pauseTimerGlobal();
    } else {
      console.error('pauseTimer function not found');
    }
  }

  function resetTimer() {
    console.log('Reset timer button clicked');
    if (typeof window.resetTimer === 'function') {
      window.resetTimer();
    } else if (typeof resetTimerGlobal === 'function') {
      resetTimerGlobal();
    } else {
      console.error('resetTimer function not found');
    }
  }
</script>

<script>
  // Pass server-side data to client-side JavaScript
  const serverTrainers = <%- JSON.stringify(trainers || []) %>;
  window.trainers = serverTrainers.length > 0 ? serverTrainers : [
    { id: 1, name: 'Ash', image: 'https://via.placeholder.com/50?text=Ash', level: 10 },
    { id: 2, name: 'Misty', image: 'https://via.placeholder.com/50?text=Misty', level: 12 },
    { id: 3, name: 'Brock', image: 'https://via.placeholder.com/50?text=Brock', level: 15 }
  ];

  const serverMonsters = <%- JSON.stringify(monsters || []) %>;
  window.monsters = serverMonsters.length > 0 ? serverMonsters : [
    { id: 1, name: 'Pikachu', image: 'https://via.placeholder.com/50?text=Pikachu', level: 25, type: 'Electric' },
    { id: 2, name: 'Charmander', image: 'https://via.placeholder.com/50?text=Charmander', level: 15, type: 'Fire' },
    { id: 3, name: 'Squirtle', image: 'https://via.placeholder.com/50?text=Squirtle', level: 18, type: 'Water' },
    { id: 4, name: 'Bulbasaur', image: 'https://via.placeholder.com/50?text=Bulbasaur', level: 17, type: 'Grass' }
  ];

  console.log('Trainers:', window.trainers);
  console.log('Monsters:', window.monsters);
</script>

<script src="/js/game_corner.js"></script>

<script>
  // Initialize global timer variables
  window.timerInterval = null;
  window.totalSeconds = 25 * 60; // 25 minutes in seconds
  window.currentSeconds = window.totalSeconds;
  window.isRunning = false;
  window.isPaused = false;
  window.currentSession = 0;
  window.totalSessions = 4;
  window.isBreak = false;
  window.focusDuration = 25;
  window.breakDuration = 5;

  // Initialize timer display on page load
  window.onload = function() {
    console.log('Window loaded, initializing timer display');
    try {
      // Sync input values with global variables
      document.getElementById('focus-duration').value = window.focusDuration;
      document.getElementById('break-duration').value = window.breakDuration;
      document.getElementById('num-sessions').value = window.totalSessions;

      updateTimerDisplayGlobal();
      updateSessionInfoGlobal();
      updateProgressCircleGlobal();
    } catch (error) {
      console.error('Error initializing timer display:', error);
    }
  };
</script>

<script>
  // Global functions for inline event handlers

  // Timer status element
  const timerStatus = document.getElementById('timer-status') || document.createElement('div');

  // Global timer control functions
  function startTimerGlobal() {
    console.log('startTimerGlobal called');
    try {
      const startButton = document.getElementById('start-timer');
      const pauseButton = document.getElementById('pause-timer');
      const resetButton = document.getElementById('reset-timer');
      const timerStatus = document.getElementById('timer-status');

      if (window.isPaused) {
        // Resume from pause
        window.isPaused = false;
        window.isRunning = true;
        if (timerStatus) timerStatus.textContent = window.isBreak ? 'Taking a break...' : 'Focus time!';
      } else if (!window.isRunning) {
        // Start new timer
        window.isRunning = true;
        if (window.currentSession === 0) window.currentSession = 1;
        updateSessionInfoGlobal();
        if (timerStatus) timerStatus.textContent = window.isBreak ? 'Taking a break...' : 'Focus time!';
      }

      if (startButton) startButton.disabled = true;
      if (pauseButton) pauseButton.disabled = false;
      if (resetButton) resetButton.disabled = false;

      window.timerInterval = setInterval(updateTimerGlobal, 1000);
    } catch (error) {
      console.error('Error in startTimerGlobal:', error);
    }
  }

  function pauseTimerGlobal() {
    console.log('pauseTimerGlobal called');
    try {
      clearInterval(window.timerInterval);
      window.isPaused = true;
      window.isRunning = false;

      const timerStatus = document.getElementById('timer-status');
      const startButton = document.getElementById('start-timer');
      const pauseButton = document.getElementById('pause-timer');

      if (timerStatus) timerStatus.textContent = 'Paused';
      if (startButton) startButton.disabled = false;
      if (pauseButton) pauseButton.disabled = true;
    } catch (error) {
      console.error('Error in pauseTimerGlobal:', error);
    }
  }

  function resetTimerGlobal() {
    console.log('resetTimerGlobal called');
    try {
      clearInterval(window.timerInterval);
      window.isRunning = false;
      window.isPaused = false;

      // Reset to focus time
      window.isBreak = false;
      window.currentSeconds = window.focusDuration * 60;
      window.totalSeconds = window.currentSeconds;
      window.currentSession = 0; // Reset session counter

      updateTimerDisplayGlobal();
      updateProgressCircleGlobal();
      updateSessionInfoGlobal();

      const timerStatus = document.getElementById('timer-status');
      const startButton = document.getElementById('start-timer');
      const pauseButton = document.getElementById('pause-timer');
      const resetButton = document.getElementById('reset-timer');

      if (timerStatus) timerStatus.textContent = 'Ready to start';
      if (startButton) startButton.disabled = false;
      if (pauseButton) pauseButton.disabled = true;
      if (resetButton) resetButton.disabled = true;
    } catch (error) {
      console.error('Error in resetTimerGlobal:', error);
    }
  }

  function updateTimerGlobal() {
    try {
      window.currentSeconds--;

      if (window.currentSeconds <= 0) {
        clearInterval(window.timerInterval);
        window.isRunning = false;

        if (!window.isBreak) {
          // Focus session completed
          if (window.currentSession < window.totalSessions) {
            // Start break
            window.isBreak = true;
            window.currentSeconds = window.breakDuration * 60;
            window.totalSeconds = window.currentSeconds;
            updateTimerDisplayGlobal();
            updateProgressCircleGlobal();

            const timerStatus = document.getElementById('timer-status');
            if (timerStatus) timerStatus.textContent = 'Break time!';

            // Auto-start break
            startTimerGlobal();
          } else {
            // All sessions completed
            const timerStatus = document.getElementById('timer-status');
            const startButton = document.getElementById('start-timer');
            const pauseButton = document.getElementById('pause-timer');
            const resetButton = document.getElementById('reset-timer');

            if (timerStatus) timerStatus.textContent = 'All sessions completed!';
            if (startButton) startButton.disabled = true;
            if (pauseButton) pauseButton.disabled = true;
            if (resetButton) resetButton.disabled = false;

            // Show work assessment only at the end of the last session
            showWorkAssessmentGlobal();
          }
        } else {
          // Break completed, start next focus session
          window.isBreak = false;
          window.currentSeconds = window.focusDuration * 60;
          window.totalSeconds = window.currentSeconds;
          window.currentSession++; // Increment session counter
          updateTimerDisplayGlobal();
          updateProgressCircleGlobal();
          updateSessionInfoGlobal();

          const timerStatus = document.getElementById('timer-status');
          const startButton = document.getElementById('start-timer');
          const pauseButton = document.getElementById('pause-timer');

          if (timerStatus) timerStatus.textContent = 'Ready for next session';
          if (startButton) startButton.disabled = false;
          if (pauseButton) pauseButton.disabled = true;

          // Auto-start next focus session
          startTimerGlobal();
        }
      } else {
        updateTimerDisplayGlobal();
        updateProgressCircleGlobal();
      }
    } catch (error) {
      console.error('Error in updateTimerGlobal:', error);
    }
  }

  function updateTimerDisplayGlobal() {
    try {
      const timerDisplay = document.getElementById('timer-display');
      if (timerDisplay) {
        const minutes = Math.floor(window.currentSeconds / 60);
        const seconds = window.currentSeconds % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    } catch (error) {
      console.error('Error in updateTimerDisplayGlobal:', error);
    }
  }

  function updateSessionInfoGlobal() {
    try {
      const sessionInfo = document.getElementById('session-info');
      if (sessionInfo) {
        sessionInfo.textContent = `Session ${window.currentSession}/${window.totalSessions}`;
      }
    } catch (error) {
      console.error('Error in updateSessionInfoGlobal:', error);
    }
  }

  function updateProgressCircleGlobal() {
    try {
      const progressCircle = document.getElementById('progress-circle');
      if (progressCircle) {
        const circumference = 2 * Math.PI * 40; // 2πr where r=40
        const dashOffset = circumference * (1 - (window.currentSeconds / window.totalSeconds));
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = dashOffset;
      }
    } catch (error) {
      console.error('Error in updateProgressCircleGlobal:', error);
    }
  }

  function showWorkAssessmentGlobal() {
    try {
      // Only show work assessment at the end of the last session
      if (window.currentSession >= window.totalSessions) {
        const workAssessmentModal = document.getElementById('work-assessment-modal');
        if (workAssessmentModal) {
          // Update the title to show it's the final assessment
          const modalTitle = workAssessmentModal.querySelector('h3');
          if (modalTitle) {
            modalTitle.textContent = 'All Sessions Complete!';
          }

          // Show the modal
          workAssessmentModal.style.display = 'flex';
          console.log('Work assessment modal displayed for final session');
        }
      } else {
        console.log('Not showing work assessment - not the final session');
      }
    } catch (error) {
      console.error('Error in showWorkAssessmentGlobal:', error);
    }
  }

  // Timer control functions
  function decreaseFocusDuration() {
    const focusDurationInput = document.getElementById('focus-duration');
    if (focusDurationInput) {
      let value = parseInt(focusDurationInput.value);
      if (value > 1) {
        focusDurationInput.value = value - 1;
        updateFocusDurationGlobal();
      }
    }
  }

  function increaseFocusDuration() {
    const focusDurationInput = document.getElementById('focus-duration');
    if (focusDurationInput) {
      let value = parseInt(focusDurationInput.value);
      if (value < 60) {
        focusDurationInput.value = value + 1;
        updateFocusDurationGlobal();
      }
    }
  }

  function updateFocusDurationGlobal() {
    const focusDurationInput = document.getElementById('focus-duration');
    if (focusDurationInput) {
      window.focusDuration = parseInt(focusDurationInput.value);
      console.log('Focus duration updated to:', window.focusDuration);

      // Update timer if not running and not in break mode
      if (!window.isRunning && !window.isBreak) {
        window.currentSeconds = window.focusDuration * 60;
        window.totalSeconds = window.currentSeconds;
        updateTimerDisplayGlobal();
        updateProgressCircleGlobal();
      }
    }
  }

  function decreaseBreakDuration() {
    const breakDurationInput = document.getElementById('break-duration');
    if (breakDurationInput) {
      let value = parseInt(breakDurationInput.value);
      if (value > 1) {
        breakDurationInput.value = value - 1;
        updateBreakDurationGlobal();
      }
    }
  }

  function increaseBreakDuration() {
    const breakDurationInput = document.getElementById('break-duration');
    if (breakDurationInput) {
      let value = parseInt(breakDurationInput.value);
      if (value < 30) {
        breakDurationInput.value = value + 1;
        updateBreakDurationGlobal();
      }
    }
  }

  function updateBreakDurationGlobal() {
    const breakDurationInput = document.getElementById('break-duration');
    if (breakDurationInput) {
      window.breakDuration = parseInt(breakDurationInput.value);
      console.log('Break duration updated to:', window.breakDuration);

      // Update timer if in break mode and not running
      if (window.isBreak && !window.isRunning) {
        window.currentSeconds = window.breakDuration * 60;
        window.totalSeconds = window.currentSeconds;
        updateTimerDisplayGlobal();
        updateProgressCircleGlobal();
      }
    }
  }

  function decreaseSessionsCount() {
    const numSessionsInput = document.getElementById('num-sessions');
    if (numSessionsInput) {
      let value = parseInt(numSessionsInput.value);
      if (value > 1) {
        numSessionsInput.value = value - 1;
        updateSessionsCountGlobal();
      }
    }
  }

  function increaseSessionsCount() {
    const numSessionsInput = document.getElementById('num-sessions');
    if (numSessionsInput) {
      let value = parseInt(numSessionsInput.value);
      if (value < 10) {
        numSessionsInput.value = value + 1;
        updateSessionsCountGlobal();
      }
    }
  }

  function updateSessionsCountGlobal() {
    const numSessionsInput = document.getElementById('num-sessions');
    if (numSessionsInput) {
      window.totalSessions = parseInt(numSessionsInput.value);
      console.log('Total sessions updated to:', window.totalSessions);
      updateSessionInfoGlobal();
    }
  }

  // Video control functions
  function changeVideo(url) {
    console.log('Changing video to:', url);
    const youtubePlayer = document.getElementById('youtube-player');
    if (youtubePlayer && url) {
      youtubePlayer.src = url;
      console.log('Video source updated');
    }
  }

  function loadCustomVideo() {
    const customYoutubeUrl = document.getElementById('custom-youtube-url');
    const youtubePlayer = document.getElementById('youtube-player');

    if (customYoutubeUrl && youtubePlayer) {
      let url = customYoutubeUrl.value.trim();

      // Convert regular YouTube URL to embed URL if needed
      if (url.includes('youtube.com/watch?v=')) {
        const videoId = url.split('v=')[1].split('&')[0];
        url = `https://www.youtube.com/embed/${videoId}`;
      } else if (url.includes('youtu.be/')) {
        const videoId = url.split('youtu.be/')[1].split('?')[0];
        url = `https://www.youtube.com/embed/${videoId}`;
      }

      if (url) {
        youtubePlayer.src = url;
        console.log('Custom video loaded:', url);
        customYoutubeUrl.value = '';
      }
    }
  }

  function toggleMute() {
    const youtubePlayer = document.getElementById('youtube-player');
    const volumeIcon = document.getElementById('volume-icon');

    if (youtubePlayer && volumeIcon) {
      // Since we can't directly access iframe's muted property, we'll toggle a class
      const isMuted = volumeIcon.classList.contains('fa-volume-mute');

      if (isMuted) {
        // Unmute
        youtubePlayer.contentWindow.postMessage('{"event":"command","func":"unMute","args":""}', '*');
        volumeIcon.classList.remove('fa-volume-mute');
        volumeIcon.classList.add('fa-volume-up');
      } else {
        // Mute
        youtubePlayer.contentWindow.postMessage('{"event":"command","func":"mute","args":""}', '*');
        volumeIcon.classList.remove('fa-volume-up');
        volumeIcon.classList.add('fa-volume-mute');
      }
    }
  }

  // Function to show rewards
  async function showRewards(productivityScore = 100) {
    console.log('Showing rewards with productivity score:', productivityScore);

    // Show the rewards modal
    const rewardsModal = document.getElementById('rewards-container');
    if (rewardsModal) {
      rewardsModal.style.display = 'flex';
    } else {
      console.error('Rewards container not found');
      return;
    }

    // Show loading indicator
    const loadingIndicator = document.getElementById('rewards-loading');
    if (loadingIndicator) {
      loadingIndicator.style.display = 'flex';
    }

    // Update stats
    const completedSessionsDisplay = document.getElementById('completed-sessions');
    if (completedSessionsDisplay) {
      completedSessionsDisplay.textContent = window.currentSession || '1';
    }

    const focusMinutesDisplay = document.getElementById('focus-minutes');
    if (focusMinutesDisplay) {
      const focusDuration = window.focusDuration || 25;
      const currentSession = window.currentSession || 1;
      focusMinutesDisplay.textContent = focusDuration * currentSession;
    }

    // Get the rewards list element
    const rewardsList = document.getElementById('rewards-list');
    if (!rewardsList) {
      console.error('Rewards list element not found');
      return;
    }

    // Clear previous rewards
    rewardsList.innerHTML = '';

    // Generate some sample rewards based on productivity score
    setTimeout(() => {
      // Hide loading indicator
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }

      // Add sample rewards
      const rewardHTML = `
        <div class="bg-gradient-to-r from-gray-900/50 to-gray-800/50 rounded-lg p-2 border border-gray-700/50 mb-2">
          <div class="flex items-center">
            <div class="w-10 h-10 rounded mr-3 bg-amber-500/20 flex items-center justify-center">
              <i class="fas fa-gift text-amber-400"></i>
            </div>
            <div>
              <h5 class="font-medium text-white text-sm">Poké Coins</h5>
              <p class="text-xs text-gray-400">Quantity: ${Math.floor(productivityScore / 10) * 10}</p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-gray-900/50 to-gray-800/50 rounded-lg p-2 border border-gray-700/50">
          <div class="flex items-center">
            <div class="w-10 h-10 rounded mr-3 bg-amber-500/20 flex items-center justify-center">
              <i class="fas fa-star text-amber-400"></i>
            </div>
            <div>
              <h5 class="font-medium text-white text-sm">Experience Points</h5>
              <p class="text-xs text-gray-400">Quantity: ${productivityScore * 5}</p>
            </div>
          </div>
        </div>
      `;

      rewardsList.innerHTML = rewardHTML;
    }, 1000); // Simulate loading delay
  }

  // Function to process all rewards
  async function processAllRewards() {
    try {
      console.log('Processing all rewards...');

      // Show loading state
      const claimButton = document.getElementById('claim-rewards-btn');
      const originalButtonText = claimButton.innerHTML;
      claimButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
      claimButton.disabled = true;

      // Get the selected trainer for monster rewards
      const selectedTrainerId = document.getElementById('monster-trainer-select')?.value;

      // Prepare the rewards data
      const rewardsData = {
        rewards: window.currentRewards || {},
        selectedTrainerId
      };

      console.log('Sending rewards data:', rewardsData);

      // Send the rewards to the server
      const response = await fetch('/api/game-corner/process-all-rewards', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(rewardsData)
      });

      const result = await response.json();
      console.log('Rewards processing result:', result);

      // Hide the rewards container
      const rewardsContainer = document.getElementById('rewards-container');
      if (rewardsContainer) {
        rewardsContainer.style.display = 'none';
      }

      // Show success notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-[1001] animate-fadeIn';

      if (result.success) {
        // Create a summary of processed rewards
        let rewardsSummary = '';

        if (result.processed.levels.trainers.length > 0) {
          rewardsSummary += `${result.processed.levels.trainers.length} trainer level-ups, `;
        }

        if (result.processed.levels.monsters.length > 0) {
          rewardsSummary += `${result.processed.levels.monsters.length} monster level-ups, `;
        }

        if (result.processed.items.length > 0) {
          rewardsSummary += `${result.processed.items.length} items, `;
        }

        if (result.processed.coins.length > 0) {
          rewardsSummary += `${result.processed.coins.length} coin rewards, `;
        }

        if (result.processed.monsters.length > 0) {
          rewardsSummary += `${result.processed.monsters.length} new monsters, `;
        }

        // Remove trailing comma and space
        if (rewardsSummary) {
          rewardsSummary = rewardsSummary.slice(0, -2);
        } else {
          rewardsSummary = 'No rewards processed';
        }

        notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Rewards claimed successfully! (${rewardsSummary})`;
      } else {
        notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${result.message || 'Error processing rewards'}`;
        notification.className = notification.className.replace('bg-green-600', 'bg-red-600');
      }

      document.body.appendChild(notification);

      // Remove notification after 5 seconds
      setTimeout(() => {
        notification.remove();
      }, 5000);

      // Start break timer
      startBreakTimer();
    } catch (error) {
      console.error('Error processing rewards:', error);

      // Show error notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-[1001] animate-fadeIn';
      notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>Error: ${error.message}`;
      document.body.appendChild(notification);

      // Remove notification after 5 seconds
      setTimeout(() => {
        notification.remove();
      }, 5000);
    } finally {
      // Reset button state
      const claimButton = document.getElementById('claim-rewards-btn');
      if (claimButton) {
        claimButton.innerHTML = '<i class="fas fa-award mr-2"></i> Claim All Rewards';
        claimButton.disabled = false;
      }
    }
  }

  // Global timer variables
  window.timerInterval = null;
  window.totalSeconds = 25 * 60; // 25 minutes in seconds
  window.currentSeconds = window.totalSeconds;
  window.isRunning = false;
  window.isPaused = false;
  window.currentSession = 0;
  window.totalSessions = 4;
  window.isBreak = false;
  window.focusDuration = 25;
  window.breakDuration = 5;

  // Global timer control functions
  function startTimerGlobal() {
    console.log('startTimerGlobal called');
    try {
      const startButton = document.getElementById('start-timer');
      const pauseButton = document.getElementById('pause-timer');
      const resetButton = document.getElementById('reset-timer');
      const timerStatus = document.getElementById('timer-status');

      if (window.isPaused) {
        // Resume from pause
        window.isPaused = false;
        window.isRunning = true;
        timerStatus.textContent = window.isBreak ? 'Taking a break...' : 'Focus time!';
      } else if (!window.isRunning) {
        // Start new timer
        window.isRunning = true;
        window.currentSession++;
        updateSessionInfoGlobal();
        timerStatus.textContent = window.isBreak ? 'Taking a break...' : 'Focus time!';
      }

      if (startButton) startButton.disabled = true;
      if (pauseButton) pauseButton.disabled = false;
      if (resetButton) resetButton.disabled = false;

      window.timerInterval = setInterval(updateTimerGlobal, 1000);
    } catch (error) {
      console.error('Error in startTimerGlobal:', error);
    }
  }

  function pauseTimerGlobal() {
    console.log('pauseTimerGlobal called');
    try {
      clearInterval(window.timerInterval);
      window.isPaused = true;
      window.isRunning = false;

      const timerStatus = document.getElementById('timer-status');
      const startButton = document.getElementById('start-timer');
      const pauseButton = document.getElementById('pause-timer');

      if (timerStatus) timerStatus.textContent = 'Paused';
      if (startButton) startButton.disabled = false;
      if (pauseButton) pauseButton.disabled = true;
    } catch (error) {
      console.error('Error in pauseTimerGlobal:', error);
    }
  }

  function resetTimerGlobal() {
    console.log('resetTimerGlobal called');
    try {
      clearInterval(window.timerInterval);
      window.isRunning = false;
      window.isPaused = false;

      // Reset to focus time
      window.isBreak = false;
      window.currentSeconds = window.focusDuration * 60;
      window.totalSeconds = window.currentSeconds;

      updateTimerDisplayGlobal();

      const timerStatus = document.getElementById('timer-status');
      const startButton = document.getElementById('start-timer');
      const pauseButton = document.getElementById('pause-timer');
      const resetButton = document.getElementById('reset-timer');

      if (timerStatus) timerStatus.textContent = 'Ready to start';
      if (startButton) startButton.disabled = false;
      if (pauseButton) pauseButton.disabled = true;
      if (resetButton) resetButton.disabled = true;
    } catch (error) {
      console.error('Error in resetTimerGlobal:', error);
    }
  }

  function updateTimerGlobal() {
    try {
      window.currentSeconds--;

      if (window.currentSeconds <= 0) {
        clearInterval(window.timerInterval);
        window.isRunning = false;

        if (!window.isBreak) {
          // Focus session completed
          if (window.currentSession < window.totalSessions) {
            // Show work assessment modal
            const workAssessmentModal = document.getElementById('work-assessment-modal');
            if (workAssessmentModal) {
              workAssessmentModal.style.display = 'flex';
              console.log('Work assessment modal displayed');
            }
          } else {
            // All sessions completed
            showWorkAssessmentGlobal();
          }
        } else {
          // Break completed, start next focus session
          window.isBreak = false;
          window.currentSeconds = window.focusDuration * 60;
          window.totalSeconds = window.currentSeconds;
          updateTimerDisplayGlobal();

          const timerStatus = document.getElementById('timer-status');
          const startButton = document.getElementById('start-timer');
          const pauseButton = document.getElementById('pause-timer');

          if (timerStatus) timerStatus.textContent = 'Ready for next session';
          if (startButton) startButton.disabled = false;
          if (pauseButton) pauseButton.disabled = true;
        }
      }

      updateTimerDisplayGlobal();
      updateProgressCircleGlobal();
    } catch (error) {
      console.error('Error in updateTimerGlobal:', error);
    }
  }

  function updateTimerDisplayGlobal() {
    try {
      const timerDisplay = document.getElementById('timer-display');
      if (timerDisplay) {
        const minutes = Math.floor(window.currentSeconds / 60);
        const seconds = window.currentSeconds % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    } catch (error) {
      console.error('Error in updateTimerDisplayGlobal:', error);
    }
  }

  function updateSessionInfoGlobal() {
    try {
      const sessionInfo = document.getElementById('session-info');
      if (sessionInfo) {
        sessionInfo.textContent = `Session ${window.currentSession}/${window.totalSessions}`;
      }
    } catch (error) {
      console.error('Error in updateSessionInfoGlobal:', error);
    }
  }

  function updateProgressCircleGlobal() {
    try {
      const progressCircle = document.getElementById('progress-circle');
      if (progressCircle) {
        const circumference = 2 * Math.PI * 40; // 2πr where r=40
        const dashOffset = circumference * (1 - (window.currentSeconds / window.totalSeconds));
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = dashOffset;
      }
    } catch (error) {
      console.error('Error in updateProgressCircleGlobal:', error);
    }
  }

  function showWorkAssessmentGlobal() {
    try {
      const workAssessmentModal = document.getElementById('work-assessment-modal');
      if (workAssessmentModal) {
        workAssessmentModal.style.display = 'flex';
        console.log('Work assessment modal displayed for final session');
      }
    } catch (error) {
      console.error('Error in showWorkAssessmentGlobal:', error);
    }
  }

  // Initialize timer display
  document.addEventListener('DOMContentLoaded', function() {
    updateTimerDisplayGlobal();
    updateSessionInfoGlobal();
    updateProgressCircleGlobal();
  });

  function startBreakTimer() {
    console.log('Starting break timer from global function');
    try {
      // Set break mode
      window.isBreak = true;

      // Set break duration (default 5 minutes)
      const breakDuration = 5;
      window.currentSeconds = breakDuration * 60;
      window.totalSeconds = window.currentSeconds;

      // Update display
      const timerDisplay = document.getElementById('timer-display');
      if (timerDisplay) {
        const minutes = Math.floor(window.currentSeconds / 60);
        const seconds = window.currentSeconds % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }

      // Update status
      const timerStatus = document.getElementById('timer-status');
      if (timerStatus) {
        timerStatus.textContent = 'Break time!';
      }

      // Enable start button
      const startButton = document.getElementById('start-timer');
      if (startButton) {
        startButton.disabled = false;
      }

      // Disable pause button
      const pauseButton = document.getElementById('pause-timer');
      if (pauseButton) {
        pauseButton.disabled = true;
      }
    } catch (error) {
      console.error('Error in global startBreakTimer:', error);
    }
  }

  // Global displayRewards function
  function displayRewards(rewards) {
    console.log('Global displayRewards called with:', rewards);

    // Store the rewards for later processing
    window.currentRewards = rewards;
    try {
      // Get the rewards list element
      const rewardsList = document.getElementById('rewards-list');
      if (!rewardsList) {
        console.error('Rewards list element not found');
        return;
      }

      // Hide loading indicator
      const loadingIndicator = document.getElementById('rewards-loading');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }

      // Clear previous rewards
      rewardsList.innerHTML = '';

      // Display level rewards
      if (rewards.levels && rewards.levels.length > 0) {
        const levelRewardsSection = document.createElement('div');
        levelRewardsSection.className = 'mb-4';
        levelRewardsSection.innerHTML = `
          <h4 class="text-amber-400 text-sm font-medium mb-2"><i class="fas fa-arrow-up mr-2"></i>Level Ups</h4>
          <div class="grid grid-cols-1 gap-2">
            ${rewards.levels.map(level => `
              <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg p-2 border border-purple-500/20 hover:border-purple-500/40 transition-all duration-200 hover:shadow-md hover:shadow-purple-500/10">
                <div class="flex items-center">
                  <img src="${level.image}" alt="${level.name}" class="w-10 h-10 rounded-lg mr-3 border border-purple-500/20 shadow-sm">
                  <div>
                    <h5 class="font-medium text-white text-sm">${level.name}</h5>
                    <p class="text-xs text-green-400">+${level.levelIncrease} level${level.levelIncrease > 1 ? 's' : ''}</p>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        rewardsList.appendChild(levelRewardsSection);
      }

      // Display item rewards
      if (rewards.items && rewards.items.length > 0) {
        const itemRewardsSection = document.createElement('div');
        itemRewardsSection.className = 'mb-4';
        itemRewardsSection.innerHTML = `
          <h4 class="text-amber-400 text-sm font-medium mb-2"><i class="fas fa-box mr-2"></i>Items</h4>
          <div class="grid grid-cols-1 gap-2">
            ${rewards.items.map(itemReward => `
              <div class="bg-gradient-to-r from-amber-900/30 to-yellow-900/30 rounded-lg p-2 border border-amber-500/20 hover:border-amber-500/40 transition-all duration-200 hover:shadow-md hover:shadow-amber-500/10">
                <div class="flex items-center">
                  <img src="${itemReward.item.image}" alt="${itemReward.item.name}" class="w-10 h-10 rounded-lg mr-3 border border-amber-500/20 shadow-sm">
                  <div>
                    <h5 class="font-medium text-white text-sm">${itemReward.item.name}</h5>
                    <p class="text-xs text-gray-400">${itemReward.item.description}</p>
                    <p class="text-xs text-blue-400 mt-1">Given to ${itemReward.trainerName}</p>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        rewardsList.appendChild(itemRewardsSection);
      }

      // Display coin rewards
      if (rewards.coins && rewards.coins.length > 0) {
        const coinRewardsSection = document.createElement('div');
        coinRewardsSection.className = 'mb-4';
        coinRewardsSection.innerHTML = `
          <h4 class="text-amber-400 text-sm font-medium mb-2"><i class="fas fa-coins mr-2"></i>Coins</h4>
          <div class="grid grid-cols-1 gap-2">
            ${rewards.coins.map(coin => `
              <div class="bg-gradient-to-r from-amber-900/30 to-orange-900/30 rounded-lg p-2 border border-amber-500/20 hover:border-amber-500/40 transition-all duration-200 hover:shadow-md hover:shadow-amber-500/10">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-lg mr-3 bg-amber-500/20 flex items-center justify-center border border-amber-500/30 shadow-sm">
                    <i class="fas fa-coins text-amber-400 text-lg"></i>
                  </div>
                  <div>
                    <h5 class="font-medium text-white text-sm">${coin.amount} coins</h5>
                    <p class="text-xs text-blue-400">Given to ${coin.trainerName}</p>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        rewardsList.appendChild(coinRewardsSection);
      }

      // Display monster encounter rewards
      if (rewards.monsters && rewards.monsters.length > 0) {
        const monsterEncounterContainer = document.getElementById('monster-encounter-container');
        if (monsterEncounterContainer) {
          monsterEncounterContainer.classList.remove('hidden');
        }

        const monsterEncountersList = document.getElementById('monster-encounters-list');
        if (monsterEncountersList) {
          monsterEncountersList.innerHTML = '';

          rewards.monsters.forEach(monster => {
            const monsterElement = document.createElement('div');
            monsterElement.className = 'bg-gradient-to-r from-green-900/30 to-blue-900/30 rounded-lg p-3 border border-green-500/20';
            monsterElement.innerHTML = `
              <div class="flex items-center">
                <img src="${monster.image}" alt="${monster.name}" class="rounded-lg mr-3 w-10 h-10 border border-green-500/20 shadow-md shadow-green-500/10">
                <div>
                  <h5 class="font-bold text-white text-sm">${monster.name}${monster.isEvolved ? ' <span class="text-xs text-green-400">(Evolved!)</span>' : ''}</h5>
                  <p class="text-xs text-gray-400">Type: ${monster.type}</p>
                  <div class="mt-2">
                    <button class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white text-xs py-1 px-3 rounded shadow-sm shadow-green-500/20 transition-all duration-200">
                      <i class="fas fa-plus mr-1"></i> Catch
                    </button>
                  </div>
                </div>
              </div>
            `;
            monsterEncountersList.appendChild(monsterElement);
          });
        }

        // Also add to the main rewards list
        const monsterRewardsSection = document.createElement('div');
        monsterRewardsSection.className = 'mb-4';
        monsterRewardsSection.innerHTML = `
          <h4 class="text-amber-400 text-sm font-medium mb-2"><i class="fas fa-dragon mr-2"></i>Monster Encounters</h4>
          <div class="grid grid-cols-1 gap-2">
            ${rewards.monsters.map(monster => `
              <div class="bg-gradient-to-r from-green-900/30 to-blue-900/30 rounded-lg p-2 border border-green-500/20 hover:border-green-500/40 transition-all duration-200 hover:shadow-md hover:shadow-green-500/10">
                <div class="flex items-center">
                  <img src="${monster.image}" alt="${monster.name}" class="w-10 h-10 rounded-lg mr-3 border border-green-500/20 shadow-sm">
                  <div>
                    <h5 class="font-medium text-white text-sm">${monster.name}${monster.isEvolved ? ' <span class="text-xs text-green-400">(Evolved!)</span>' : ''}</h5>
                    <p class="text-xs text-gray-400">Type: ${monster.type}</p>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        rewardsList.appendChild(monsterRewardsSection);
      } else {
        // Hide monster encounter container if no monsters
        const monsterEncounterContainer = document.getElementById('monster-encounter-container');
        if (monsterEncounterContainer) {
          monsterEncounterContainer.classList.add('hidden');
        }
      }

      // If no rewards at all, show a message
      if ((!rewards.levels || rewards.levels.length === 0) &&
          (!rewards.items || rewards.items.length === 0) &&
          (!rewards.coins || rewards.coins.length === 0) &&
          (!rewards.monsters || rewards.monsters.length === 0)) {
        rewardsList.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-exclamation-circle text-gray-500 text-3xl mb-2"></i>
            <p class="text-gray-400">No rewards earned this time. Try a longer session or higher productivity!</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error in displayRewards:', error);
      // Show error message
      const rewardsList = document.getElementById('rewards-list');
      if (rewardsList) {
        rewardsList.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-2"></i>
            <p class="text-gray-400">Error displaying rewards: ${error.message}</p>
          </div>
        `;
      }
    }
  }

  // Global function to show rewards
  async function showRewards(productivityScore) {
    console.log('Showing rewards from global function with productivity score:', productivityScore);
    try {
      // Show loading indicator
      const loadingIndicator = document.getElementById('rewards-loading');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
      }

      // Update stats
      const completedSessionsDisplay = document.getElementById('completed-sessions');
      if (completedSessionsDisplay) {
        completedSessionsDisplay.textContent = window.currentSession || '1';
      }

      const focusMinutesDisplay = document.getElementById('focus-minutes');
      if (focusMinutesDisplay) {
        focusMinutesDisplay.textContent = window.focusDuration * (window.currentSession || 1);
      }

      const productivityScoreDisplay = document.getElementById('productivity-score');
      if (productivityScoreDisplay) {
        productivityScoreDisplay.textContent = `${productivityScore}%`;
      }

      // Create rewards object
      console.log('Creating rewards object using actual trainer and monster data');
      const rewards = {
        levels: [],
        items: [],
        coins: [],
        monsters: []
      };

      // Calculate reward multiplier based on session length and productivity
      const sessionLength = window.focusDuration || 25;
      const lengthMultiplier = Math.min(2, sessionLength / 25); // Cap at 2x for sessions longer than 50 minutes
      const productivityMultiplier = productivityScore / 100;
      const rewardMultiplier = lengthMultiplier * productivityMultiplier;

      console.log(`Reward multiplier: ${rewardMultiplier} (length: ${lengthMultiplier}, productivity: ${productivityMultiplier})`);

      // Check if we have trainers and monsters
      if (window.trainers && window.trainers.length > 0) {
        console.log(`Found ${window.trainers.length} trainers`);

        // Determine which reward types to include based on multiplier and randomness
        const includeLevel = Math.random() < 0.7 * rewardMultiplier; // 70% chance * multiplier
        const includeItems = Math.random() < 0.8 * rewardMultiplier; // 80% chance * multiplier
        const includeCoins = Math.random() < 0.9 * rewardMultiplier; // 90% chance * multiplier
        const includeMonster = Math.random() < 0.4 * rewardMultiplier; // 40% chance * multiplier

        // Generate level rewards
        if (includeLevel) {
          // Determine how many trainers/monsters get levels
          const numRecipients = Math.max(1, Math.floor(Math.random() * 3 * rewardMultiplier));

          // For each recipient, generate a level reward
          for (let i = 0; i < numRecipients; i++) {
            // Randomly choose between trainer and monster (if monsters exist)
            const isTrainer = Math.random() < 0.5 || !window.monsters || window.monsters.length === 0;

            if (isTrainer) {
              // Select a random trainer
              const trainerIndex = Math.floor(Math.random() * window.trainers.length);
              const trainer = window.trainers[trainerIndex];

              // Determine level increase (1-3 based on multiplier)
              const levelIncrease = Math.max(1, Math.floor(Math.random() * 3 * rewardMultiplier));

              rewards.levels.push({
                type: 'trainer',
                name: trainer.name || `Trainer #${trainerIndex + 1}`,
                id: trainer.id,
                levelIncrease,
                image: trainer.profile_img || 'https://via.placeholder.com/50'
              });
            } else if (window.monsters && window.monsters.length > 0) {
              // Select a random monster
              const monsterIndex = Math.floor(Math.random() * window.monsters.length);
              const monster = window.monsters[monsterIndex];

              // Determine level increase (1-3 based on multiplier)
              const levelIncrease = Math.max(1, Math.floor(Math.random() * 3 * rewardMultiplier));

              rewards.levels.push({
                type: 'monster',
                name: monster.name || monster.species1 || `Monster #${monsterIndex + 1}`,
                id: monster.mon_id,
                levelIncrease,
                image: monster.img_link || 'https://via.placeholder.com/50'
              });
            }
          }
        }

        // Generate item rewards
        if (includeItems) {
          // List of possible items with rarity tiers
          const itemPool = [
            // Common items (tier 1)
            { name: 'Potion', tier: 1, description: 'Restores 20 HP', image: 'https://via.placeholder.com/50?text=Potion' },
            { name: 'Antidote', tier: 1, description: 'Cures poison', image: 'https://via.placeholder.com/50?text=Antidote' },
            { name: 'Awakening', tier: 1, description: 'Wakes up sleeping monsters', image: 'https://via.placeholder.com/50?text=Awakening' },
            { name: 'Burn Heal', tier: 1, description: 'Heals burns', image: 'https://via.placeholder.com/50?text=Burn+Heal' },

            // Uncommon items (tier 2)
            { name: 'Super Potion', tier: 2, description: 'Restores 50 HP', image: 'https://via.placeholder.com/50?text=Super+Potion' },
            { name: 'Great Ball', tier: 2, description: 'Better catch rate than a Poké Ball', image: 'https://via.placeholder.com/50?text=Great+Ball' },
            { name: 'Revive', tier: 2, description: 'Revives a fainted monster with half HP', image: 'https://via.placeholder.com/50?text=Revive' },

            // Rare items (tier 3)
            { name: 'Hyper Potion', tier: 3, description: 'Restores 200 HP', image: 'https://via.placeholder.com/50?text=Hyper+Potion' },
            { name: 'Ultra Ball', tier: 3, description: 'Higher catch rate than a Great Ball', image: 'https://via.placeholder.com/50?text=Ultra+Ball' },
            { name: 'Full Heal', tier: 3, description: 'Cures all status conditions', image: 'https://via.placeholder.com/50?text=Full+Heal' },

            // Very rare items (tier 4)
            { name: 'Max Potion', tier: 4, description: 'Fully restores HP', image: 'https://via.placeholder.com/50?text=Max+Potion' },
            { name: 'Full Restore', tier: 4, description: 'Fully restores HP and cures all status conditions', image: 'https://via.placeholder.com/50?text=Full+Restore' },
            { name: 'Max Revive', tier: 4, description: 'Revives a fainted monster with full HP', image: 'https://via.placeholder.com/50?text=Max+Revive' },

            // Legendary items (tier 5)
            { name: 'Master Ball', tier: 5, description: 'Catches any monster without fail', image: 'https://via.placeholder.com/50?text=Master+Ball' },
            { name: 'Rare Candy', tier: 5, description: 'Raises a monster\'s level by 1', image: 'https://via.placeholder.com/50?text=Rare+Candy' },
            { name: 'Sacred Ash', tier: 5, description: 'Revives all fainted monsters with full HP', image: 'https://via.placeholder.com/50?text=Sacred+Ash' }
          ];

          // Determine number of items to award (1-3 based on multiplier)
          const numItems = Math.max(1, Math.floor(Math.random() * 3 * rewardMultiplier));

          // For each item, select from the pool based on rarity and multiplier
          for (let i = 0; i < numItems; i++) {
            // Higher multiplier increases chance of better items
            const maxTier = Math.min(5, Math.ceil(rewardMultiplier * 2.5));
            let selectedTier;

            // Weighted random selection for tier
            const tierRoll = Math.random();
            if (tierRoll < 0.5) selectedTier = 1; // 50% chance for tier 1
            else if (tierRoll < 0.75) selectedTier = 2; // 25% chance for tier 2
            else if (tierRoll < 0.9) selectedTier = 3; // 15% chance for tier 3
            else if (tierRoll < 0.98) selectedTier = 4; // 8% chance for tier 4
            else selectedTier = 5; // 2% chance for tier 5

            // Cap the tier by the multiplier-determined max tier
            selectedTier = Math.min(selectedTier, maxTier);

            // Filter items by the selected tier
            const tierItems = itemPool.filter(item => item.tier === selectedTier);

            if (tierItems.length > 0) {
              // Select a random item from the tier
              const selectedItem = tierItems[Math.floor(Math.random() * tierItems.length)];

              // Select a random trainer to receive the item
              const trainerIndex = Math.floor(Math.random() * window.trainers.length);
              const trainer = window.trainers[trainerIndex];

              rewards.items.push({
                item: selectedItem,
                trainerName: trainer.name || `Trainer #${trainerIndex + 1}`,
                trainerId: trainer.id,
                trainerImage: trainer.profile_img || 'https://via.placeholder.com/50'
              });
            }
          }
        }

        // Generate coin rewards
        if (includeCoins) {
          // Determine number of trainers to receive coins (1-3 based on multiplier)
          const numRecipients = Math.max(1, Math.floor(Math.random() * 3 * rewardMultiplier));

          // For each recipient, generate a coin reward
          for (let i = 0; i < numRecipients; i++) {
            // Select a random trainer
            const trainerIndex = Math.floor(Math.random() * window.trainers.length);
            const trainer = window.trainers[trainerIndex];

            // Base amount is 50-200 coins
            const baseAmount = 50 + Math.floor(Math.random() * 150);

            // Apply multiplier for final amount
            const coinAmount = Math.floor(baseAmount * rewardMultiplier);

            rewards.coins.push({
              amount: coinAmount,
              trainerName: trainer.name || `Trainer #${trainerIndex + 1}`,
              trainerId: trainer.id,
              trainerImage: trainer.profile_img || 'https://via.placeholder.com/50'
            });
          }
        }

        // Generate monster encounter rewards
        if (includeMonster) {
          // List of possible monsters with rarity tiers
          const monsterPool = [
            // Common monsters (tier 1)
            { name: 'Pidgey', tier: 1, type: 'Normal/Flying', image: 'https://via.placeholder.com/50?text=Pidgey', evolution: 'Pidgeotto' },
            { name: 'Rattata', tier: 1, type: 'Normal', image: 'https://via.placeholder.com/50?text=Rattata', evolution: 'Raticate' },
            { name: 'Caterpie', tier: 1, type: 'Bug', image: 'https://via.placeholder.com/50?text=Caterpie', evolution: 'Metapod' },

            // Uncommon monsters (tier 2)
            { name: 'Pikachu', tier: 2, type: 'Electric', image: 'https://via.placeholder.com/50?text=Pikachu', evolution: 'Raichu' },
            { name: 'Vulpix', tier: 2, type: 'Fire', image: 'https://via.placeholder.com/50?text=Vulpix', evolution: 'Ninetales' },
            { name: 'Poliwhirl', tier: 2, type: 'Water', image: 'https://via.placeholder.com/50?text=Poliwhirl', evolution: 'Poliwrath' },

            // Rare monsters (tier 3)
            { name: 'Growlithe', tier: 3, type: 'Fire', image: 'https://via.placeholder.com/50?text=Growlithe', evolution: 'Arcanine' },
            { name: 'Abra', tier: 3, type: 'Psychic', image: 'https://via.placeholder.com/50?text=Abra', evolution: 'Kadabra' },
            { name: 'Machop', tier: 3, type: 'Fighting', image: 'https://via.placeholder.com/50?text=Machop', evolution: 'Machoke' },

            // Very rare monsters (tier 4)
            { name: 'Dratini', tier: 4, type: 'Dragon', image: 'https://via.placeholder.com/50?text=Dratini', evolution: 'Dragonair' },
            { name: 'Larvitar', tier: 4, type: 'Rock/Ground', image: 'https://via.placeholder.com/50?text=Larvitar', evolution: 'Pupitar' },
            { name: 'Bagon', tier: 4, type: 'Dragon', image: 'https://via.placeholder.com/50?text=Bagon', evolution: 'Shelgon' },

            // Legendary monsters (tier 5)
            { name: 'Articuno', tier: 5, type: 'Ice/Flying', image: 'https://via.placeholder.com/50?text=Articuno', evolution: null },
            { name: 'Zapdos', tier: 5, type: 'Electric/Flying', image: 'https://via.placeholder.com/50?text=Zapdos', evolution: null },
            { name: 'Moltres', tier: 5, type: 'Fire/Flying', image: 'https://via.placeholder.com/50?text=Moltres', evolution: null }
          ];

          // Determine number of monster encounters (usually 1, but can be more with high multiplier)
          const numEncounters = Math.floor(Math.random() * rewardMultiplier) < 0.8 ? 1 : 2;

          // For each encounter, select from the pool based on rarity and multiplier
          for (let i = 0; i < numEncounters; i++) {
            // Higher multiplier increases chance of better monsters
            const maxTier = Math.min(5, Math.ceil(rewardMultiplier * 2));
            let selectedTier;

            // Weighted random selection for tier
            const tierRoll = Math.random();
            if (tierRoll < 0.5) selectedTier = 1; // 50% chance for tier 1
            else if (tierRoll < 0.8) selectedTier = 2; // 30% chance for tier 2
            else if (tierRoll < 0.95) selectedTier = 3; // 15% chance for tier 3
            else if (tierRoll < 0.99) selectedTier = 4; // 4% chance for tier 4
            else selectedTier = 5; // 1% chance for tier 5

            // Cap the tier by the multiplier-determined max tier
            selectedTier = Math.min(selectedTier, maxTier);

            // Filter monsters by the selected tier
            const tierMonsters = monsterPool.filter(monster => monster.tier === selectedTier);

            if (tierMonsters.length > 0) {
              // Select a random monster from the tier
              const selectedMonster = tierMonsters[Math.floor(Math.random() * tierMonsters.length)];

              // Determine if the monster is evolved based on multiplier
              const isEvolved = selectedMonster.evolution && Math.random() < (rewardMultiplier * 0.2);

              const monster = {
                name: isEvolved ? selectedMonster.evolution : selectedMonster.name,
                type: selectedMonster.type,
                tier: selectedMonster.tier,
                image: selectedMonster.image,
                isEvolved: isEvolved
              };

              rewards.monsters.push(monster);
            }
          }
        }
      } else {
        console.log('No trainers found, using fallback rewards');

        // Add a fallback reward if no trainers are available
        if (productivityScore >= 50) {
          rewards.monsters.push({
            name: 'Mystery Monster',
            type: 'Unknown',
            tier: Math.ceil(productivityScore / 20),
            image: 'https://via.placeholder.com/50?text=???',
            isEvolved: false
          });
        }
      }

      console.log('Generated rewards:', rewards);

      // Display rewards using our global function
      displayRewards(rewards);

      // Show rewards container
      const rewardsContainer = document.getElementById('rewards-container');
      if (rewardsContainer) {
        rewardsContainer.style.display = 'flex';
      } else {
        console.error('Rewards container not found');
      }
    } catch (error) {
      console.error('Error in global showRewards:', error);

      // Hide loading indicator
      const loadingIndicator = document.getElementById('rewards-loading');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }

      // Fallback: show an error message
      const rewardsList = document.getElementById('rewards-list');
      if (rewardsList) {
        rewardsList.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-2"></i>
            <p class="text-gray-400">Error generating rewards: ${error.message}</p>
          </div>
        `;
      }

      // Still show the rewards container
      const rewardsContainer = document.getElementById('rewards-container');
      if (rewardsContainer) {
        rewardsContainer.style.display = 'flex';
      }
    }
  }
</script>
