<!-- Art Submission Calculator Modal -->
<div id="art-calculator-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="close-calculator">&times;</span>

        <div id="art-calculator-container" class="calculator-container">
            <h1 class="calculator-title">Art Submission Calculator</h1>

            <!-- Background Section -->
            <div class="calculator-section">
                <h2 class="calculator-section-title">Background</h2>
                <div class="form-group">
                    <label>Background Complexity:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="background" value="none" checked> None</label>
                        <label><input type="radio" name="background" value="prop"> Prop</label>
                        <label><input type="radio" name="background" value="simple"> Simple</label>
                        <label><input type="radio" name="background" value="complex"> Complex</label>
                    </div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="bg-split"> Background is split by groups</label>
                </div>
            </div>

            <!-- Gift Art Section -->
            <div class="calculator-section">
                <h2 class="calculator-section-title">Gift Art</h2>
                <div class="form-group">
                    <label><input type="checkbox" id="gift-enabled"> Enable gift art options</label>
                </div>
            </div>

            <!-- Rank Settings Section -->
            <div class="calculator-section">
                <h2 class="calculator-section-title">Rank Settings</h2>
                <div class="form-group">
                    <label><input type="checkbox" id="same-rank" checked> All characters have the same rank</label>
                </div>

                <div id="universal-default-container">
                    <div class="form-group">
                        <label><input type="checkbox" id="universal-default" checked> Use one default rank for all groups</label>
                    </div>

                    <div id="universal-default-rank-container">
                        <h3>Universal Default Rank</h3>
                        <div class="form-group">
                            <label>Size:</label>
                            <select id="universal-size" class="form-control">
                                <option value="fullbody">Fullbody</option>
                                <option value="halfbody">Halfbody</option>
                                <option value="bust">Bust</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Linework:</label>
                            <select id="universal-linework" class="form-control">
                                <option value="clean">Clean</option>
                                <option value="sketch">Sketch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Color:</label>
                            <select id="universal-color" class="form-control">
                                <option value="no_color">No Color</option>
                                <option value="flat">Flat Color</option>
                                <option value="simple">Simple Shading</option>
                                <option value="complex">Complex Shading</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Groups Section -->
            <div class="calculator-section">
                <h2 class="calculator-section-title">Groups</h2>
                <div class="form-group">
                    <label for="group-name">Group Name:</label>
                    <input type="text" id="group-name" class="form-control" placeholder="e.g., 'Tayler and her pokemon'">
                </div>
                <button type="button" id="add-group-btn" class="btn btn-primary">Add Group</button>

                <div id="groups-container" class="groups-container">
                    <!-- Groups will be added here dynamically -->
                </div>
            </div>

            <!-- Totals Section -->
            <div class="totals-section">
                <h2 class="calculator-section-title">Totals</h2>
                <div class="totals-grid">
                    <div class="total-item">
                        <h3>Background Bonus</h3>
                        <div class="total-value" id="background-bonus-display">0</div>
                    </div>
                    <div class="total-item">
                        <h3>Bonus Levels</h3>
                        <div class="total-value" id="bonus-levels-display">0</div>
                    </div>
                    <div class="total-item">
                        <h3>Gift Levels</h3>
                        <div class="total-value" id="gift-levels-display">0</div>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="actions-section">
                <div class="main-actions">
                    <button type="button" id="calculate-btn" class="btn btn-primary">Calculate Results</button>
                    <button type="button" id="reset-btn" class="btn btn-secondary">Reset Calculator</button>
                </div>
                <div class="data-actions">
                    <button type="button" id="reload-data-btn" class="btn btn-primary">Reload Data</button>
                    <button type="button" id="use-mock-data-btn" class="btn btn-secondary">Use Mock Data</button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="results-section" style="display: none;">
                <h2 class="calculator-section-title">Results</h2>
                <div id="results-container">
                    <!-- Results will be displayed here -->
                </div>
            </div>

            <!-- Level Assignment Section -->
            <div id="level-assignment-section" class="calculator-section" style="display: none;">
                <h2 class="calculator-section-title">Assign Levels</h2>
                <p class="mb-4">Assign your background, bonus, and gift levels to trainers and monsters.</p>

                <div class="form-group">
                    <label for="level-type-select">Level Type:</label>
                    <select id="level-type-select" class="form-control">
                        <option value="background">Background Levels</option>
                        <option value="bonus">Bonus Levels</option>
                        <option value="gift">Gift Levels</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="target-name">Target Name:</label>
                    <div class="input-group">
                        <input type="text" id="target-name" class="form-control" placeholder="Enter trainer or monster name">
                        <button type="button" id="test-search-btn" class="btn btn-secondary">Test Search</button>
                    </div>
                    <p class="form-note">Enter the name of the trainer or monster to assign levels to. The system will try to find matches even with partial names.</p>
                    <div class="info-box">
                        <p><strong>Tips for finding trainers and monsters:</strong></p>
                        <ul>
                            <li>You can enter a partial name and the system will try to find matches</li>
                            <li>If multiple matches are found for monsters, you'll be asked to select the correct one</li>
                            <li>Names are not case-sensitive</li>
                            <li>You can assign levels to any character that appears in your artwork, even if you don't own them</li>
                            <li>Use the "Auto-Assign Levels to Game Characters" button to automatically match and assign levels to characters from your artwork</li>
                            <li>The auto-assign feature will assign both base levels and any bonus/gift levels to each character</li>
                        </ul>
                    </div>
                </div>

                <div class="form-group">
                    <label for="level-amount">Level Amount: <span id="remaining-levels">0</span> levels remaining</label>
                    <input type="number" id="level-amount" class="form-control" min="1" max="100" placeholder="Enter level amount">
                </div>

                <div class="form-actions mb-4">
                    <button type="button" id="assign-background-btn" class="btn btn-primary">Assign Background Levels</button>
                    <button type="button" id="assign-bonus-btn" class="btn btn-primary">Assign Bonus Levels</button>
                    <button type="button" id="assign-gift-btn" class="btn btn-primary">Assign Gift Levels</button>
                </div>

                <div class="form-actions mb-4">
                    <button type="button" id="assign-all-background-btn" class="btn btn-secondary">Assign All Background Levels</button>
                    <button type="button" id="assign-all-bonus-btn" class="btn btn-secondary">Assign All Bonus Levels</button>
                    <button type="button" id="assign-all-gift-btn" class="btn btn-secondary">Assign All Gift Levels</button>
                    <button type="button" id="assign-all-levels-btn" class="btn btn-primary">Assign All Remaining Levels</button>
                </div>

                <div class="assignments-container">
                    <h3 class="mb-3">Level Assignments</h3>
                    <div id="assignments-list">
                        <p>No assignments yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Modal functionality
    function initializeModal() {
        console.log('Initializing art calculator modal...');

        const modal = document.getElementById('art-calculator-modal');
        const openBtn = document.getElementById('open-art-calculator');
        const closeBtn = document.getElementById('close-calculator');

        if (!modal) {
            console.warn('Could not find art-calculator-modal element');
            return;
        }

        console.log('Setting up modal event handlers...');

        // Open modal handler
        function openModalHandler() {
            console.log('Open calculator button clicked');
            modal.style.display = 'block';

            // Initialize the calculator if it exists
            if (window.artCalculator) {
                console.log('Reinitializing calculator...');
                window.artCalculator.setupEventListeners();
                window.artCalculator.updateBackgroundBonus();
            } else {
                console.warn('Calculator not found in window object');
            }
        }

        // Close modal handler
        function closeModalHandler() {
            console.log('Close calculator button clicked');
            modal.style.display = 'none';
        }

        // Window click handler
        function windowClickHandler(event) {
            if (event.target === modal) {
                console.log('Clicked outside modal, closing...');
                modal.style.display = 'none';
            }
        }

        // Set up open button
        if (openBtn) {
            console.log('Found open-art-calculator button');
            openBtn.onclick = openModalHandler;
        } else {
            console.warn('Could not find open-art-calculator button');
        }

        // Set up close button
        if (closeBtn) {
            console.log('Found close-calculator button');
            closeBtn.onclick = closeModalHandler;
        } else {
            console.warn('Could not find close-calculator button');
        }

        // Set up window click handler
        window.onclick = windowClickHandler;

        console.log('Modal initialization complete');
    }

    // Initialize immediately if possible
    console.log('Starting modal initialization...');
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log('Document already loaded, initializing modal immediately');
        initializeModal();
    } else {
        console.log('Document still loading, waiting for DOMContentLoaded event');
        document.addEventListener('DOMContentLoaded', initializeModal);
    }

    // Also initialize on window load as a fallback
    window.addEventListener('load', function() {
        console.log('Window load event fired, ensuring modal is initialized');
        initializeModal();
    });
</script>

<!-- Duplicate Monster Selection Modal -->
<div id="duplicate-monster-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" id="close-duplicate-modal">&times;</span>

        <h2 class="mb-4">Multiple Monsters Found</h2>
        <p class="mb-4">There are multiple monsters with the same name. Please select which one you want to assign levels to:</p>

        <div id="duplicate-monsters-list" class="mb-4">
            <!-- Duplicate monsters will be listed here -->
        </div>

        <div class="form-actions">
            <button type="button" id="cancel-duplicate-selection" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Apply Levels Confirmation Modal -->
<div id="apply-levels-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" id="close-apply-modal">&times;</span>

        <h2 class="mb-4">Apply Levels</h2>
        <p class="mb-4">Are you sure you want to apply these levels? This action cannot be undone.</p>

        <div id="apply-levels-summary" class="mb-4">
            <!-- Summary of levels to apply will be shown here -->
        </div>

        <div class="form-actions">
            <button type="button" id="confirm-apply-levels" class="btn btn-primary">Apply Levels</button>
            <button type="button" id="cancel-apply-levels" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>
