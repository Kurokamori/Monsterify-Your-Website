<% /* Set the title and other variables for the layout */ %>
<% title = 'Trainer Directory' %>

<div class="mt-20 mb-12">
    <span></span>
</div>

<div class="container">
    <div class="trainer-directory-wrapper">
        <div class="card">
            <div class="card-header">
                <div class="search-container">
                    <input type="text" id="searchInput" class="input" placeholder="Search trainers...">
                </div>
            </div>
            <div class="card-body">
                <% if (trainers && trainers.length > 0) { %>
                    <div class="overflow-x-auto">
                        <table id="trainersTable" class="narrow-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="player">Player <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="level">Lvl <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="currency">Currency <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="faction">Faction <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="monsters">Mons <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="refs">Refs <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="percent">Ref% <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% trainers.forEach(trainer => { %>
                            <tr class="trainer-row" data-id="<%= trainer.id %>">
                                <td><%= trainer.name %></td>
                                <td><%= trainer.player_display_name || trainer.player_username || (trainer.player_user_id ? trainer.player_user_id : 'NPC') %></td>
                                <td><%= trainer.level || 1 %></td>
                                <td><%= Math.round(trainer.currency_amount) || 0 %></td>
                                <td><%= trainer.faction || 'None' %></td>
                                <td><%= trainer.monster_count || trainer.mon_amount || 0 %></td>
                                <td><%= trainer.monster_ref_count || trainer.mon_referenced_amount || 0 %></td>
                                <td><%= trainer.monster_ref_percent || 0 %>%</td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="text-center py-8">
                <p class="text-xl mb-4">No trainers found</p>
                <p class="text-[#9ca3af]">Be the first to create a trainer!</p>
                <% if (typeof user !== 'undefined' && user) { %>
                    <a href="/add_trainer" class="btn-primary mt-4 inline-block">Create Trainer</a>
                <% } else { %>
                    <a href="/login" class="btn-primary mt-4 inline-block">Login to Create Trainer</a>
                <% } %>
            </div>
        <% } %>
            </div>
        </div>
    </div>
</div>

<style>
    .sortable {
        cursor: pointer;
    }

    .sortable:hover {
        background-color: var(--nav-hover);
    }

    .sortable.asc i:before {
        content: "\f0de"; /* fa-sort-up */
    }

    .sortable.desc i:before {
        content: "\f0dd"; /* fa-sort-down */
    }

    .trainer-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .trainer-row:hover {
        background-color: var(--nav-hover);
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        padding: 0.4rem 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--divider-color);
        font-size: 0.9rem;
    }

    .compact-table th, .compact-table td {
        white-space: nowrap;
    }

    .trainer-directory-wrapper {
        max-width: 1200px;
        margin: 0 auto;
    }

    .search-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
    }

    .narrow-table {
        width: 100%;
        margin: 0 auto;
    }

    th {
        background-color: var(--card-background);
        font-weight: bold;
        color: var(--accent-color);
    }

    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--accent-color);
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .pagination-button {
        padding: 0.5rem 1rem;
        background-color: var(--nav-background);
        color: var(--text-color);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .pagination-button:hover {
        background-color: var(--nav-hover);
    }

    .pagination-button.active {
        background-color: var(--accent-color);
        color: white;
    }

    .pagination-button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('trainersTable');
        const searchInput = document.getElementById('searchInput');

        if (table) {
            // Sort functionality
            table.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const sortBy = th.dataset.sort;
                    const isAsc = th.classList.contains('asc');

                    // Reset all headers
                    table.querySelectorAll('th.sortable').forEach(header => {
                        header.classList.remove('asc', 'desc');
                    });

                    // Set new sort direction
                    th.classList.add(isAsc ? 'desc' : 'asc');

                    // Sort the table
                    sortTable(sortBy, !isAsc);
                });
            });

            // Row click to view trainer details
            table.querySelectorAll('tbody tr').forEach(row => {
                row.addEventListener('click', () => {
                    const trainerId = parseInt(row.dataset.id, 10); // Ensure it's a number
                    if (!isNaN(trainerId)) {
                        window.location.href = `/trainers/${trainerId}`;
                    } else {
                        console.error('Invalid trainer ID:', row.dataset.id);
                    }
                });
            });

            // Sort the table
            function sortTable(sortBy, asc) {
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));

                // Define sort functions for different columns
                const sortFunctions = {
                    name: (a, b) => a.cells[0].textContent.localeCompare(b.cells[0].textContent),
                    player: (a, b) => a.cells[1].textContent.localeCompare(b.cells[1].textContent),
                    level: (a, b) => parseInt(a.cells[2].textContent) - parseInt(b.cells[2].textContent),
                    currency: (a, b) => parseInt(a.cells[3].textContent) - parseInt(b.cells[3].textContent),
                    faction: (a, b) => a.cells[4].textContent.localeCompare(b.cells[4].textContent),
                    monsters: (a, b) => parseInt(a.cells[5].textContent) - parseInt(b.cells[5].textContent),
                    refs: (a, b) => parseInt(a.cells[6].textContent) - parseInt(b.cells[6].textContent),
                    percent: (a, b) => parseInt(a.cells[7].textContent) - parseInt(b.cells[7].textContent)
                };

                // Sort the rows
                rows.sort((a, b) => {
                    const result = sortFunctions[sortBy](a, b);
                    return asc ? result : -result;
                });

                // Remove all rows
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }

                // Add sorted rows
                rows.forEach(row => {
                    tbody.appendChild(row);
                });
            }
        }

        // Search functionality
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                if (table) {
                    const searchTerm = searchInput.value.toLowerCase();
                    const rows = table.querySelectorAll('tbody tr');

                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            });
        }
    });
</script>

