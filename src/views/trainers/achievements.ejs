<% /* Set the title and other variables for the layout */ %>
<% title = title || `${trainer.name} - Achievements` %>
<div class="full-width-section">
    <div class="container">
        <span></span>
    </div>
</div>

<div class="full-width-content">
    <div class="trainer-page-layout">
        <!-- Side Navigation -->
        <% const active = 'achievements'; %>
        <%- include('../partials/trainer_sidebar', { trainer, active }) %>

        <!-- Main Content -->
        <div class="trainer-main-content">
            <div class="trainer-header">
                <h1 class="trainer-name"><%= trainer.name %>'s Achievements</h1>
                <div class="trainer-level">
                    Level <%= trainer.level || 1 %>
                </div>
            </div>

            <div class="achievements-container">
                <div class="achievements-header">
                    <h2 class="text-2xl font-display font-bold mb-4">Achievements</h2>
                    <p class="text-gray-300 mb-6">Complete achievements to earn rewards and show off your accomplishments!</p>
                </div>

                <div id="achievements-content" class="achievements-content">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading achievements...</p>
                    </div>
                </div>

                <!-- Achievement Details Modal -->
                <div id="achievement-modal" class="achievement-modal">
                    <div class="achievement-modal-content">
                        <span class="close-modal">&times;</span>
                        <div id="achievement-modal-body">
                            <!-- Modal content will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Achievement Styles */
.achievements-container {
    padding: 1rem;
}

.achievements-header {
    margin-bottom: 2rem;
    text-align: center;
}

.achievements-content {
    margin-top: 1rem;
}

.achievement-category {
    margin-bottom: 2.5rem;
    background: rgba(30, 37, 50, 0.7);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.category-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.category-icon {
    font-size: 1.5rem;
    margin-right: 0.75rem;
    color: var(--accent-color);
}

.category-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--accent-color);
}

.achievement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.achievement-card {
    background: rgba(46, 56, 77, 0.5);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.achievement-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

.achievement-card.completed {
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.5), rgba(46, 56, 77, 0.8));
    border: 1px solid rgba(var(--accent-color-rgb), 0.3);
}

.achievement-card.claimed {
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.5), rgba(30, 37, 50, 0.8));
}

.achievement-card.locked {
    filter: grayscale(100%);
    opacity: 0.7;
}

.achievement-card.secret {
    background: rgba(30, 30, 30, 0.7);
}

.achievement-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.achievement-icon i {
    font-size: 1.5rem;
    color: var(--accent-color);
}

.achievement-info {
    flex: 1;
}

.achievement-info h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.achievement-info p {
    font-size: 0.9rem;
    opacity: 0.8;
}

.achievement-progress {
    margin-top: 0.5rem;
    height: 6px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
}

.progress-bar {
    height: 100%;
    background: var(--accent-color);
    border-radius: 3px;
    transition: width 0.5s ease;
}

.progress-text {
    font-size: 0.8rem;
    margin-top: 0.25rem;
    text-align: right;
}

.achievement-status {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.3);
}

.status-completed {
    background: rgba(39, 174, 96, 0.3);
    color: #2ecc71;
}

.status-claimed {
    background: rgba(41, 128, 185, 0.3);
    color: #3498db;
}

/* Modal Styles */
.achievement-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.7);
}

.achievement-modal-content {
    background: linear-gradient(135deg, rgba(46, 56, 77, 0.95), rgba(30, 37, 50, 0.95));
    margin: 10% auto;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    position: relative;
}

.close-modal {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s ease;
}

.close-modal:hover {
    color: var(--accent-color);
}

.modal-achievement-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
}

.modal-achievement-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.5rem;
}

.modal-achievement-icon i {
    font-size: 2rem;
    color: var(--accent-color);
}

.modal-achievement-title h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.modal-achievement-title p {
    font-size: 1rem;
    opacity: 0.8;
}

.modal-achievement-progress {
    margin: 1.5rem 0;
}

.modal-progress-bar {
    height: 8px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.modal-progress-fill {
    height: 100%;
    background: var(--accent-color);
    border-radius: 4px;
}

.modal-progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
}

.modal-rewards {
    margin-top: 1.5rem;
}

.modal-rewards h4 {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--accent-color);
}

.rewards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
}

.reward-item {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
    transition: all 0.2s ease;
}

.reward-item:hover {
    transform: translateY(-2px);
    background: rgba(0, 0, 0, 0.3);
}

.reward-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.reward-name {
    font-size: 0.9rem;
    font-weight: 600;
}

.reward-value {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}

.claim-button {
    display: block;
    width: 100%;
    padding: 0.75rem;
    margin-top: 1.5rem;
    background-color: var(--accent-color);
    color: #000;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.claim-button:hover {
    background-color: #c49ef7;
    transform: translateY(-2px);
}

.claim-button:disabled {
    background-color: #666;
    cursor: not-allowed;
    transform: none;
}

.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
}

.loading-spinner i {
    font-size: 2rem;
    color: var(--accent-color);
    margin-bottom: 1rem;
}

/* Responsive Styles */
@media (max-width: 768px) {
    .achievement-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }

    .achievement-modal-content {
        margin: 15% auto;
        padding: 1.5rem;
        max-width: 90%;
    }

    .modal-achievement-icon {
        width: 48px;
        height: 48px;
    }

    .modal-achievement-icon i {
        font-size: 1.5rem;
    }

    .rewards-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }
}

@media (max-width: 480px) {
    .achievement-grid {
        grid-template-columns: 1fr;
    }

    .modal-achievement-header {
        flex-direction: column;
        text-align: center;
    }

    .modal-achievement-icon {
        margin-right: 0;
        margin-bottom: 1rem;
    }

    .rewards-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<script>
// Achievement System JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const trainerId = '<%= trainer.id %>';
    const achievementsContent = document.getElementById('achievements-content');
    const modal = document.getElementById('achievement-modal');
    const modalBody = document.getElementById('achievement-modal-body');
    const closeModal = document.querySelector('.close-modal');

    // Close modal when clicking the X
    closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Fetch achievements data
    fetchAchievements();

    function fetchAchievements() {
        fetch(`/api/trainers/${trainerId}/achievements`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderAchievements(data.achievements);
                } else {
                    showError(data.message || 'Failed to load achievements');
                }
            })
            .catch(error => {
                console.error('Error fetching achievements:', error);
                showError('Failed to load achievements. Please try again later.');
            });
    }

    function renderAchievements(achievementsByCategory) {
        // Clear loading spinner
        achievementsContent.innerHTML = '';

        // Check if there are any achievements
        if (Object.keys(achievementsByCategory).length === 0) {
            achievementsContent.innerHTML = `
                <div class="empty-achievements">
                    <i class="fas fa-trophy"></i>
                    <p>No achievements available yet. Check back later!</p>
                </div>
            `;
            return;
        }

        // Create category sections
        for (const category in achievementsByCategory) {
            const categoryData = achievementsByCategory[category];
            const categoryElement = createCategoryElement(category, categoryData);
            achievementsContent.appendChild(categoryElement);
        }

        // Add event listeners to achievement cards
        document.querySelectorAll('.achievement-card').forEach(card => {
            card.addEventListener('click', function() {
                const achievementId = this.getAttribute('data-id');
                const achievementData = JSON.parse(this.getAttribute('data-achievement'));
                showAchievementModal(achievementData);
            });
        });
    }

    function createCategoryElement(categoryKey, categoryData) {
        const categoryElement = document.createElement('div');
        categoryElement.className = 'achievement-category';

        // Get icon for category
        const categoryIcon = getCategoryIcon(categoryKey);

        // Create category header
        categoryElement.innerHTML = `
            <div class="category-header">
                <div class="category-icon">
                    <i class="${categoryIcon}"></i>
                </div>
                <h3 class="category-title">${categoryData.name}</h3>
            </div>
        `;

        // Create achievement grid
        const achievementGrid = document.createElement('div');
        achievementGrid.className = 'achievement-grid';

        // Add achievements to grid
        categoryData.achievements.forEach(achievement => {
            const achievementCard = createAchievementCard(achievement);
            achievementGrid.appendChild(achievementCard);
        });

        categoryElement.appendChild(achievementGrid);
        return categoryElement;
    }

    function createAchievementCard(achievement) {
        const card = document.createElement('div');

        // Determine card class based on achievement status
        let cardClass = 'achievement-card';
        if (achievement.is_claimed) {
            cardClass += ' claimed';
        } else if (achievement.is_complete) {
            cardClass += ' completed';
        } else if (achievement.is_secret && achievement.progress === 0) {
            cardClass += ' secret';
        }

        card.className = cardClass;
        card.setAttribute('data-id', achievement.id);
        card.setAttribute('data-achievement', JSON.stringify(achievement));

        // Calculate progress percentage
        const progressPercent = Math.min(100, Math.round((achievement.progress / achievement.requirement_value) * 100));

        // Determine status badge
        let statusBadge = '';
        if (achievement.is_claimed) {
            statusBadge = '<div class="achievement-status status-claimed">Claimed</div>';
        } else if (achievement.is_complete) {
            statusBadge = '<div class="achievement-status status-completed">Complete</div>';
        }

        // Create card content
        let cardContent = '';

        if (achievement.is_secret && achievement.progress === 0) {
            // Secret achievement that hasn't been started
            cardContent = `
                <div class="achievement-icon">
                    <i class="fas fa-question"></i>
                </div>
                <div class="achievement-info">
                    <h4>Secret Achievement</h4>
                    <p>Keep playing to discover this achievement!</p>
                </div>
                ${statusBadge}
            `;
        } else {
            // Regular achievement or discovered secret
            cardContent = `
                <div class="achievement-icon">
                    <i class="${achievement.icon || 'fas fa-trophy'}"></i>
                </div>
                <div class="achievement-info">
                    <h4>${achievement.name}</h4>
                    <p>${achievement.description}</p>
                    <div class="achievement-progress">
                        <div class="progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="progress-text">${achievement.progress} / ${achievement.requirement_value}</div>
                </div>
                ${statusBadge}
            `;
        }

        card.innerHTML = cardContent;
        return card;
    }

    function showAchievementModal(achievement) {
        // Calculate progress percentage
        const progressPercent = Math.min(100, Math.round((achievement.progress / achievement.requirement_value) * 100));

        // Create rewards HTML
        let rewardsHTML = '';
        if (achievement.rewards && achievement.rewards.length > 0) {
            rewardsHTML = `
                <div class="modal-rewards">
                    <h4>Rewards</h4>
                    <div class="rewards-grid">
                        ${achievement.rewards.map(reward => createRewardHTML(reward)).join('')}
                    </div>
                </div>
            `;
        }

        // Create claim button if applicable
        let claimButtonHTML = '';
        if (achievement.is_complete && !achievement.is_claimed) {
            claimButtonHTML = `
                <button id="claim-reward-btn" class="claim-button" data-id="${achievement.id}">
                    Claim Rewards
                </button>
            `;
        } else if (achievement.is_claimed) {
            claimButtonHTML = `
                <button class="claim-button" disabled>
                    Rewards Claimed
                </button>
            `;
        }

        // Set modal content
        modalBody.innerHTML = `
            <div class="modal-achievement-header">
                <div class="modal-achievement-icon">
                    <i class="${achievement.icon || 'fas fa-trophy'}"></i>
                </div>
                <div class="modal-achievement-title">
                    <h3>${achievement.name}</h3>
                    <p>${achievement.description}</p>
                </div>
            </div>

            <div class="modal-achievement-progress">
                <div class="modal-progress-bar">
                    <div class="modal-progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div class="modal-progress-text">
                    <span>Progress: ${achievement.progress} / ${achievement.requirement_value}</span>
                    <span>${progressPercent}%</span>
                </div>
            </div>

            ${rewardsHTML}
            ${claimButtonHTML}
        `;

        // Add event listener to claim button
        const claimButton = document.getElementById('claim-reward-btn');
        if (claimButton) {
            claimButton.addEventListener('click', function() {
                claimReward(achievement.id);
            });
        }

        // Show modal
        modal.style.display = 'block';
    }

    function createRewardHTML(reward) {
        let icon, name, value;

        switch (reward.type) {
            case 'item':
                icon = 'fas fa-box';
                name = 'Item';
                value = typeof reward.value === 'string' && reward.value.includes(';')
                    ? reward.value.split(';')[0] + ' x' + (reward.value.split(';')[2] || '1')
                    : reward.value;
                break;

            case 'level':
                icon = 'fas fa-level-up-alt';
                name = 'Levels';
                value = `+${reward.value}`;
                break;

            case 'coin':
                icon = 'fas fa-coins';
                name = 'Coins';
                value = reward.value;
                break;

            case 'monster_static':
            case 'monster_set':
            case 'monster_random':
                icon = 'fas fa-dragon';
                name = 'Monster';
                if (reward.type === 'monster_static' && reward.value.name) {
                    value = reward.value.name;
                } else if (reward.type === 'monster_set' && reward.value.name) {
                    value = reward.value.name;
                } else {
                    value = 'Mystery Monster';
                }
                break;

            default:
                icon = 'fas fa-gift';
                name = 'Reward';
                value = 'Mystery';
        }

        return `
            <div class="reward-item">
                <div class="reward-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="reward-name">${name}</div>
                <div class="reward-value">${value}</div>
            </div>
        `;
    }

    function claimReward(achievementId) {
        // Disable claim button
        const claimButton = document.getElementById('claim-reward-btn');
        if (claimButton) {
            claimButton.disabled = true;
            claimButton.textContent = 'Claiming...';
        }

        // Send claim request
        fetch(`/api/trainers/${trainerId}/achievements/${achievementId}/claim`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showClaimSuccess(data);

                // Refresh achievements
                fetchAchievements();
            } else {
                // Show error message
                showClaimError(data.message || 'Failed to claim rewards');
            }
        })
        .catch(error => {
            console.error('Error claiming rewards:', error);
            showClaimError('Failed to claim rewards. Please try again later.');
        });
    }

    function showClaimSuccess(data) {
        // Create rewards summary
        let rewardsSummary = '';
        if (data.rewards && data.rewards.length > 0) {
            rewardsSummary = '<ul class="rewards-summary">';
            data.rewards.forEach(reward => {
                let rewardText = '';

                if (reward.type === 'item' && reward.item) {
                    rewardText = `${reward.item.amount} ${reward.item.name}`;
                } else if (reward.type === 'level') {
                    rewardText = `${reward.levels} levels (New level: ${reward.new_level})`;
                } else if (reward.type === 'coin') {
                    rewardText = `${reward.coins} coins (New balance: ${reward.new_balance})`;
                } else if (reward.type.includes('monster') && reward.monster) {
                    rewardText = `Monster: ${reward.monster.name} (Level ${reward.monster.level})`;
                }

                rewardsSummary += `<li>${rewardText}</li>`;
            });
            rewardsSummary += '</ul>';
        }

        // Update modal content
        modalBody.innerHTML = `
            <div class="claim-success">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Rewards Claimed!</h3>
                <p>You have successfully claimed your rewards.</p>
                ${rewardsSummary}
                <button class="claim-button" onclick="document.getElementById('achievement-modal').style.display='none';">
                    Close
                </button>
            </div>
        `;
    }

    function showClaimError(message) {
        // Update claim button
        const claimButton = document.getElementById('claim-reward-btn');
        if (claimButton) {
            claimButton.disabled = false;
            claimButton.textContent = 'Claim Rewards';
        }

        // Show error message
        alert(`Error: ${message}`);
    }

    function showError(message) {
        achievementsContent.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>${message}</p>
                <button class="retry-button" onclick="location.reload()">
                    Retry
                </button>
            </div>
        `;
    }

    function getCategoryIcon(category) {
        const icons = {
            'level': 'fas fa-level-up-alt',
            'type_collector': 'fas fa-fire',
            'monster_collector': 'fas fa-dragon',
            'attribute_collector': 'fas fa-gem',
            'currency_earned': 'fas fa-coins',
            'currency_spent': 'fas fa-shopping-cart',
            'custom': 'fas fa-star'
        };

        return icons[category] || 'fas fa-trophy';
    }
});
</script>
